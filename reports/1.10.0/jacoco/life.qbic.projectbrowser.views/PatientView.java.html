<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ProjectBrowser Portlet</a> &gt; <a href="index.source.html" class="el_package">life.qbic.projectbrowser.views</a> &gt; <span class="el_source">PatientView.java</span></div><h1>PatientView.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * QBiC Project qNavigator enables users to manage their projects. Copyright (C) &quot;2016‚Äù Christopher
 * Mohr, David Wojnar, Andreas Friedrich
 * 
 * This program is free software: you can redistribute it and/or modify it under the terms of the
 * GNU General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License along with this program. If
 * not, see &lt;http://www.gnu.org/licenses/&gt;.
 *******************************************************************************/
package life.qbic.projectbrowser.views;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.TreeMap;

import life.qbic.portal.utils.PortalUtils;
import org.tepi.filtertable.FilterTable;

import com.liferay.portal.kernel.exception.PortalException;
import com.liferay.portal.kernel.exception.SystemException;
import com.liferay.portal.kernel.util.PropsKeys;
import com.liferay.portal.kernel.util.PropsUtil;
import com.liferay.portal.model.Company;
import com.liferay.portal.model.User;
import com.liferay.portal.service.CompanyLocalServiceUtil;
import com.liferay.portal.service.UserLocalServiceUtil;
import com.vaadin.data.Item;
import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.data.util.GeneratedPropertyContainer;
import com.vaadin.data.util.PropertyValueGenerator;
import com.vaadin.navigator.View;
import com.vaadin.navigator.ViewChangeListener.ViewChangeEvent;
import com.vaadin.server.FontAwesome;
import com.vaadin.server.Page;
import com.vaadin.server.Resource;
import com.vaadin.server.WebBrowser;
import com.vaadin.shared.ui.MarginInfo;
import com.vaadin.shared.ui.grid.HeightMode;
import com.vaadin.shared.ui.label.ContentMode;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Component;
import com.vaadin.ui.CustomTable.RowHeaderMode;
import com.vaadin.ui.Grid;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Image;
import com.vaadin.ui.Label;
import com.vaadin.ui.Notification;
import com.vaadin.ui.Notification.Type;
import com.vaadin.ui.ProgressBar;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.TabSheet.SelectedTabChangeEvent;
import com.vaadin.ui.TabSheet.SelectedTabChangeListener;
import com.vaadin.ui.UI;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.renderers.ButtonRenderer;
import com.vaadin.ui.renderers.ClickableRenderer.RendererClickEvent;
import com.vaadin.ui.renderers.ClickableRenderer.RendererClickListener;
import com.vaadin.ui.renderers.HtmlRenderer;
import com.vaadin.ui.renderers.ProgressBarRenderer;
import com.vaadin.ui.themes.ValoTheme;

import ch.systemsx.cisd.openbis.dss.client.api.v1.DataSet;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.Experiment;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.Project;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.Sample;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.SearchCriteria;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.SearchCriteria.MatchClause;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.SearchCriteria.MatchClauseAttribute;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.SearchSubCriteria;
import life.qbic.datamodel.experiments.ExperimentType;
import life.qbic.openbis.openbisclient.OpenBisClient;

import life.qbic.portal.utils.ConfigurationManager;

import life.qbic.projectbrowser.controllers.*;
import life.qbic.projectbrowser.components.*;
import life.qbic.projectbrowser.helpers.Utils;
import life.qbic.projectbrowser.helpers.GraphGenerator;
import life.qbic.projectbrowser.model.ExperimentStatusBean;
import life.qbic.projectbrowser.model.ProjectBean;
import life.qbic.projectbrowser.samplegraph.GraphPage;
import life.qbic.xml.properties.Property;
import life.qbic.projectbrowser.helpers.ViewTablesClickListener;
import life.qbic.projectbrowser.helpers.DatasetViewFilterGenerator;
import life.qbic.projectbrowser.helpers.DatasetViewFilterDecorator;

import org.apache.commons.lang3.tuple.Pair;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class PatientView extends VerticalLayout implements View {

  /**
   * 
   */
  private static final long serialVersionUID = 2177082328716962295L;

  public final static String navigateToLabel = &quot;ivacproject&quot;;

  private ProjectBean currentBean;

  FilterTable registeredExperiments;

  VerticalLayout patientViewContent;

  private String resourceUrl;
  private DataHandler datahandler;
  private State state;

  private Label contact;

  private Label descContent;

  private Button export;

  private Label patientInformation;

  private VerticalLayout status;

  private Grid experiments;

  private VerticalLayout buttonLayoutSection;
  private VerticalLayout graphSectionContent;
  private GraphPage newGraphContent;

  private TreeMap&lt;String, String&gt; members;
  private HashMap&lt;String, String&gt; memberLetters;

  private VerticalLayout membersSection;

  private Label hlaTypeLabel;

  private TabSheet patientViewTab;

  private HorizontalLayout membersLayout;

  private StringBuilder memberString;

  private String headerLabel;

  private ExperimentComponent experimentComponent;

  public String getHeaderLabel() {
<span class="nc" id="L157">    return headerLabel;</span>
  }

  public void setHeaderLabel(String headerLabel) {
<span class="nc" id="L161">    this.headerLabel = headerLabel;</span>
<span class="nc" id="L162">  }</span>

  private DatasetComponent datasetComponent;

  private BiologicalSamplesComponent biologicalSamplesComponent;

  private LevelComponent measuredSamplesComponent;

  private LevelComponent resultsComponent;

  private PatientStatusComponent statusComponent;

  private WorkflowViewController wfController;

  private WorkflowComponent workflowComponent;

  private ConfigurationManager manager;

  private AttachmentUploadComponent uploadComponent;

  private ProjInformationComponent projectInformation;

<span class="nc" id="L184">  private static final Logger LOG = LogManager.getLogger(PatientView.class);</span>



  public PatientView(DataHandler datahandler, State state, String resourceurl,
      WorkflowViewController wfController, ConfigurationManager manager) {
<span class="nc" id="L190">    this(datahandler, state, wfController);</span>
<span class="nc" id="L191">    this.resourceUrl = resourceurl;</span>
<span class="nc" id="L192">    this.manager = manager;</span>
<span class="nc" id="L193">  }</span>

<span class="nc" id="L195">  public PatientView(DataHandler datahandler, State state, WorkflowViewController wfController) {</span>
<span class="nc" id="L196">    this.datahandler = datahandler;</span>
<span class="nc" id="L197">    this.wfController = wfController;</span>
<span class="nc" id="L198">    this.state = state;</span>
<span class="nc" id="L199">    resourceUrl = &quot;javascript;&quot;;</span>
<span class="nc" id="L200">    initView();</span>
<span class="nc" id="L201">  }</span>

  /**
   * sets the ContainerDataSource for showing it in a table and the id of the current Openbis
   * Project. The id is shown in the caption.
   * 
   * @param projectBean
   */
  public void setContainerDataSource(ProjectBean projectBean) {
<span class="nc" id="L210">    this.currentBean = projectBean;</span>

<span class="nc" id="L212">    registeredExperiments.setContainerDataSource(projectBean.getExperiments());</span>

<span class="nc" id="L214">    registeredExperiments.setVisibleColumns(</span>
        new Object[] {&quot;code&quot;, &quot;prettyType&quot;, &quot;registrationDate&quot;, &quot;registrator&quot;, &quot;status&quot;});

<span class="nc" id="L217">    registeredExperiments.setColumnHeader(&quot;prettyType&quot;, &quot;Type&quot;);</span>

<span class="nc" id="L219">    int rowNumber = projectBean.getExperiments().size();</span>

<span class="nc bnc" id="L221" title="All 2 branches missed.">    if (rowNumber == 0) {</span>
<span class="nc" id="L222">      registeredExperiments.setVisible(false);</span>
    } else {
<span class="nc" id="L224">      registeredExperiments.setVisible(true);</span>
<span class="nc" id="L225">      registeredExperiments.setPageLength(Math.min(rowNumber, 10));</span>
    }
<span class="nc" id="L227">  }</span>


  /**
   * updates view, if height, width or the browser changes.
   * 
   * @param browserHeight
   * @param browserWidth
   * @param browser
   */
  public void updateView(int browserHeight, int browserWidth, WebBrowser browser) {
<span class="nc" id="L238">    setWidth((browserWidth * 0.85f), Unit.PIXELS);</span>
<span class="nc" id="L239">    setHeight((browserHeight * 2.0f), Unit.PIXELS);</span>
<span class="nc" id="L240">  }</span>

  /**
   * init this view. builds the layout skeleton Menubar Description and others Statisitcs Experiment
   * Table Graph
   */
  void initView() {
<span class="nc" id="L247">    patientViewContent = new VerticalLayout();</span>
<span class="nc" id="L248">    patientViewContent.setMargin(new MarginInfo(true, false, false, false));</span>
    // patientViewContent.setMargin(true);

<span class="nc" id="L251">    headerLabel = &quot;&quot;;</span>

<span class="nc" id="L253">    patientViewTab = new TabSheet();</span>
<span class="nc" id="L254">    patientViewTab.setHeight(&quot;100%&quot;);</span>
<span class="nc" id="L255">    patientViewTab.setWidth(&quot;100%&quot;);</span>


<span class="nc" id="L258">    datasetComponent = new DatasetComponent(datahandler, state, resourceUrl);</span>
<span class="nc" id="L259">    biologicalSamplesComponent =</span>
        new BiologicalSamplesComponent(datahandler, state, resourceUrl, &quot;Biological Samples&quot;);
<span class="nc" id="L261">    measuredSamplesComponent = new LevelComponent(datahandler, state, resourceUrl, &quot;Raw Data&quot;);</span>
<span class="nc" id="L262">    resultsComponent = new LevelComponent(datahandler, state, resourceUrl, &quot;Results&quot;);</span>
<span class="nc" id="L263">    statusComponent = new PatientStatusComponent(datahandler, state, resourceUrl);</span>
<span class="nc" id="L264">    workflowComponent = new WorkflowComponent(wfController);</span>
<span class="nc" id="L265">    uploadComponent = new AttachmentUploadComponent();</span>
<span class="nc" id="L266">    projectInformation = new ProjInformationComponent(datahandler, state, resourceUrl);</span>
<span class="nc" id="L267">    experimentComponent = new ExperimentComponent(datahandler, state, resourceUrl);</span>

<span class="nc" id="L269">    patientViewTab.addStyleName(ValoTheme.TABSHEET_EQUAL_WIDTH_TABS);</span>
<span class="nc" id="L270">    patientViewTab.addStyleName(ValoTheme.TABSHEET_FRAMED);</span>
<span class="nc" id="L271">    patientViewTab.addStyleName(ValoTheme.TABSHEET_PADDED_TABBAR);</span>

    // patientViewTab.addTab(initDescription()).setIcon(FontAwesome.INFO_CIRCLE);
<span class="nc" id="L274">    patientViewTab.addTab(projectInformation).setIcon(FontAwesome.INFO_CIRCLE);</span>
<span class="nc" id="L275">    patientViewTab.addTab(statusComponent).setIcon(FontAwesome.CHECK_CIRCLE);</span>
<span class="nc" id="L276">    patientViewTab.addTab(initGraphs()).setIcon(FontAwesome.SITEMAP);</span>
    // patientViewTab.addTab(initMemberSection()).setIcon(FontAwesome.USERS);
    // patientViewTab.addTab(initHLALayout()).setIcon(FontAwesome.BARCODE);
    // patientViewTab.addTab(initTable()).setIcon(FontAwesome.FLASK);

<span class="nc" id="L281">    patientViewTab.addTab(experimentComponent).setIcon(FontAwesome.FLASK);</span>
<span class="nc" id="L282">    patientViewTab.addTab(datasetComponent).setIcon(FontAwesome.DATABASE);</span>
<span class="nc" id="L283">    patientViewTab.addTab(biologicalSamplesComponent).setIcon(FontAwesome.TINT);</span>
<span class="nc" id="L284">    patientViewTab.addTab(measuredSamplesComponent).setIcon(FontAwesome.SIGNAL);</span>
<span class="nc" id="L285">    patientViewTab.addTab(resultsComponent).setIcon(FontAwesome.TH_LARGE);</span>
<span class="nc" id="L286">    patientViewTab.addTab(workflowComponent).setIcon(FontAwesome.COGS);</span>
<span class="nc" id="L287">    patientViewTab.addTab(uploadComponent).setIcon(FontAwesome.UPLOAD);</span>


<span class="nc" id="L290">    patientViewTab.setImmediate(true);</span>


<span class="nc" id="L293">    patientViewTab.addSelectedTabChangeListener(new SelectedTabChangeListener() {</span>

      @Override
      public void selectedTabChange(SelectedTabChangeEvent event) {
<span class="nc" id="L297">        TabSheet tab = (TabSheet) event.getSource();</span>

<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (event.getTabSheet().getSelectedTab().getCaption().equals(&quot;Project Graph&quot;)) {</span>
<span class="nc" id="L300">          loadGraph();</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">        } else if (event.getTabSheet().getSelectedTab().getCaption().equals(&quot;Exp. Steps&quot;)) {</span>
<span class="nc" id="L302">          experimentComponent.updateUI(getCurrentBean());</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        } else if (event.getTabSheet().getSelectedTab().getCaption().equals(&quot;Datasets&quot;)) {</span>
<span class="nc" id="L304">          datasetComponent.updateUI(&quot;project&quot;, getCurrentBean().getId());</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        } else if (event.getTabSheet().getSelectedTab().getCaption().equals(&quot;Raw Data&quot;)) {</span>
<span class="nc" id="L306">          measuredSamplesComponent.updateUI(&quot;project&quot;, getCurrentBean().getId(), &quot;measured&quot;);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">        } else if (event.getTabSheet().getSelectedTab().getCaption().equals(&quot;Biological Samples&quot;)) {</span>
<span class="nc" id="L308">          biologicalSamplesComponent.updateUI(getCurrentBean().getId());</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">        } else if (event.getTabSheet().getSelectedTab().getCaption().equals(&quot;Results&quot;)) {</span>
<span class="nc" id="L310">          resultsComponent.updateUI(&quot;project&quot;, getCurrentBean().getId(), &quot;results&quot;);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">        } else if (event.getTabSheet().getSelectedTab().getCaption().equals(&quot;Status&quot;)) {</span>
<span class="nc" id="L312">          statusComponent.updateUI(getCurrentBean());</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        } else if (event.getTabSheet().getSelectedTab().getCaption().equals(&quot;Workflows&quot;)) {</span>
<span class="nc" id="L314">          Map&lt;String, String&gt; args = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L315">          args.put(&quot;id&quot;, getCurrentBean().getId());</span>
<span class="nc" id="L316">          args.put(&quot;type&quot;, &quot;project&quot;);</span>
<span class="nc" id="L317">          workflowComponent.update(args);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        } else if (event.getTabSheet().getSelectedTab().getCaption().equals(&quot;Upload Files&quot;)) {</span>
          // (get space from currentBean)
<span class="nc" id="L320">          uploadComponent.updateUI(manager, getCurrentBean().getCode(),</span>
<span class="nc" id="L321">              currentBean.getId().split(&quot;/&quot;)[1], datahandler.getOpenBisClient());</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">        } else if (event.getTabSheet().getSelectedTab().getCaption().equals(&quot;&quot;)) {</span>
<span class="nc" id="L323">          projectInformation.updateUI(getCurrentBean(), &quot;patient&quot;);</span>
        }
<span class="nc" id="L325">      }</span>
    });

<span class="nc" id="L328">    patientViewContent.addComponent(patientViewTab);</span>
<span class="nc" id="L329">    this.addComponent(patientViewContent);</span>

<span class="nc" id="L331">  }</span>

  /**
   * This function should be called each time currentBean is changed
   */
  public void updateContent() {
<span class="nc" id="L337">    setHeaderLabel(&quot;Patient &quot; + getCurrentBean().getCode());</span>

    // updateContentToolBar();
    // updateHLALayout();

    // updateProjectStatus();
<span class="nc" id="L343">    statusComponent.updateUI(this.currentBean);</span>
    // updateContentMemberSection();

<span class="nc" id="L346">    projectInformation.updateUI(getCurrentBean(), &quot;patient&quot;);</span>
<span class="nc" id="L347">  }</span>

  /**
   * initializes the description layout
   * 
   * @return
   */
  VerticalLayout initDescription() {
<span class="nc" id="L355">    VerticalLayout projDescription = new VerticalLayout();</span>
<span class="nc" id="L356">    VerticalLayout projDescriptionContent = new VerticalLayout();</span>

<span class="nc" id="L358">    projDescription.setCaption(&quot;&quot;);</span>
<span class="nc" id="L359">    projDescription.setIcon(FontAwesome.FILE_TEXT_O);</span>

<span class="nc" id="L361">    descContent = new Label(&quot;&quot;);</span>
<span class="nc" id="L362">    contact = new Label(&quot;&quot;, ContentMode.HTML);</span>

<span class="nc" id="L364">    patientInformation = new Label(&quot;No patient information provided.&quot;, ContentMode.HTML);</span>

<span class="nc" id="L366">    projDescriptionContent.addComponent(patientInformation);</span>
<span class="nc" id="L367">    projDescriptionContent.addComponent(descContent);</span>
<span class="nc" id="L368">    projDescriptionContent.addComponent(contact);</span>
<span class="nc" id="L369">    projDescriptionContent.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L370">    projDescriptionContent.setSpacing(true);</span>

<span class="nc" id="L372">    projDescription.addComponent(projDescriptionContent);</span>

<span class="nc" id="L374">    descContent.setStyleName(&quot;patientview&quot;);</span>
<span class="nc" id="L375">    contact.setStyleName(&quot;patientview&quot;);</span>
<span class="nc" id="L376">    patientInformation.setStyleName(&quot;patientview&quot;);</span>

<span class="nc" id="L378">    projDescription.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L379">    projDescription.setSpacing(true);</span>
<span class="nc" id="L380">    projDescription.setWidth(&quot;100%&quot;);</span>

<span class="nc" id="L382">    return projDescription;</span>
  }

  void updateContentDescription() {
<span class="nc" id="L386">    contact.setValue(</span>
        &quot;&lt;a href=\&quot;mailto:support@qbic.zendesk.com?subject=Question%20concerning%20project%20&quot;
<span class="nc" id="L388">            + currentBean.getId()</span>
            + &quot;\&quot; style=\&quot;color: #0068AA; text-decoration: none\&quot;&gt;Send question regarding patient &quot;
<span class="nc" id="L390">            + currentBean.getCode() + &quot;&lt;/a&gt;&quot;);</span>
<span class="nc" id="L391">    String desc = currentBean.getDescription();</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">    if (!desc.isEmpty()) {</span>
<span class="nc" id="L393">      descContent.setValue(desc);</span>
    }
<span class="nc" id="L395">    String patientInfo = &quot;&quot;;</span>
<span class="nc" id="L396">    Boolean available = false;</span>

<span class="nc" id="L398">    SearchCriteria sampleSc = new SearchCriteria();</span>
<span class="nc" id="L399">    sampleSc.addMatchClause(</span>
<span class="nc" id="L400">        MatchClause.createAttributeMatch(MatchClauseAttribute.TYPE, &quot;Q_BIOLOGICAL_ENTITY&quot;));</span>
<span class="nc" id="L401">    SearchCriteria projectSc = new SearchCriteria();</span>
<span class="nc" id="L402">    projectSc.addMatchClause(</span>
<span class="nc" id="L403">        MatchClause.createAttributeMatch(MatchClauseAttribute.PROJECT, currentBean.getCode()));</span>
<span class="nc" id="L404">    sampleSc.addSubCriteria(SearchSubCriteria.createExperimentCriteria(projectSc));</span>

<span class="nc" id="L406">    SearchCriteria experimentSc = new SearchCriteria();</span>
<span class="nc" id="L407">    experimentSc.addMatchClause(MatchClause.createAttributeMatch(MatchClauseAttribute.TYPE,</span>
<span class="nc" id="L408">        ExperimentType.Q_EXPERIMENTAL_DESIGN.name()));</span>
<span class="nc" id="L409">    sampleSc.addSubCriteria(SearchSubCriteria.createExperimentCriteria(experimentSc));</span>
<span class="nc" id="L410">    List&lt;Sample&gt; samples = datahandler.getOpenBisClient().getFacade().searchForSamples(sampleSc);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">    for (Sample sample : samples) {</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">      if (sample.getProperties().get(&quot;Q_ADDITIONAL_INFO&quot;) != null) {</span>
<span class="nc" id="L413">        available = true;</span>
<span class="nc" id="L414">        String[] splitted = sample.getProperties().get(&quot;Q_ADDITIONAL_INFO&quot;).split(&quot;;&quot;);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">        for (String s : splitted) {</span>
<span class="nc" id="L416">          String[] splitted2 = s.split(&quot;:&quot;);</span>
<span class="nc" id="L417">          patientInfo += String.format(&quot;&lt;p&gt;&lt;u&gt;%s&lt;/u&gt;: %s &lt;/p&gt; &quot;, splitted2[0], splitted2[1]);</span>
        }
      }
<span class="nc" id="L420">    }</span>


    /*
     * for (Iterator&lt;ExperimentBean&gt; i = currentBean.getExperiments().getItemIds().iterator(); i
     * .hasNext();) { // Get the current item identifier, which is an integer. ExperimentBean
     * expBean = i.next();
     * 
     * if (expBean.getType().equalsIgnoreCase(model.ExperimentType.Q_EXPERIMENTAL_DESIGN.name())) {
     * for (Iterator&lt;SampleBean&gt; ii = expBean.getSamples().getItemIds().iterator(); ii.hasNext();) {
     * SampleBean sampBean = ii.next(); if (sampBean.getType().equals(&quot;Q_BIOLOGICAL_ENTITY&quot;)) { if
     * (sampBean.getProperties().get(&quot;Q_ADDITIONAL_INFO&quot;) != null) { available = true; String[]
     * splitted = sampBean.getProperties().get(&quot;Q_ADDITIONAL_INFO&quot;).split(&quot;;&quot;); for (String s :
     * splitted) { String[] splitted2 = s.split(&quot;:&quot;); patientInfo += String.format(
     * &quot;&lt;p&gt;&lt;u&gt;%s&lt;/u&gt;: %s &lt;/p&gt; &quot;, splitted2[0], splitted2[1]);
     * 
     * } } } } } }
     */
<span class="nc bnc" id="L438" title="All 2 branches missed.">    if (available) {</span>
<span class="nc" id="L439">      patientInformation.setValue(patientInfo);</span>
    } else {
<span class="nc" id="L441">      patientInformation.setValue(&quot;No patient information provided.&quot;);</span>
    }

    // membersSection.removeAllComponents();
    // membersSection.addComponent(getMembersComponent());
<span class="nc" id="L446">  }</span>


  VerticalLayout initMemberSection() {
<span class="nc" id="L450">    VerticalLayout projMembers = new VerticalLayout();</span>
<span class="nc" id="L451">    projMembers.setCaption(&quot;Members&quot;);</span>

<span class="nc" id="L453">    membersSection = new VerticalLayout();</span>
<span class="nc" id="L454">    Component membersContent = new VerticalLayout();</span>

    // membersContent.setIcon(FontAwesome.USERS);
    // membersContent.setCaption(&quot;Members&quot;);
<span class="nc" id="L458">    membersSection.addComponent(membersContent);</span>
    // membersSection.setMargin(new MarginInfo(false, false, false, true));
<span class="nc" id="L460">    membersSection.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L461">    membersSection.setSpacing(true);</span>

<span class="nc" id="L463">    membersSection.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L464">    projMembers.addComponent(membersSection);</span>

<span class="nc" id="L466">    projMembers.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L467">    projMembers.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L468">    projMembers.setSpacing(true);</span>

<span class="nc" id="L470">    return projMembers;</span>
  }

  void updateContentMemberSection() {
<span class="nc" id="L474">    membersSection.removeAllComponents();</span>

<span class="nc" id="L476">    Component memberComponent = getMembersComponent();</span>

<span class="nc" id="L478">    membersSection.addComponent(new Label(</span>
        &quot;The following people are members of this project. If you would like to contact them, click on their name.&quot;,
        Label.CONTENT_PREFORMATTED));

<span class="nc" id="L482">    membersSection.addComponent(memberComponent);</span>
<span class="nc" id="L483">    membersSection.setComponentAlignment(memberComponent, Alignment.MIDDLE_CENTER);</span>
<span class="nc" id="L484">  }</span>

  /**
   * initializes the hla type layout
   * 
   * @return
   */
  VerticalLayout initHLALayout() {
<span class="nc" id="L492">    VerticalLayout hlaTyping = new VerticalLayout();</span>
<span class="nc" id="L493">    VerticalLayout hlaTypingContent = new VerticalLayout();</span>

<span class="nc" id="L495">    hlaTyping.setCaption(&quot;HLA Typing&quot;);</span>

    // String desc = currentBean.getDescription();
    // if (!desc.isEmpty()) {
    // descContent.setValue(desc);
    // }
<span class="nc" id="L501">    hlaTypeLabel = new Label(&quot;Not available.&quot;, ContentMode.HTML);</span>
<span class="nc" id="L502">    hlaTypeLabel.setStyleName(&quot;patientview&quot;);</span>

<span class="nc" id="L504">    hlaTypingContent.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L505">    hlaTypingContent.setSpacing(true);</span>
    // hlaTypingContent.setCaption(&quot;HLA Typing&quot;);
    // hlaTypingContent.setIcon(FontAwesome.BARCODE);
<span class="nc" id="L508">    hlaTypingContent.addComponent(hlaTypeLabel);</span>

<span class="nc" id="L510">    hlaTyping.addComponent(hlaTypingContent);</span>

<span class="nc" id="L512">    hlaTyping.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L513">    hlaTyping.setSpacing(true);</span>
<span class="nc" id="L514">    hlaTyping.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L515">    return hlaTyping;</span>
  }

  void updateHLALayout() {

<span class="nc" id="L520">    String labelContent = &quot;&lt;head&gt; &lt;title&gt;&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &quot;;</span>

<span class="nc" id="L522">    Boolean available = false;</span>

<span class="nc" id="L524">    SearchCriteria sc = new SearchCriteria();</span>
<span class="nc" id="L525">    sc.addMatchClause(MatchClause.createAttributeMatch(MatchClauseAttribute.TYPE,</span>
<span class="nc" id="L526">        ExperimentType.Q_NGS_HLATYPING.name()));</span>
<span class="nc" id="L527">    SearchCriteria projectSc = new SearchCriteria();</span>
<span class="nc" id="L528">    projectSc.addMatchClause(</span>
<span class="nc" id="L529">        MatchClause.createAttributeMatch(MatchClauseAttribute.PROJECT, currentBean.getCode()));</span>
<span class="nc" id="L530">    sc.addSubCriteria(SearchSubCriteria.createExperimentCriteria(projectSc));</span>

<span class="nc" id="L532">    SearchCriteria experimentSc = new SearchCriteria();</span>
<span class="nc" id="L533">    experimentSc.addMatchClause(MatchClause.createAttributeMatch(MatchClauseAttribute.TYPE,</span>
<span class="nc" id="L534">        ExperimentType.Q_NGS_HLATYPING.name()));</span>
<span class="nc" id="L535">    sc.addSubCriteria(SearchSubCriteria.createExperimentCriteria(experimentSc));</span>


<span class="nc" id="L538">    List&lt;Sample&gt; samples = datahandler.getOpenBisClient().getFacade().searchForSamples(sc);</span>

<span class="nc" id="L540">    SearchCriteria sc2 = new SearchCriteria();</span>
<span class="nc" id="L541">    sc2.addMatchClause(MatchClause.createAttributeMatch(MatchClauseAttribute.TYPE,</span>
<span class="nc" id="L542">        ExperimentType.Q_WF_NGS_HLATYPING.name()));</span>
<span class="nc" id="L543">    SearchCriteria projectSc2 = new SearchCriteria();</span>
<span class="nc" id="L544">    projectSc2.addMatchClause(</span>
<span class="nc" id="L545">        MatchClause.createAttributeMatch(MatchClauseAttribute.PROJECT, currentBean.getCode()));</span>
<span class="nc" id="L546">    sc2.addSubCriteria(SearchSubCriteria.createExperimentCriteria(projectSc2));</span>

<span class="nc" id="L548">    SearchCriteria experimentSc2 = new SearchCriteria();</span>
<span class="nc" id="L549">    experimentSc2.addMatchClause(MatchClause.createAttributeMatch(MatchClauseAttribute.TYPE,</span>
<span class="nc" id="L550">        ExperimentType.Q_WF_NGS_HLATYPING.name()));</span>
<span class="nc" id="L551">    sc2.addSubCriteria(SearchSubCriteria.createExperimentCriteria(experimentSc2));</span>

<span class="nc" id="L553">    List&lt;Experiment&gt; wfExperiments =</span>
<span class="nc" id="L554">        datahandler.getOpenBisClient().getFacade().searchForExperiments(sc2);</span>

<span class="nc" id="L556">    List&lt;Sample&gt; wfSamples = new ArrayList&lt;Sample&gt;();</span>

<span class="nc bnc" id="L558" title="All 2 branches missed.">    for (Experiment exp : wfExperiments) {</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">      if (exp.getCode().contains(currentBean.getCode())) {</span>
<span class="nc" id="L560">        wfSamples</span>
<span class="nc" id="L561">            .addAll(datahandler.getOpenBisClient().getSamplesofExperiment(exp.getIdentifier()));</span>
      }
<span class="nc" id="L563">    }</span>

<span class="nc bnc" id="L565" title="All 2 branches missed.">    for (Sample sample : samples) {</span>
<span class="nc" id="L566">      available = true;</span>
<span class="nc" id="L567">      String classString = sample.getProperties().get(&quot;Q_HLA_CLASS&quot;);</span>
<span class="nc" id="L568">      String[] splitted = classString.split(&quot;_&quot;);</span>
<span class="nc" id="L569">      String lastOne = splitted[splitted.length - 1];</span>
<span class="nc" id="L570">      String addInformation = &quot;&quot;;</span>

<span class="nc bnc" id="L572" title="All 2 branches missed.">      if (!(sample.getProperties().get(&quot;Q_ADDITIONAL_INFO&quot;) == null)) {</span>
<span class="nc" id="L573">        addInformation = sample.getProperties().get(&quot;Q_ADDITIONAL_INFO&quot;);</span>
      }

<span class="nc" id="L576">      labelContent += String.format(&quot;MHC Class %s &quot; + &quot;&lt;p&gt;&lt;u&gt;Patient&lt;/u&gt;: %s &lt;/p&gt; &quot; + &quot;&lt;p&gt;%s &lt;/p&gt; &quot;,</span>
<span class="nc" id="L577">          lastOne, sample.getProperties().get(&quot;Q_HLA_TYPING&quot;), addInformation);</span>
<span class="nc" id="L578">    }</span>

<span class="nc bnc" id="L580" title="All 2 branches missed.">    for (Sample sample : wfSamples) {</span>
<span class="nc" id="L581">      available = true;</span>
<span class="nc" id="L582">      labelContent += String.format(&quot;&lt;u&gt;Computational Typing (OptiType)&lt;/u&gt;&quot; + &quot;&lt;p&gt; %s &lt;/p&gt; &quot;,</span>
<span class="nc" id="L583">          sample.getProperties().get(&quot;Q_HLA_TYPING&quot;));</span>
<span class="nc" id="L584">    }</span>

<span class="nc" id="L586">    labelContent += &quot;&lt;/body&gt;&quot;;</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">    if (available) {</span>
<span class="nc" id="L588">      hlaTypeLabel.setValue(labelContent);</span>
    }

    else {
<span class="nc" id="L592">      hlaTypeLabel.setValue(&quot;Not available.&quot;);</span>
    }
<span class="nc" id="L594">  }</span>

  VerticalLayout initTable() {
<span class="nc" id="L597">    registeredExperiments = this.buildFilterTable();</span>
<span class="nc" id="L598">    this.tableClickChangeTreeView();</span>
<span class="nc" id="L599">    VerticalLayout tableSection = new VerticalLayout();</span>
<span class="nc" id="L600">    VerticalLayout tableSectionContent = new VerticalLayout();</span>

<span class="nc" id="L602">    tableSection.setCaption(&quot;Exp. Steps&quot;);</span>

    // tableSectionContent.setCaption(&quot;Registered Experiments&quot;);
    // tableSectionContent.setIcon(FontAwesome.FLASK);
<span class="nc" id="L606">    tableSectionContent.addComponent(registeredExperiments);</span>

<span class="nc" id="L608">    tableSectionContent.setMargin(new MarginInfo(true, false, false, true));</span>
<span class="nc" id="L609">    tableSection.setMargin(new MarginInfo(true, false, false, true));</span>
<span class="nc" id="L610">    registeredExperiments.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L611">    tableSection.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L612">    tableSectionContent.setWidth(&quot;100%&quot;);</span>

<span class="nc" id="L614">    tableSection.addComponent(tableSectionContent);</span>

<span class="nc" id="L616">    this.export = new Button(&quot;Export as TSV&quot;);</span>
<span class="nc" id="L617">    buttonLayoutSection = new VerticalLayout();</span>
<span class="nc" id="L618">    HorizontalLayout buttonLayout = new HorizontalLayout();</span>
<span class="nc" id="L619">    buttonLayout.setHeight(null);</span>
<span class="nc" id="L620">    buttonLayout.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L621">    buttonLayout.addComponent(this.export);</span>
<span class="nc" id="L622">    buttonLayout.setMargin(new MarginInfo(false, false, true, false));</span>
<span class="nc" id="L623">    buttonLayoutSection.addComponent(buttonLayout);</span>
<span class="nc" id="L624">    buttonLayoutSection.setSpacing(true);</span>
<span class="nc" id="L625">    buttonLayoutSection.setMargin(new MarginInfo(false, false, true, true));</span>

<span class="nc" id="L627">    tableSection.addComponent(buttonLayoutSection);</span>

<span class="nc" id="L629">    return tableSection;</span>
  }

<span class="nc" id="L632">  class MemberWorker extends Thread {</span>

    @Override
    public void run() {
<span class="nc" id="L636">      Company company = null;</span>
<span class="nc" id="L637">      long companyId = 1;</span>
      try {
<span class="nc" id="L639">        String webId = PropsUtil.get(PropsKeys.COMPANY_DEFAULT_WEB_ID);</span>
<span class="nc" id="L640">        company = CompanyLocalServiceUtil.getCompanyByWebId(webId);</span>
<span class="nc" id="L641">        companyId = company.getCompanyId();</span>
<span class="nc" id="L642">        LOG.debug(</span>
<span class="nc" id="L643">            String.format(&quot;Using webId %s and companyId %d to get Portal User&quot;, webId, companyId));</span>
<span class="nc" id="L644">      } catch (PortalException | SystemException e) {</span>
<span class="nc" id="L645">        LOG.error(&quot;liferay error, could not retrieve companyId. Trying default companyId, which is &quot;</span>
<span class="nc" id="L646">            + companyId, e.getStackTrace());</span>
<span class="nc" id="L647">      }</span>
<span class="nc" id="L648">      Set&lt;String&gt; list = datahandler.removeQBiCStaffFromMemberSet(</span>
<span class="nc" id="L649">          datahandler.getOpenBisClient().getSpaceMembers(currentBean.getId().split(&quot;/&quot;)[1]));</span>
<span class="nc" id="L650">      members = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L651">      memberLetters = new HashMap&lt;String, String&gt;();</span>

      // LOG.debug(list.toString());

<span class="nc bnc" id="L655" title="All 2 branches missed.">      if (list != null) {</span>
<span class="nc" id="L656">        memberString = new StringBuilder();</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">        for (String member : list) {</span>
<span class="nc" id="L658">          User user = null;</span>
          try {
<span class="nc" id="L660">            user = UserLocalServiceUtil.getUserByScreenName(companyId, member);</span>
<span class="nc" id="L661">          } catch (PortalException | SystemException e) {</span>
<span class="nc" id="L662">          }</span>

<span class="nc bnc" id="L664" title="All 2 branches missed.">          if (memberString.length() &gt; 0) {</span>
            // memberString.append(&quot; , &quot;);
          }

<span class="nc bnc" id="L668" title="All 2 branches missed.">          if (user == null) {</span>
<span class="nc" id="L669">            LOG.warn(String.format(&quot;Openbis user %s appears to not exist in Portal&quot;, member));</span>
            // memberString.append(member);
<span class="nc" id="L671">            members.put(member, member);</span>
            // membersLayout.addComponent(new Label(member));
          } else {
<span class="nc" id="L674">            String firstName = user.getFirstName();</span>
<span class="nc" id="L675">            String lastName = user.getLastName();</span>

<span class="nc" id="L677">            String email = user.getEmailAddress();</span>

<span class="nc" id="L679">            String userString =</span>
                &quot;&lt;a href=\&quot;mailto:&quot; + email + &quot;\&quot; style=\&quot;color: #0068AA; text-decoration: none\&quot;&gt;&quot;
                    + lastName + &quot;, &quot; + firstName + &quot;&lt;/a&gt;&quot;;
<span class="nc bnc" id="L682" title="All 2 branches missed.">            if (user.getLastName().length() &gt; 0) {</span>
<span class="nc" id="L683">              members.put(user.getLastName(), userString);</span>
            }

            else {
<span class="nc" id="L687">              members.put(user.getFirstName(), userString);</span>
            }

            // memberString.append(&quot;&lt;a href=\&quot;mailto:&quot;);
            // memberString.append(email);
            // memberString.append(&quot;\&quot; style=\&quot;color: #0068AA; text-decoration: none\&quot;&gt;&quot;);
            // memberString.append(fullname);
            // memberString.append(&quot;&lt;/a&gt;&quot;);
          }
<span class="nc" id="L696">        }</span>
<span class="nc" id="L697">        synchronized (UI.getCurrent()) {</span>
<span class="nc" id="L698">          processedMember();</span>
<span class="nc" id="L699">        }</span>
      }
<span class="nc" id="L701">    }</span>
  }

  /**
   * 
   * @return
   */
  private Component getMembersComponent() {
<span class="nc" id="L709">    membersLayout = new HorizontalLayout();</span>
    // membersLayout.setIcon(FontAwesome.USERS);
    // membersLayout.setCaption(&quot;Members&quot;);
<span class="nc" id="L712">    membersLayout.setWidth(&quot;100%&quot;);</span>


    // final Button loadMembers = new Button(&quot;[+]&quot;);
    // membersLayout.addComponent(loadMembers);
    // loadMembers.setStyleName(ValoTheme.BUTTON_LINK);
    // loadMembers.addClickListener(new ClickListener() {

    // @Override
    // public void buttonClick(ClickEvent event) {
<span class="nc" id="L722">    ProgressBar progress = new ProgressBar();</span>
<span class="nc" id="L723">    progress.setIndeterminate(true);</span>
<span class="nc" id="L724">    Label info = new Label(</span>
        &quot;Searching for members. Can take several seconds on big projects. Please be patient.&quot;);
<span class="nc" id="L726">    info.setStyleName(ValoTheme.LABEL_SUCCESS);</span>
    // membersLayout.addComponent(info);
<span class="nc" id="L728">    membersLayout.addComponent(progress);</span>
<span class="nc" id="L729">    MemberWorker worker = new MemberWorker();</span>
<span class="nc" id="L730">    worker.start();</span>
<span class="nc" id="L731">    UI.getCurrent().setPollInterval(500);</span>
    // loadMembers.setEnabled(false);

<span class="nc" id="L734">    return membersLayout;</span>
  }


  public void processedMember() {
<span class="nc" id="L739">    String memberString = &quot;&quot;;</span>
    Label label;

<span class="nc bnc" id="L742" title="All 2 branches missed.">    if (members.size() &lt; 1) {</span>
<span class="nc" id="L743">      label = new Label(&quot;No Members found.&quot;);</span>
    } else {
<span class="nc bnc" id="L745" title="All 2 branches missed.">      for (Entry&lt;String, String&gt; entry : members.entrySet()) {</span>
<span class="nc" id="L746">        String firstLetter = String.valueOf(entry.getKey().charAt(0));</span>

<span class="nc bnc" id="L748" title="All 2 branches missed.">        if (!memberLetters.containsKey(firstLetter)) {</span>
<span class="nc" id="L749">          memberString +=</span>
<span class="nc" id="L750">              String.format(&quot;&lt;font size='16'&gt;&lt;b&gt;%s&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&quot;, firstLetter.toUpperCase());</span>
<span class="nc" id="L751">          memberLetters.put(firstLetter, &quot;&quot;);</span>
        }

<span class="nc" id="L754">        memberString += String.format(&quot;%s&lt;br&gt;&quot;, entry.getValue());</span>
<span class="nc" id="L755">      }</span>
<span class="nc" id="L756">      label = new Label(memberString, ContentMode.HTML);</span>
    }

    // if (memberString == null || memberString.length() == 0) {
    // label = new Label(&quot;no members found.&quot;);
    // } else {
    // label = new Label(memberString.toString(), ContentMode.HTML);
    // }

<span class="nc" id="L765">    membersLayout.removeAllComponents();</span>
<span class="nc" id="L766">    membersLayout.addComponent(label);</span>
<span class="nc" id="L767">    membersLayout.setSpacing(true);</span>
<span class="nc" id="L768">    membersLayout.setMargin(new MarginInfo(false, false, true, true));</span>


<span class="nc" id="L771">    UI.getCurrent().setPollInterval(-1);</span>
    // loadMembers.setVisible(false);
<span class="nc" id="L773">  }</span>


  // OLD
  void updateProjectStatus() {
<span class="nc" id="L778">    BeanItemContainer&lt;ExperimentStatusBean&gt; experimentstatusBeans =</span>
<span class="nc" id="L779">        datahandler.computeIvacPatientStatus(currentBean);</span>

<span class="nc" id="L781">    int finishedExperiments = 0;</span>
<span class="nc" id="L782">    status.removeAllComponents();</span>
<span class="nc" id="L783">    status.setWidth(100.0f, Unit.PERCENTAGE);</span>


    // Generate button caption column
<span class="nc" id="L787">    final GeneratedPropertyContainer gpc = new GeneratedPropertyContainer(experimentstatusBeans);</span>
<span class="nc" id="L788">    gpc.addGeneratedProperty(&quot;started&quot;, new PropertyValueGenerator&lt;String&gt;() {</span>

      @Override
      public Class&lt;String&gt; getType() {
<span class="nc" id="L792">        return String.class;</span>
      }

      @Override
      public String getValue(Item item, Object itemId, Object propertyId) {
<span class="nc" id="L797">        String status = null;</span>

<span class="nc bnc" id="L799" title="All 2 branches missed.">        if ((double) item.getItemProperty(&quot;status&quot;).getValue() &gt; 0.0) {</span>
<span class="nc" id="L800">          status = &quot;&lt;span class=\&quot;v-icon\&quot; style=\&quot;font-family: &quot;</span>
<span class="nc" id="L801">              + FontAwesome.CHECK.getFontFamily() + &quot;;color:&quot; + &quot;#2dd085&quot; + &quot;\&quot;&gt;&amp;#x&quot;</span>
<span class="nc" id="L802">              + Integer.toHexString(FontAwesome.CHECK.getCodepoint()) + &quot;;&lt;/span&gt;&quot;;</span>
        } else {
<span class="nc" id="L804">          status = &quot;&lt;span class=\&quot;v-icon\&quot; style=\&quot;font-family: &quot;</span>
<span class="nc" id="L805">              + FontAwesome.TIMES.getFontFamily() + &quot;;color:&quot; + &quot;#f54993&quot; + &quot;\&quot;&gt;&amp;#x&quot;</span>
<span class="nc" id="L806">              + Integer.toHexString(FontAwesome.TIMES.getCodepoint()) + &quot;;&lt;/span&gt;&quot;;</span>
        }

<span class="nc" id="L809">        return status.toString();</span>
      }
    });
<span class="nc" id="L812">    gpc.removeContainerProperty(&quot;identifier&quot;);</span>

<span class="nc" id="L814">    experiments.setContainerDataSource(gpc);</span>
    // experiments.setHeaderVisible(false);
<span class="nc" id="L816">    experiments.setHeightMode(HeightMode.ROW);</span>
<span class="nc" id="L817">    experiments.setHeightByRows(gpc.size());</span>
<span class="nc" id="L818">    experiments.setWidth(Page.getCurrent().getBrowserWindowWidth() * 0.6f, Unit.PIXELS);</span>



<span class="nc" id="L822">    experiments.getColumn(&quot;status&quot;).setRenderer(new ProgressBarRenderer());</span>
<span class="nc" id="L823">    experiments.setColumnOrder(&quot;started&quot;, &quot;code&quot;, &quot;description&quot;, &quot;status&quot;, &quot;download&quot;,</span>
        &quot;runWorkflow&quot;);

<span class="nc" id="L826">    ButtonRenderer downloadRenderer = new ButtonRenderer(new RendererClickListener() {</span>
      @Override
      public void click(RendererClickEvent event) {
<span class="nc" id="L829">        ExperimentStatusBean esb = (ExperimentStatusBean) event.getItemId();</span>

<span class="nc bnc" id="L831" title="All 2 branches missed.">        if (esb.getDescription().equals(&quot;Barcode Generation&quot;)) {</span>
<span class="nc" id="L832">          new Notification(&quot;Download of Barcodes not available.&quot;,</span>
              &quot;&lt;br/&gt;Please create barcodes by clicking 'Run'.&quot;, Type.WARNING_MESSAGE, true)
<span class="nc" id="L834">                  .show(Page.getCurrent());</span>
<span class="nc bnc" id="L835" title="All 4 branches missed.">        } else if (esb.getIdentifier() == null || esb.getIdentifier().isEmpty()) {</span>
<span class="nc" id="L836">          new Notification(&quot;No data available for download.&quot;,</span>
              &quot;&lt;br/&gt;Please do the analysis by clicking 'Run' first.&quot;, Type.WARNING_MESSAGE, true)
<span class="nc" id="L838">                  .show(Page.getCurrent());</span>
        } else {
<span class="nc" id="L840">          ArrayList&lt;String&gt; message = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L841">          message.add(&quot;clicked&quot;);</span>
<span class="nc" id="L842">          StringBuilder sb = new StringBuilder(&quot;type=&quot;);</span>
<span class="nc" id="L843">          sb.append(&quot;experiment&quot;);</span>
<span class="nc" id="L844">          sb.append(&quot;&amp;&quot;);</span>
<span class="nc" id="L845">          sb.append(&quot;id=&quot;);</span>
          // sb.append(currentBean.getId());
<span class="nc" id="L847">          sb.append(esb.getIdentifier());</span>
<span class="nc" id="L848">          message.add(sb.toString());</span>
<span class="nc" id="L849">          message.add(DatasetView.navigateToLabel);</span>
<span class="nc" id="L850">          state.notifyObservers(message);</span>
        }

<span class="nc" id="L853">      }</span>

    });


<span class="nc" id="L858">    experiments.getColumn(&quot;download&quot;).setRenderer(downloadRenderer);</span>

<span class="nc" id="L860">    experiments.getColumn(&quot;runWorkflow&quot;)</span>
<span class="nc" id="L861">        .setRenderer(new ButtonRenderer(new RendererClickListener() {</span>
          @Override
          public void click(RendererClickEvent event) {
<span class="nc" id="L864">            ExperimentStatusBean esb = (ExperimentStatusBean) event.getItemId();</span>

            // TODO idea get description of item to navigate to the correct workflow ?!
<span class="nc bnc" id="L867" title="All 2 branches missed.">            if (esb.getDescription().equals(&quot;Barcode Generation&quot;)) {</span>
<span class="nc" id="L868">              ArrayList&lt;String&gt; message = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L869">              message.add(&quot;clicked&quot;);</span>
<span class="nc" id="L870">              message.add(currentBean.getId());</span>
              // TODO link to barcode dragon
              // message.add(BarcodeView.navigateToLabel);
              // state.notifyObservers(message);
<span class="nc" id="L874">            } else {</span>
<span class="nc" id="L875">              ArrayList&lt;String&gt; message = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L876">              message.add(&quot;clicked&quot;);</span>
<span class="nc" id="L877">              StringBuilder sb = new StringBuilder(&quot;type=&quot;);</span>
<span class="nc" id="L878">              sb.append(&quot;workflowExperimentType&quot;);</span>
<span class="nc" id="L879">              sb.append(&quot;&amp;&quot;);</span>
<span class="nc" id="L880">              sb.append(&quot;id=&quot;);</span>
<span class="nc" id="L881">              sb.append(&quot;Q_WF_MS_PEPTIDEID&quot;);</span>
<span class="nc" id="L882">              sb.append(&quot;&amp;&quot;);</span>
<span class="nc" id="L883">              sb.append(&quot;project=&quot;);</span>
<span class="nc" id="L884">              sb.append(currentBean.getId());</span>
<span class="nc" id="L885">              message.add(sb.toString());</span>
<span class="nc" id="L886">              message.add(WorkflowView.navigateToLabel);</span>
<span class="nc" id="L887">              state.notifyObservers(message);</span>
            }
<span class="nc" id="L889">          }</span>
        }));

<span class="nc" id="L892">    experiments.getColumn(&quot;started&quot;).setRenderer(new HtmlRenderer());</span>

<span class="nc" id="L894">    ProgressBar progressBar = new ProgressBar();</span>
<span class="nc" id="L895">    progressBar.setCaption(&quot;Overall Progress&quot;);</span>
<span class="nc" id="L896">    progressBar.setWidth(Page.getCurrent().getBrowserWindowWidth() * 0.6f, Unit.PIXELS);</span>
<span class="nc" id="L897">    progressBar.setStyleName(&quot;patientprogress&quot;);</span>

<span class="nc" id="L899">    status.addComponent(progressBar);</span>
<span class="nc" id="L900">    status.addComponent(experiments);</span>
<span class="nc" id="L901">    status.setComponentAlignment(progressBar, Alignment.MIDDLE_CENTER);</span>
<span class="nc" id="L902">    status.setComponentAlignment(experiments, Alignment.MIDDLE_CENTER);</span>


    /**
     * Defined Experiments for iVac - Barcodes available -&gt; done with project creation (done) -
     * Sequencing done (Status Q_NGS_MEASUREMENT) - Variants annotated (Status
     * Q_NGS_VARIANT_CALLING) - HLA Typing done (STATUS Q_NGS_WF_HLA_TYPING) - Epitope Prediction
     * done (STATUS Q_WF_NGS_EPITOPE_PREDICTION)
     */


<span class="nc bnc" id="L913" title="All 2 branches missed.">    for (Iterator i = experimentstatusBeans.getItemIds().iterator(); i.hasNext();) {</span>
<span class="nc" id="L914">      ExperimentStatusBean statusBean = (ExperimentStatusBean) i.next();</span>


      // HorizontalLayout experimentStatusRow = new HorizontalLayout();
      // experimentStatusRow.setSpacing(true);

<span class="nc" id="L920">      finishedExperiments += statusBean.getStatus();</span>

      // statusBean.setDownload(&quot;Download&quot;);
<span class="nc" id="L923">      statusBean.setWorkflow(&quot;Run&quot;);</span>

      /*
       * if ((Integer) pairs.getValue() == 0) { Label statusLabel = new Label(pairs.getKey() + &quot;: &quot;
       * + FontAwesome.TIMES.getHtml(), ContentMode.HTML); statusLabel.addStyleName(&quot;redicon&quot;);
       * experimentStatusRow.addComponent(statusLabel);
       * statusContent.addComponent(experimentStatusRow); }
       * 
       * else {
       * 
       * Label statusLabel = new Label(pairs.getKey() + &quot;: &quot; + FontAwesome.CHECK.getHtml(),
       * ContentMode.HTML); statusLabel.addStyleName(&quot;greenicon&quot;);
       * experimentStatusRow.addComponent(statusLabel);
       * statusContent.addComponent(experimentStatusRow);
       * 
       * finishedExperiments += (Integer) pairs.getValue(); }
       * experimentStatusRow.addComponent(runWorkflow);
       * 
       * }
       */
<span class="nc" id="L943">    }</span>


<span class="nc" id="L946">    progressBar.setValue((float) finishedExperiments / experimentstatusBeans.size());</span>
<span class="nc" id="L947">  }</span>

  /**
   * 
   * @return
   */
  public VerticalLayout initProjectStatus() {
<span class="nc" id="L954">    status = new VerticalLayout();</span>
<span class="nc" id="L955">    status.setWidth(100.0f, Unit.PERCENTAGE);</span>

<span class="nc" id="L957">    status.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L958">    status.setSpacing(true);</span>
    // status.setCaption(&quot;Project Status&quot;);
    // status.setIcon(FontAwesome.CHECK_SQUARE);
<span class="nc" id="L961">    status.setSizeFull();</span>

<span class="nc" id="L963">    VerticalLayout projectStatus = new VerticalLayout();</span>
<span class="nc" id="L964">    projectStatus.setCaption(&quot;Status&quot;);</span>
<span class="nc" id="L965">    projectStatus.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L966">    projectStatus.setSpacing(true);</span>

<span class="nc" id="L968">    experiments = new Grid();</span>
<span class="nc" id="L969">    experiments.setReadOnly(true);</span>
<span class="nc" id="L970">    experiments.setWidth(100.0f, Unit.PERCENTAGE);</span>
<span class="nc" id="L971">    status.addComponent(experiments);</span>

<span class="nc" id="L973">    ProgressBar progressBar = new ProgressBar();</span>
<span class="nc" id="L974">    progressBar.setValue(0f);</span>
<span class="nc" id="L975">    status.addComponent(progressBar);</span>

<span class="nc" id="L977">    projectStatus.addComponent(status);</span>

<span class="nc" id="L979">    return projectStatus;</span>
  }

  void resetGraphs() {
<span class="nc" id="L983">    graphSectionContent.removeAllComponents();</span>
<span class="nc" id="L984">    newGraphContent.removeAllComponents();</span>
<span class="nc" id="L985">  }</span>

  /**
   * 
   * @return
   */
  VerticalLayout initGraph() {
<span class="nc" id="L992">    VerticalLayout graphSection = new VerticalLayout();</span>
<span class="nc" id="L993">    graphSectionContent = new VerticalLayout();</span>

<span class="nc" id="L995">    graphSection.setCaption(&quot;Project Graph&quot;);</span>

<span class="nc" id="L997">    graphSectionContent.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L998">    graphSection.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L999">    graphSection.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L1000">    graphSectionContent.setWidth(&quot;100%&quot;);</span>

<span class="nc" id="L1002">    graphSection.addComponent(graphSectionContent);</span>
<span class="nc" id="L1003">    return graphSection;</span>
  }

  /**
   * for both graphs
   * 
   * @return the tablayout containing both graphs
   */
  Component initGraphs() {
<span class="nc" id="L1012">    TabSheet graphTab = new TabSheet();</span>
<span class="nc" id="L1013">    graphTab.setCaption(&quot;Project Graph&quot;);</span>

<span class="nc" id="L1015">    VerticalLayout graphSection = new VerticalLayout();</span>
<span class="nc" id="L1016">    graphSectionContent = new VerticalLayout();</span>

<span class="nc" id="L1018">    graphSection.setCaption(&quot;Project Graph&quot;);</span>

<span class="nc" id="L1020">    graphSectionContent.setMargin(new MarginInfo(true, false, true, true));</span>
    // graphSection.setMargin(new MarginInfo(true, false, true, true));
<span class="nc" id="L1022">    graphSection.setMargin(true);</span>
<span class="nc" id="L1023">    graphSection.setSpacing(true);</span>
<span class="nc" id="L1024">    graphSection.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L1025">    graphSectionContent.setWidth(&quot;100%&quot;);</span>

<span class="nc" id="L1027">    OpenBisClient openbis = datahandler.getOpenBisClient();</span>
<span class="nc" id="L1028">    Map&lt;String, String&gt; taxMap = openbis.getVocabCodesAndLabelsForVocab(&quot;Q_NCBI_TAXONOMY&quot;);</span>
<span class="nc" id="L1029">    Map&lt;String, String&gt; tissueMap = openbis.getVocabCodesAndLabelsForVocab(&quot;Q_PRIMARY_TISSUES&quot;);</span>

<span class="nc" id="L1031">    newGraphContent = new GraphPage(taxMap, tissueMap);</span>

<span class="nc" id="L1033">    graphSection.addComponent(graphSectionContent);</span>
<span class="nc" id="L1034">    graphTab.addTab(graphSection, &quot;Sample Graph&quot;);</span>
<span class="nc" id="L1035">    graphTab.addTab(newGraphContent, &quot;Sample Graph v2 (beta)&quot;);</span>
<span class="nc" id="L1036">    return graphTab;</span>
  }

  public void processed() {
<span class="nc" id="L1040">    UI.getCurrent().setPollInterval(-1);</span>
<span class="nc" id="L1041">  }</span>

  class Worker extends Thread {
    private PatientView patientView;

<span class="nc" id="L1046">    public Worker(PatientView current) {</span>
<span class="nc" id="L1047">      patientView = current;</span>
<span class="nc" id="L1048">    }</span>

    @Override
    public void run() {
<span class="nc" id="L1052">      patientView.updateContentGraph();</span>
<span class="nc" id="L1053">      synchronized (UI.getCurrent()) {</span>
<span class="nc" id="L1054">        processed();</span>
<span class="nc" id="L1055">      }</span>

<span class="nc" id="L1057">    }</span>
  }

  public void loadGraph() {
    // LOG.debug(String.valueOf(graphSectionContent.getComponentCount() == 0));
<span class="nc bnc" id="L1062" title="All 2 branches missed.">    if (graphSectionContent.getComponentCount() &gt; 0)</span>
<span class="nc" id="L1063">      LOG.debug(String.valueOf(graphSectionContent.getComponent(0) instanceof Image));</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">    if (graphSectionContent.getComponentCount() == 0</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">        || !(graphSectionContent.getComponent(0) instanceof Image)) {</span>
<span class="nc" id="L1066">      ProgressBar progress = new ProgressBar();</span>
<span class="nc" id="L1067">      progress.setIndeterminate(true);</span>
<span class="nc" id="L1068">      Label info = new Label(</span>
          &quot;Computing the project graph can take several seconds on big projects. Please be patient.&quot;);
<span class="nc" id="L1070">      info.setStyleName(ValoTheme.LABEL_SUCCESS);</span>
<span class="nc" id="L1071">      graphSectionContent.removeAllComponents();</span>
      // graphSectionContent.addComponent(info);
<span class="nc" id="L1073">      graphSectionContent.addComponent(progress);</span>
      // graphSectionContent.setComponentAlignment(info, Alignment.MIDDLE_CENTER);
<span class="nc" id="L1075">      graphSectionContent.setComponentAlignment(progress, Alignment.MIDDLE_CENTER);</span>

<span class="nc" id="L1077">      Worker worker = new Worker(getCurrent());</span>
<span class="nc" id="L1078">      worker.start();</span>
<span class="nc" id="L1079">      UI.getCurrent().setPollInterval(500);</span>
    }
<span class="nc" id="L1081">  }</span>

  private void tableClickChangeTreeView() {
<span class="nc" id="L1084">    registeredExperiments.setSelectable(true);</span>
<span class="nc" id="L1085">    registeredExperiments.setImmediate(true);</span>
<span class="nc" id="L1086">    registeredExperiments.addValueChangeListener(</span>
        new ViewTablesClickListener(registeredExperiments, ExperimentView.navigateToLabel));
<span class="nc" id="L1088">  }</span>

  /**
   * initializes and builds a filtering table for this view
   * 
   * @return
   */
  private FilterTable buildFilterTable() {
<span class="nc" id="L1096">    FilterTable filterTable = new FilterTable();</span>

<span class="nc" id="L1098">    filterTable.setFilterDecorator(new DatasetViewFilterDecorator());</span>
<span class="nc" id="L1099">    filterTable.setFilterGenerator(new DatasetViewFilterGenerator());</span>

<span class="nc" id="L1101">    filterTable.setFilterBarVisible(true);</span>

<span class="nc" id="L1103">    filterTable.setSelectable(true);</span>
<span class="nc" id="L1104">    filterTable.setImmediate(true);</span>

<span class="nc" id="L1106">    filterTable.setRowHeaderMode(RowHeaderMode.INDEX);</span>

<span class="nc" id="L1108">    filterTable.setColumnCollapsingAllowed(true);</span>

<span class="nc" id="L1110">    filterTable.setColumnReorderingAllowed(true);</span>

<span class="nc" id="L1112">    filterTable.setColumnHeader(&quot;code&quot;, &quot;Name&quot;);</span>
<span class="nc" id="L1113">    filterTable.setColumnHeader(&quot;type&quot;, &quot;Type&quot;);</span>
<span class="nc" id="L1114">    filterTable.setColumnHeader(&quot;registrationDate&quot;, &quot;Registration Date&quot;);</span>
<span class="nc" id="L1115">    filterTable.setColumnHeader(&quot;registrator&quot;, &quot;Registered By&quot;);</span>
<span class="nc" id="L1116">    filterTable.setColumnHeader(&quot;status&quot;, &quot;Status&quot;);</span>

<span class="nc" id="L1118">    return filterTable;</span>
  }

  public PatientView getCurrent() {
<span class="nc" id="L1122">    return this;</span>
  }

  void updateContentGraph() {
<span class="nc" id="L1126">    String projectID = currentBean.getId();</span>
<span class="nc" id="L1127">    List&lt;Sample&gt; samples = datahandler.getOpenBisClient()</span>
<span class="nc" id="L1128">        .getSamplesWithParentsAndChildrenOfProjectBySearchService(projectID);</span>
<span class="nc" id="L1129">    parseNewGraph(projectID, samples);</span>
<span class="nc" id="L1130">    Resource resource = getGraphResource(projectID, samples);</span>

<span class="nc bnc" id="L1132" title="All 2 branches missed.">    if (resource != null) {</span>
<span class="nc" id="L1133">      graphSectionContent.removeAllComponents();</span>
<span class="nc" id="L1134">      Image graphImage = new Image(&quot;&quot;, resource);</span>

<span class="nc" id="L1136">      graphSectionContent.addComponent(graphImage);</span>
<span class="nc" id="L1137">      graphSectionContent.setComponentAlignment(graphImage, Alignment.MIDDLE_CENTER);</span>

<span class="nc" id="L1139">    } else {</span>
<span class="nc" id="L1140">      Label error = new Label(&quot;Project Graph can not be computed at that time for this project&quot;);</span>
<span class="nc" id="L1141">      error.setStyleName(ValoTheme.LABEL_FAILURE);</span>
<span class="nc" id="L1142">      graphSectionContent.removeAllComponents();</span>
<span class="nc" id="L1143">      graphSectionContent.addComponent(error);</span>
<span class="nc" id="L1144">      graphSectionContent.setComponentAlignment(error, Alignment.MIDDLE_CENTER);</span>

<span class="nc" id="L1146">      LOG.error(String.format(&quot;%s: %s&quot;, error.getValue(), currentBean.getId()));</span>
    }
<span class="nc" id="L1148">  }</span>

  private void parseNewGraph(String projectID, List&lt;Sample&gt; samples) {
<span class="nc" id="L1151">    List&lt;DataSet&gt; datasets =</span>
<span class="nc" id="L1152">        datahandler.getOpenBisClient().getDataSetsOfProjectByIdentifier(projectID);</span>
<span class="nc" id="L1153">    Set&lt;String&gt; factorLabels = datahandler.getFactorLabels();</span>
    
<span class="nc" id="L1155">    Map&lt;Pair&lt;String, String&gt;, Property&gt; factorsForLabelsAndSamples =</span>
<span class="nc" id="L1156">        datahandler.getFactorsForLabelsAndSamples();</span>
<span class="nc" id="L1157">    newGraphContent.loadProjectGraph(projectID, samples, datasets, factorLabels,</span>
        factorsForLabelsAndSamples);
<span class="nc" id="L1159">  }</span>

  /**
   * returns Resource which represents the project graph of the current Bean. Can be set as the
   * resource of an {@link Image}.
   * 
   * @return
   */
  private Resource getGraphResource(String projectID, List&lt;Sample&gt; samples) {
<span class="nc" id="L1168">    Resource resource = null;</span>
    try {
<span class="nc" id="L1170">      GraphGenerator graphFrame =</span>
<span class="nc" id="L1171">          new GraphGenerator(samples, datahandler.getOpenBisClient().getSampleTypes(),</span>
<span class="nc" id="L1172">              datahandler.getOpenBisClient(), projectID);</span>
<span class="nc" id="L1173">      resource = graphFrame.getRes();</span>
<span class="nc" id="L1174">    } catch (IOException e) {</span>
<span class="nc" id="L1175">      LOG.error(&quot;graph creation failed&quot;, e.getStackTrace());</span>
<span class="nc" id="L1176">    }</span>
<span class="nc" id="L1177">    return resource;</span>
  }

  @Override
  public void enter(ViewChangeEvent event) {
<span class="nc" id="L1182">    String currentValue = event.getParameters();</span>
<span class="nc" id="L1183">    OpenBisClient oc = datahandler.getOpenBisClient();</span>
<span class="nc" id="L1184">    List&lt;Project&gt; userProjects = oc.getOpenbisInfoService().listProjectsOnBehalfOfUser(</span>
<span class="nc" id="L1185">        oc.getSessionToken(), PortalUtils.getNonNullScreenName());</span>

<span class="nc" id="L1187">    List&lt;String&gt; projectIDs = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L1189" title="All 2 branches missed.">    for (Project p : userProjects) {</span>
<span class="nc" id="L1190">      projectIDs.add(p.getIdentifier());</span>
<span class="nc" id="L1191">    }</span>

<span class="nc bnc" id="L1193" title="All 2 branches missed.">    if (projectIDs.contains(currentValue)) {</span>
      // TODO updateContent only if currentProject is not equal to newProject
      // this.table.unselect(this.table.getValue());
<span class="nc" id="L1196">      ProjectBean pbean = datahandler.getProject2(currentValue);</span>
      // if the new project bean is different than reset the graph.
<span class="nc bnc" id="L1198" title="All 4 branches missed.">      if (currentBean != null &amp;&amp; !pbean.getId().equals(currentBean.getId())) {</span>
<span class="nc" id="L1199">        resetGraphs();</span>
<span class="nc" id="L1200">        patientViewTab.setSelectedTab(0);</span>
      }
<span class="nc" id="L1202">      this.currentBean = pbean;</span>
      // this.setContainerDataSource(pbean);

<span class="nc" id="L1205">      updateContent();</span>
<span class="nc" id="L1206">    } else {</span>
<span class="nc" id="L1207">      Utils.Notification(&quot;Unable to load project&quot;,</span>
<span class="nc" id="L1208">          String.format(</span>
              &quot;The requested project %s could not be loaded. You probably don't have access to the requested project. Please contact the corresponding project manager or write an email to support@qbic.zendesk.com.&quot;,
              currentValue),
          &quot;error&quot;);
    }

<span class="nc" id="L1214">  }</span>

  public ProjectBean getCurrentBean() {
<span class="nc" id="L1217">    return currentBean;</span>
  }

  public TabSheet getPatientViewTab() {
<span class="nc" id="L1221">    return patientViewTab;</span>
  }

  public void setPatientViewTab(TabSheet patientViewTab) {
<span class="nc" id="L1225">    this.patientViewTab = patientViewTab;</span>
<span class="nc" id="L1226">  }</span>

  public WorkflowComponent getWorkflowComponent() {
<span class="nc" id="L1229">    return workflowComponent;</span>
  }

  public void setWorkflowComponent(WorkflowComponent workflowComponent) {
<span class="nc" id="L1233">    this.workflowComponent = workflowComponent;</span>
<span class="nc" id="L1234">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>