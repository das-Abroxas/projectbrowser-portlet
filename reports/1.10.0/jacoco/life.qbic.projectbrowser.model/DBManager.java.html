<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DBManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ProjectBrowser Portlet</a> &gt; <a href="index.source.html" class="el_package">life.qbic.projectbrowser.model</a> &gt; <span class="el_source">DBManager.java</span></div><h1>DBManager.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * QBiC Project qNavigator enables users to manage their projects. Copyright (C) &quot;2016‚Äù
 * Christopher Mohr, David Wojnar, Andreas Friedrich
 * 
 * This program is free software: you can redistribute it and/or modify it under the terms of the
 * GNU General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License along with this program. If
 * not, see &lt;http://www.gnu.org/licenses/&gt;.
 *******************************************************************************/
package life.qbic.projectbrowser.model;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import life.qbic.projectbrowser.model.userdb.Person;


public class DBManager {
  private DBConfig config;

<span class="nc" id="L37">  private static final Logger LOG = LogManager.getLogger(DBManager.class);</span>

<span class="nc" id="L39">  public DBManager(DBConfig config) {</span>
<span class="nc" id="L40">    this.config = config;</span>
<span class="nc" id="L41">  }</span>

  private void logout(Connection conn) {
    try {
<span class="nc" id="L45">      conn.close();</span>
<span class="nc" id="L46">    } catch (SQLException e) {</span>
      // TODO Auto-generated catch block
<span class="nc" id="L48">      e.printStackTrace();</span>
<span class="nc" id="L49">    }</span>
<span class="nc" id="L50">  }</span>

  private Connection login() {

<span class="nc" id="L54">    String DB_URL =</span>
<span class="nc" id="L55">        &quot;jdbc:mariadb://&quot; + config.getHostname() + &quot;:&quot; + config.getPort() + &quot;/&quot;</span>
<span class="nc" id="L56">            + config.getSql_database();</span>

<span class="nc" id="L58">    Connection conn = null;</span>

    try {
<span class="nc" id="L61">      Class.forName(&quot;org.mariadb.jdbc.Driver&quot;);</span>
<span class="nc" id="L62">      conn = DriverManager.getConnection(DB_URL, config.getUsername(), config.getPassword());</span>
<span class="nc" id="L63">    } catch (Exception e) {</span>
      // TODO Auto-generated catch block
<span class="nc" id="L65">      e.printStackTrace();</span>
<span class="nc" id="L66">    }</span>
<span class="nc" id="L67">    return conn;</span>
  }

  //
  // public void addProjectForPrincipalInvestigator(int pi_id, String projectCode) {
  // String sql = &quot;INSERT INTO projects (pi_id, project_code) VALUES(?, ?)&quot;;
  // Connection conn = login();
  // try (PreparedStatement statement = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS))
  // {
  // statement.setInt(1, pi_id);
  // statement.setString(2, projectCode);
  // statement.execute();
  // // ResultSet rs = statement.getGeneratedKeys();
  // // if (rs.next()) {
  // // rs.getInt(1);
  // // }
  // // nothing will be in the database, until you commit it!
  // conn.commit();
  // } catch (SQLException e) {
  // e.printStackTrace();
  // }
  // logout(conn);
  // }

  public String getInvestigatorForProject(String projectIdentifier) {
<span class="nc" id="L92">    String details = getPersonDetailsForProject(projectIdentifier, &quot;PI&quot;);</span>
<span class="nc" id="L93">    return details.split(&quot;&lt;br&gt;&quot;)[0].trim().replace(&quot;&lt;p&gt;&quot;, &quot;&quot;);</span>
  }

  // TODO
  // should contain name, role for this project and some information for every person
  // public List&lt;Person&gt; getPersonsForProject(String projectIdentifier) {
  //
  // }

  public List&lt;Person&gt; getPersonWithAffiliations(Integer personID) {
<span class="nc" id="L103">    List&lt;Person&gt; res = new ArrayList&lt;Person&gt;();</span>
<span class="nc" id="L104">    String lnk = &quot;persons_organizations&quot;;</span>
<span class="nc" id="L105">    String sql =</span>
        &quot;SELECT persons.*, organizations.*, &quot; + lnk + &quot;.occupation FROM persons, organizations, &quot;
<span class="nc" id="L107">            + lnk + &quot; WHERE persons.id = &quot; + Integer.toString(personID) + &quot; AND persons.id = &quot;</span>
            + lnk + &quot;.person_id and organizations.id = &quot; + lnk + &quot;.organization_id&quot;;
<span class="nc" id="L109">    Connection conn = login();</span>
<span class="nc" id="L110">    try (PreparedStatement statement = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L111">      ResultSet rs = statement.executeQuery();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">      while (rs.next()) {</span>
<span class="nc" id="L113">        int id = rs.getInt(&quot;id&quot;);</span>
<span class="nc" id="L114">        String username = rs.getString(&quot;username&quot;);</span>
<span class="nc" id="L115">        String title = rs.getString(&quot;title&quot;);</span>
<span class="nc" id="L116">        String first = rs.getString(&quot;first_name&quot;);</span>
<span class="nc" id="L117">        String last = rs.getString(&quot;family_name&quot;);</span>
<span class="nc" id="L118">        String eMail = rs.getString(&quot;email&quot;);</span>
<span class="nc" id="L119">        String phone = rs.getString(&quot;phone&quot;);</span>


<span class="nc" id="L122">        int affiliationID = rs.getInt(&quot;organizations.id&quot;);</span>

<span class="nc" id="L124">        String group_acronym = rs.getString(&quot;group_acronym&quot;);</span>
<span class="nc" id="L125">        String group_name = rs.getString(&quot;group_name&quot;);</span>
<span class="nc" id="L126">        String institute = rs.getString(&quot;institute&quot;);</span>
<span class="nc" id="L127">        String organization = rs.getString(&quot;umbrella_organization&quot;);</span>
<span class="nc" id="L128">        String affiliation = &quot;&quot;;</span>

<span class="nc bnc" id="L130" title="All 6 branches missed.">        if (group_name == null || group_name.toUpperCase().equals(&quot;NULL&quot;) || group_name.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L132" title="All 6 branches missed.">          if (institute == null || institute.toUpperCase().equals(&quot;NULL&quot;) || institute.equals(&quot;&quot;)) {</span>
<span class="nc" id="L133">            affiliation = organization;</span>
          } else {
<span class="nc" id="L135">            affiliation = institute;</span>
          }

        } else {
<span class="nc" id="L139">          affiliation = group_name;</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">          if (group_acronym != null &amp;&amp; !group_acronym.isEmpty())</span>
<span class="nc" id="L141">            affiliation += &quot; (&quot; + group_acronym + &quot;)&quot;;</span>
        }

<span class="nc" id="L144">        String role = rs.getString(lnk + &quot;.occupation&quot;);</span>
<span class="nc" id="L145">        res.add(new Person(id, username, title, first, last, eMail, phone, affiliationID,</span>
            affiliation, role));
<span class="nc" id="L147">      }</span>
<span class="nc" id="L148">      statement.close();</span>
<span class="nc" id="L149">    } catch (SQLException e) {</span>
<span class="nc" id="L150">      e.printStackTrace();</span>
<span class="nc" id="L151">    }</span>
<span class="nc" id="L152">    logout(conn);</span>
<span class="nc" id="L153">    return res;</span>
  }

  public String getPersonDetailsForProject(String projectIdentifier, String role) {
<span class="nc" id="L157">    String sql =</span>
        &quot;SELECT projects_persons.*, projects.* FROM projects_persons, projects WHERE projects.openbis_project_identifier = ?&quot;
            + &quot; AND projects.id = projects_persons.project_id AND projects_persons.project_role = ?&quot;;

<span class="nc" id="L161">    int id = -1;</span>

<span class="nc" id="L163">    List&lt;Person&gt; personWithAffiliations = new ArrayList&lt;Person&gt;();</span>

<span class="nc" id="L165">    Connection conn = login();</span>
<span class="nc" id="L166">    try (PreparedStatement statement = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L167">      statement.setString(1, projectIdentifier);</span>
<span class="nc" id="L168">      statement.setString(2, role);</span>

<span class="nc" id="L170">      ResultSet rs = statement.executeQuery();</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">      while (rs.next()) {</span>
<span class="nc" id="L173">        id = rs.getInt(&quot;person_id&quot;);</span>
      }
<span class="nc" id="L175">      personWithAffiliations = getPersonWithAffiliations(id);</span>
<span class="nc" id="L176">    } catch (SQLException e) {</span>
<span class="nc" id="L177">      e.printStackTrace();</span>
<span class="nc" id="L178">      logout(conn);</span>
      // LOG.debug(&quot;Project not associated with Investigator. PI will be set to 'Unknown'&quot;);
<span class="nc" id="L180">    }</span>

<span class="nc" id="L182">    String details = &quot;&quot;;</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">    if (personWithAffiliations.size() &gt; 0) {</span>
<span class="nc" id="L184">      Person p = personWithAffiliations.get(0);</span>
<span class="nc" id="L185">      String institute = p.getOneAffiliationWithRole().getAffiliation();</span>

<span class="nc" id="L187">      String title = &quot;&quot;;</span>

<span class="nc bnc" id="L189" title="All 2 branches missed.">      if (p.getTitle() != null) {</span>
<span class="nc" id="L190">        title = p.getTitle();</span>
      }

<span class="nc" id="L193">      details =</span>
<span class="nc" id="L194">          String.format(&quot;&lt;p&gt;%s %s %s &lt;br&gt; %s &lt;br&gt;&lt;br&gt; %s &lt;br&gt; %s&lt;/p&gt;&quot;, title, p.getFirst(),</span>
<span class="nc" id="L195">              p.getLast(), institute, p.getPhone(), p.geteMail());</span>
      // TODO is address important?
    }

<span class="nc" id="L199">    logout(conn);</span>
<span class="nc" id="L200">    return details;</span>
  }

  public boolean changeLongProjectDescription(String projectIdentifier, String description) {
<span class="nc" id="L204">    LOG.info(&quot;Adding/Updating long description of project &quot; + projectIdentifier);</span>
<span class="nc" id="L205">    boolean saved = saveOldDescription(projectIdentifier);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">    if(! saved)</span>
<span class="nc" id="L207">      LOG.warn(&quot;Could not save old project description to database!&quot;);</span>
<span class="nc" id="L208">    String sql = &quot;UPDATE projects SET long_description = ? WHERE openbis_project_identifier = ?&quot;;</span>
<span class="nc" id="L209">    Connection conn = login();</span>
<span class="nc" id="L210">    PreparedStatement statement = null;</span>
<span class="nc" id="L211">    int res = -1;</span>
    try {
<span class="nc" id="L213">      statement = conn.prepareStatement(sql);</span>
<span class="nc" id="L214">      statement.setString(1, description);</span>
<span class="nc" id="L215">      statement.setString(2, projectIdentifier);</span>
<span class="nc" id="L216">      statement.execute();</span>
<span class="nc" id="L217">      res = statement.getUpdateCount();</span>
<span class="nc" id="L218">      LOG.info(&quot;Successful.&quot;);</span>
<span class="nc" id="L219">    } catch (SQLException e) {</span>
<span class="nc" id="L220">      LOG.error(&quot;SQL operation unsuccessful: &quot; + e.getMessage());</span>
<span class="nc" id="L221">      e.printStackTrace();</span>
    } finally {
<span class="nc" id="L223">      endQuery(conn, statement);</span>
    }
<span class="nc bnc" id="L225" title="All 2 branches missed.">    return res != -1;</span>
  }

  private boolean saveOldDescription(String projectIdentifier) {
<span class="nc" id="L229">    String sql = &quot;SELECT * from projects WHERE openbis_project_identifier = ?&quot;;</span>
<span class="nc" id="L230">    int id = -1;</span>
<span class="nc" id="L231">    String oldDescription = &quot;&quot;;</span>
<span class="nc" id="L232">    String oldTitle = &quot;&quot;;</span>
<span class="nc" id="L233">    Connection conn = login();</span>
<span class="nc" id="L234">    PreparedStatement statement = null;</span>
    try {
<span class="nc" id="L236">      statement = conn.prepareStatement(sql);</span>
<span class="nc" id="L237">      statement.setString(1, projectIdentifier);</span>
<span class="nc" id="L238">      ResultSet rs = statement.executeQuery();</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">      if (rs.next()) {</span>
<span class="nc" id="L240">        id = rs.getInt(&quot;id&quot;);</span>
<span class="nc" id="L241">        oldDescription = rs.getString(&quot;long_description&quot;);</span>
<span class="nc" id="L242">        oldTitle = rs.getString(&quot;short_title&quot;);</span>
      }
<span class="nc" id="L244">    } catch (SQLException e) {</span>
<span class="nc" id="L245">      LOG.error(&quot;SQL operation unsuccessful: &quot; + e.getMessage());</span>
<span class="nc" id="L246">      e.printStackTrace();</span>
<span class="nc" id="L247">    }</span>
<span class="nc" id="L248">    Date date = new Date();</span>
<span class="nc" id="L249">    Timestamp timestamp = new Timestamp(date.getTime());</span>
<span class="nc" id="L250">    sql = &quot;INSERT INTO projects_history (project_id, timestamp, long_description, short_title) VALUES(?, ?, ?, ?)&quot;;</span>
<span class="nc" id="L251">    statement = null;</span>
<span class="nc" id="L252">    int res = -1;</span>
    try {
<span class="nc" id="L254">      statement = conn.prepareStatement(sql);</span>
<span class="nc" id="L255">      statement.setInt(1, id);</span>
<span class="nc" id="L256">      statement.setTimestamp(2, timestamp);</span>
<span class="nc" id="L257">      statement.setString(3, oldDescription);</span>
<span class="nc" id="L258">      statement.setString(4, oldTitle);</span>
<span class="nc" id="L259">      statement.execute();</span>
<span class="nc" id="L260">      res = statement.getUpdateCount();</span>
<span class="nc" id="L261">      LOG.info(&quot;Successful.&quot;);</span>
<span class="nc" id="L262">    } catch (SQLException e) {</span>
<span class="nc" id="L263">      LOG.error(&quot;SQL operation unsuccessful: &quot; + e.getMessage());</span>
<span class="nc" id="L264">      e.printStackTrace();</span>
    } finally {
<span class="nc" id="L266">      endQuery(conn, statement);</span>
    }
<span class="nc bnc" id="L268" title="All 2 branches missed.">    return res != -1;</span>
  }

  private void endQuery(Connection c, PreparedStatement p) {
<span class="nc bnc" id="L272" title="All 2 branches missed.">    if (p != null)</span>
      try {
<span class="nc" id="L274">        p.close();</span>
<span class="nc" id="L275">      } catch (Exception e) {</span>
<span class="nc" id="L276">        LOG.error(&quot;PreparedStatement close problem&quot;);</span>
<span class="nc" id="L277">      }</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">    if (c != null)</span>
      try {
<span class="nc" id="L280">        logout(c);</span>
<span class="nc" id="L281">      } catch (Exception e) {</span>
<span class="nc" id="L282">        LOG.error(&quot;Database Connection close problem&quot;);</span>
<span class="nc" id="L283">      }</span>
<span class="nc" id="L284">  }</span>

  public String getLongProjectDescription(String projectIdentifier) {
<span class="nc" id="L287">    String sql = &quot;SELECT long_description from projects WHERE openbis_project_identifier = ?&quot;;</span>
<span class="nc" id="L288">    String res = &quot;&quot;;</span>
<span class="nc" id="L289">    Connection conn = login();</span>
    try {
<span class="nc" id="L291">      PreparedStatement statement = conn.prepareStatement(sql);</span>
<span class="nc" id="L292">      statement.setString(1, projectIdentifier);</span>
<span class="nc" id="L293">      ResultSet rs = statement.executeQuery();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">      if (rs.next()) {</span>
<span class="nc" id="L295">        res = rs.getString(1);</span>
      }
<span class="nc" id="L297">    } catch (SQLException e) {</span>
<span class="nc" id="L298">      LOG.error(&quot;SQL operation unsuccessful: &quot; + e.getMessage());</span>
<span class="nc" id="L299">      e.printStackTrace();</span>
<span class="nc" id="L300">    }</span>
<span class="nc" id="L301">    logout(conn);</span>
<span class="nc" id="L302">    return res;</span>
  }

  public String getProjectName(String projectIdentifier) {
<span class="nc" id="L306">    String sql = &quot;SELECT short_title from projects WHERE openbis_project_identifier = ?&quot;;</span>
<span class="nc" id="L307">    String res = &quot;&quot;;</span>
<span class="nc" id="L308">    Connection conn = login();</span>
    try {
<span class="nc" id="L310">      PreparedStatement statement = conn.prepareStatement(sql);</span>
<span class="nc" id="L311">      statement.setString(1, projectIdentifier);</span>
<span class="nc" id="L312">      ResultSet rs = statement.executeQuery();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">      if (rs.next()) {</span>
<span class="nc" id="L314">        res = rs.getString(1);</span>
      }
<span class="nc" id="L316">    } catch (SQLException e) {</span>
<span class="nc" id="L317">      LOG.error(&quot;SQL operation unsuccessful: &quot; + e.getMessage());</span>
<span class="nc" id="L318">      e.printStackTrace();</span>
<span class="nc" id="L319">    }</span>
<span class="nc" id="L320">    logout(conn);</span>
<span class="nc" id="L321">    return res;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>