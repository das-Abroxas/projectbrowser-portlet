<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MultiscaleController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ProjectBrowser Portlet</a> &gt; <a href="index.source.html" class="el_package">life.qbic.projectbrowser.controllers</a> &gt; <span class="el_source">MultiscaleController.java</span></div><h1>MultiscaleController.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * QBiC Project qNavigator enables users to manage their projects. Copyright (C) &quot;2016‚Äù Christopher
 * Mohr, David Wojnar, Andreas Friedrich
 *
 * This program is free software: you can redistribute it and/or modify it under the terms of the
 * GNU General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program. If
 * not, see &lt;http://www.gnu.org/licenses/&gt;.
 *******************************************************************************/
package life.qbic.projectbrowser.controllers;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import life.qbic.projectbrowser.model.notes.Note;
import life.qbic.projectbrowser.model.notes.Notes;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.EnumSet;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.xml.bind.JAXBElement;
import javax.xml.bind.JAXBException;
import javax.xml.namespace.QName;

import life.qbic.projectbrowser.helpers.HistoryReader;
import life.qbic.openbis.openbisclient.OpenBisClient;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.Experiment;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.Sample;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.SampleFetchOption;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.SearchCriteria;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.SearchCriteria.MatchClause;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.SearchCriteria.MatchClauseAttribute;
import ch.systemsx.cisd.openbis.generic.shared.dto.EventPE.EntityType;

import com.liferay.portal.kernel.exception.PortalException;
import com.liferay.portal.kernel.exception.SystemException;
import com.liferay.portal.kernel.util.PropsKeys;
import com.liferay.portal.kernel.util.PropsUtil;
import com.liferay.portal.model.Company;
import com.liferay.portal.model.User;
import com.liferay.portal.service.CompanyLocalServiceUtil;
import com.liferay.portal.service.UserLocalServiceUtil;

public class MultiscaleController implements Serializable {

<span class="nc" id="L55">  private static final Logger LOG = LogManager.getLogger(MultiscaleController.class);</span>


  private OpenBisClient openbis;
  private JAXBElement&lt;Notes&gt; jaxbelem;
  private String user;
  private String currentId;
  private String currentCode;

<span class="nc" id="L64">  public MultiscaleController(OpenBisClient openbis, String user) {</span>
<span class="nc" id="L65">    this.openbis = openbis;</span>
<span class="nc" id="L66">    this.user = user;</span>
<span class="nc" id="L67">  }</span>

  /**
   * 
   */
  private static final long serialVersionUID = -8194363636454560096L;

  public boolean isReady() {
<span class="nc bnc" id="L75" title="All 4 branches missed.">    return jaxbelem != null &amp;&amp; jaxbelem.getValue() != null;</span>
  }

  public List&lt;Note&gt; getNotes() {
<span class="nc" id="L79">    return jaxbelem.getValue().getNote();</span>
  }

  public boolean update(String id, EntityType type) {
<span class="nc" id="L83">    jaxbelem = null;</span>
<span class="nc" id="L84">    String xml = null;</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">    if (type.equals(EntityType.EXPERIMENT)) {</span>
<span class="nc" id="L86">      Experiment e = openbis.getExperimentById2(id).get(0);</span>
<span class="nc" id="L87">      xml = e.getProperties().get(&quot;Q_NOTES&quot;);</span>
<span class="nc" id="L88">      currentCode = e.getCode();</span>
<span class="nc" id="L89">    } else {</span>
<span class="nc" id="L90">      EnumSet&lt;SampleFetchOption&gt; fetchOptions = EnumSet.of(SampleFetchOption.PROPERTIES);</span>
<span class="nc" id="L91">      SearchCriteria sc = new SearchCriteria();</span>
<span class="nc" id="L92">      sc.addMatchClause(MatchClause.createAttributeMatch(MatchClauseAttribute.CODE, id));</span>
<span class="nc" id="L93">      List&lt;Sample&gt; samples = openbis.getOpenbisInfoService()</span>
<span class="nc" id="L94">          .searchForSamplesOnBehalfOfUser(openbis.getSessionToken(), sc, fetchOptions, &quot;admin&quot;);</span>
<span class="nc bnc" id="L95" title="All 4 branches missed.">      if (samples != null &amp;&amp; samples.size() == 1) {</span>
<span class="nc" id="L96">        Sample sample = samples.get(0);</span>
<span class="nc" id="L97">        currentCode = sample.getCode();</span>
<span class="nc" id="L98">        xml = sample.getProperties().get(&quot;Q_NOTES&quot;);</span>
      }
    }
    try {
<span class="nc bnc" id="L102" title="All 2 branches missed.">      if (xml != null) {</span>
<span class="nc" id="L103">        jaxbelem = HistoryReader.parseNotes(xml);</span>
      } else {
<span class="nc" id="L105">        jaxbelem = new JAXBElement&lt;Notes&gt;(new QName(&quot;&quot;), Notes.class, new Notes());</span>
      }
<span class="nc" id="L107">      currentId = id;</span>
<span class="nc" id="L108">      return true;</span>
<span class="nc" id="L109">    } catch (IndexOutOfBoundsException | JAXBException | NullPointerException e) {</span>
<span class="nc" id="L110">      currentId = null;</span>
<span class="nc" id="L111">      currentCode = null;</span>
<span class="nc" id="L112">      LOG.error(&quot;Error parsing XML&quot;);</span>
<span class="nc" id="L113">      e.printStackTrace();</span>
    }
<span class="nc" id="L115">    return false;</span>
  }

//  public BeanItemContainer&lt;Note&gt; getContainer() {
//    BeanItemContainer&lt;Note&gt; container = new BeanItemContainer&lt;Note&gt;(Note.class);
//    container.addAll(getNotes());
//    return container;
//  }

  public String getUser() {
    // TODO Auto-generated method stub
<span class="nc" id="L126">    return user;</span>
  }

  public boolean addNote(Note note) {
<span class="nc bnc" id="L130" title="All 2 branches missed.">    if (currentId != null) {</span>
<span class="nc" id="L131">      jaxbelem.getValue().getNote().add(note);</span>
<span class="nc" id="L132">      Map&lt;String, Object&gt; params = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L133">      params.put(&quot;id&quot;, currentId);</span>
<span class="nc" id="L134">      params.put(&quot;user&quot;, note.getUsername());</span>
<span class="nc" id="L135">      params.put(&quot;comment&quot;, note.getComment());</span>
<span class="nc" id="L136">      params.put(&quot;time&quot;, note.getTime());</span>
<span class="nc" id="L137">      openbis.ingest(&quot;DSS1&quot;, &quot;add-to-xml-note&quot;, params);</span>
<span class="nc" id="L138">      return true;</span>
    }
<span class="nc" id="L140">    return false;</span>
  }

  public String getcurrentCode() {
<span class="nc" id="L144">    return currentCode;</span>
  }

  public List&lt;String&gt; getSearchResults(String samplecode) {
<span class="nc" id="L148">    EnumSet&lt;SampleFetchOption&gt; fetchOptions = EnumSet.of(SampleFetchOption.PROPERTIES);</span>
<span class="nc" id="L149">    SearchCriteria sc = new SearchCriteria();</span>
<span class="nc" id="L150">    sc.addMatchClause(</span>
<span class="nc" id="L151">        MatchClause.createAttributeMatch(MatchClauseAttribute.CODE, samplecode + &quot;*&quot;));</span>
<span class="nc" id="L152">    List&lt;Sample&gt; samples = openbis.getOpenbisInfoService()</span>
<span class="nc" id="L153">        .searchForSamplesOnBehalfOfUser(openbis.getSessionToken(), sc, fetchOptions, user);</span>
<span class="nc" id="L154">    List&lt;String&gt; ret = new ArrayList&lt;String&gt;(samples.size());</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">    for (Sample sample : samples) {</span>
<span class="nc" id="L156">      ret.add(sample.getCode());</span>
<span class="nc" id="L157">    }</span>
<span class="nc" id="L158">    return ret;</span>
  }

  public String getLiferayUser(String userID) {
<span class="nc" id="L162">    Company company = null;</span>
<span class="nc" id="L163">    long companyId = 1;</span>
<span class="nc" id="L164">    String userString = &quot;&quot;;</span>
    try {
<span class="nc" id="L166">      String webId = PropsUtil.get(PropsKeys.COMPANY_DEFAULT_WEB_ID);</span>
<span class="nc" id="L167">      company = CompanyLocalServiceUtil.getCompanyByWebId(webId);</span>
<span class="nc" id="L168">      companyId = company.getCompanyId();</span>
<span class="nc" id="L169">      LOG.debug(</span>
<span class="nc" id="L170">          String.format(&quot;Using webId %s and companyId %d to get Portal User&quot;, webId, companyId));</span>
<span class="nc" id="L171">    } catch (PortalException | SystemException e) {</span>
<span class="nc" id="L172">      LOG</span>
<span class="nc" id="L173">          .error(&quot;liferay error, could not retrieve companyId. Trying default companyId, which is &quot;</span>
<span class="nc" id="L174">              + companyId, e.getStackTrace());</span>
<span class="nc" id="L175">    }</span>

<span class="nc" id="L177">    User user = null;</span>
    try {
<span class="nc" id="L179">      user = UserLocalServiceUtil.getUserByScreenName(companyId, userID);</span>
<span class="nc" id="L180">    } catch (PortalException | SystemException e) {</span>
<span class="nc" id="L181">    }</span>

<span class="nc bnc" id="L183" title="All 2 branches missed.">    if (user == null) {</span>
<span class="nc" id="L184">      LOG.warn(String.format(&quot;Openbis user %s appears to not exist in Portal&quot;, userID));</span>
<span class="nc" id="L185">      userString = userID;</span>
    } else {
<span class="nc" id="L187">      String fullname = user.getFullName();</span>
<span class="nc" id="L188">      String email = user.getEmailAddress();</span>
<span class="nc" id="L189">      userString += (&quot;&lt;a href=\&quot;mailto:&quot;);</span>
<span class="nc" id="L190">      userString += (email);</span>
<span class="nc" id="L191">      userString += (&quot;\&quot; style=\&quot;color: #0068AA; text-decoration: none\&quot;&gt;&quot;);</span>
<span class="nc" id="L192">      userString += (fullname);</span>
<span class="nc" id="L193">      userString += (&quot;&lt;/a&gt;&quot;);</span>
    }
<span class="nc" id="L195">    return userString;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>