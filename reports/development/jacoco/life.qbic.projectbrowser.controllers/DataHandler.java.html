<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ProjectBrowser Portlet</a> &gt; <a href="index.source.html" class="el_package">life.qbic.projectbrowser.controllers</a> &gt; <span class="el_source">DataHandler.java</span></div><h1>DataHandler.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * QBiC Project qNavigator enables users to manage their projects. Copyright (C) &quot;2016‚Äù Christopher
 * Mohr, David Wojnar, Andreas Friedrich
 * 
 * This program is free software: you can redistribute it and/or modify it under the terms of the
 * GNU General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License along with this program. If
 * not, see &lt;http://www.gnu.org/licenses/&gt;.
 *******************************************************************************/
package life.qbic.projectbrowser.controllers;

import java.io.Serializable;
import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import javax.xml.bind.JAXBElement;
import javax.xml.bind.JAXBException;

import life.qbic.portal.utils.PortalUtils;

import org.apache.commons.lang3.tuple.Pair;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.data.util.HierarchicalContainer;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.server.FontAwesome;
import com.vaadin.server.ThemeResource;
import com.vaadin.shared.ui.label.ContentMode;
import com.vaadin.ui.CheckBox;
import com.vaadin.ui.Label;
import com.vaadin.ui.ProgressBar;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.themes.ValoTheme;

import ch.systemsx.cisd.openbis.dss.client.api.v1.DataSet;
import ch.systemsx.cisd.openbis.dss.generic.shared.api.v1.FileInfoDssDTO;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.ControlledVocabularyPropertyType;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.Experiment;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.Material;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.MaterialIdentifier;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.MaterialTypeIdentifier;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.Project;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.PropertyType;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.Sample;
import ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.SpaceWithProjectsAndRoleAssignments;
import ch.systemsx.cisd.openbis.plugin.query.shared.api.v1.dto.QueryTableModel;
import life.qbic.datamodel.experiments.ExperimentType;
import life.qbic.datamodel.identifiers.ExperimentCodeFunctions;
import life.qbic.openbis.openbisclient.OpenBisClient;

import life.qbic.projectbrowser.helpers.Utils;
import life.qbic.projectbrowser.helpers.OpenBisFunctions;
import life.qbic.projectbrowser.helpers.BarcodeFunctions;
import life.qbic.projectbrowser.model.DatasetBean;
import life.qbic.projectbrowser.model.ExperimentBean;
import life.qbic.projectbrowser.model.ExperimentStatusBean;
import life.qbic.projectbrowser.model.NewIvacSampleBean;
import life.qbic.projectbrowser.model.SampleBean;
import life.qbic.projectbrowser.model.ProjectBean;
import life.qbic.projectbrowser.model.DBManager;
import life.qbic.projectbrowser.helpers.AlternativeSecondaryNameCreator;

import life.qbic.xml.persons.Qperson;
import life.qbic.xml.properties.Property;
import life.qbic.xml.study.Qexperiment;
import life.qbic.xml.manager.PersonParser;
import life.qbic.xml.manager.StudyXMLParser;


public class DataHandler implements Serializable {


  /**
   * 
   */
  private static final long serialVersionUID = -4814000017404997233L;
<span class="nc" id="L99">  private static final Logger LOG = LogManager.getLogger(DataHandler.class);</span>

  // Map&lt;String, SpaceInformation&gt; spaces = new HashMap&lt;String, SpaceInformation&gt;();
  // Map&lt;String, ProjectInformation&gt; projectInformations = new HashMap&lt;String,
  // ProjectInformation&gt;();
  // Map&lt;String, ExperimentInformation&gt; experimentInformations =
  // new HashMap&lt;String, ExperimentInformation&gt;();
  // Map&lt;String, SampleInformation&gt; sampleInformations = new HashMap&lt;String, SampleInformation&gt;();
  // Map&lt;String, ProjectBean&gt; projectMap = new HashMap&lt;String, ProjectBean&gt;();
  // Map&lt;String, ExperimentBean&gt; experimentMap = new HashMap&lt;String, ExperimentBean&gt;();
<span class="nc" id="L109">  Map&lt;String, SampleBean&gt; sampleMap = new HashMap&lt;String, SampleBean&gt;();</span>
<span class="nc" id="L110">  Map&lt;String, DatasetBean&gt; datasetMap = new HashMap&lt;String, DatasetBean&gt;();</span>

<span class="nc" id="L112">  Map&lt;String, String&gt; spaceToProjectPrefixMap = new HashMap&lt;String, String&gt;();</span>


  // store search result containers here
<span class="nc" id="L116">  List&lt;Sample&gt; sampleResults = new ArrayList&lt;Sample&gt;();</span>
<span class="nc" id="L117">  List&lt;Experiment&gt; expResults = new ArrayList&lt;Experiment&gt;();</span>
<span class="nc" id="L118">  List&lt;Project&gt; projResults = new ArrayList&lt;Project&gt;();</span>

<span class="nc" id="L120">  List&lt;String&gt; showOptions = Arrays.asList(&quot;Projects&quot;, &quot;Experiments&quot;, &quot;Samples&quot;);</span>


<span class="nc" id="L123">  String lastQueryString = new String();</span>


<span class="nc" id="L126">  List&lt;SpaceWithProjectsAndRoleAssignments&gt; space_list = null;</span>
  // Map&lt;String, IndexedContainer&gt; connectedPersons = new HashMap&lt;String, IndexedContainer&gt;();
<span class="nc" id="L128">  IndexedContainer connectedPersons = new IndexedContainer();</span>

  // Map&lt;String, IndexedContainer&gt; space_to_projects = new HashMap&lt;String, IndexedContainer&gt;();
  //
  // Map&lt;String, IndexedContainer&gt; space_to_experiments = new HashMap&lt;String, IndexedContainer&gt;();
  // Map&lt;String, IndexedContainer&gt; project_to_experiments = new HashMap&lt;String, IndexedContainer&gt;();
  //
  // Map&lt;String, IndexedContainer&gt; space_to_samples = new HashMap&lt;String, IndexedContainer&gt;();
  // Map&lt;String, IndexedContainer&gt; project_to_samples = new HashMap&lt;String, IndexedContainer&gt;();
  // Map&lt;String, IndexedContainer&gt; experiment_to_samples = new HashMap&lt;String, IndexedContainer&gt;();

  // Map&lt;String, HierarchicalContainer&gt; space_to_datasets =
  // new HashMap&lt;String, HierarchicalContainer&gt;();
  // Map&lt;String, HierarchicalContainer&gt; project_to_datasets =
  // new HashMap&lt;String, HierarchicalContainer&gt;();
  // Map&lt;String, HierarchicalContainer&gt; experiment_to_datasets =
  // new HashMap&lt;String, HierarchicalContainer&gt;();
  // Map&lt;String, HierarchicalContainer&gt; sample_to_datasets =
  // new HashMap&lt;String, HierarchicalContainer&gt;();

  public List&lt;Sample&gt; getSampleResults() {
<span class="nc" id="L149">    return sampleResults;</span>
  }


  public void setSampleResults(List&lt;Sample&gt; sampleResults) {
<span class="nc" id="L154">    this.sampleResults = sampleResults;</span>
<span class="nc" id="L155">  }</span>


  public List&lt;Experiment&gt; getExpResults() {
<span class="nc" id="L159">    return expResults;</span>
  }


  public void setExpResults(List&lt;Experiment&gt; expResults) {
<span class="nc" id="L164">    this.expResults = expResults;</span>
<span class="nc" id="L165">  }</span>

  public List&lt;Project&gt; getProjResults() {
<span class="nc" id="L168">    return projResults;</span>
  }


  public void setProjResults(List&lt;Project&gt; projResults) {
<span class="nc" id="L173">    this.projResults = projResults;</span>
<span class="nc" id="L174">  }</span>

  public List&lt;String&gt; getShowOptions() {
<span class="nc" id="L177">    return showOptions;</span>
  }


  public void setShowOptions(List&lt;String&gt; showOptions) {
<span class="nc" id="L182">    this.showOptions = showOptions;</span>
<span class="nc" id="L183">  }</span>

  public String getLastQueryString() {
<span class="nc" id="L186">    return lastQueryString;</span>
  }


  public void setLastQueryString(String lastQueryString) {
<span class="nc" id="L191">    this.lastQueryString = lastQueryString;</span>
<span class="nc" id="L192">  }</span>



  public List&lt;SpaceWithProjectsAndRoleAssignments&gt; getSpacesWithProjectInformation() {
<span class="nc bnc" id="L197" title="All 2 branches missed.">    if (space_list == null) {</span>
<span class="nc" id="L198">      space_list = this.getOpenBisClient().getFacade().getSpacesWithProjects();</span>
    }

<span class="nc" id="L201">    return space_list;</span>
  }

  private OpenBisClient openBisClient;
  private DBManager databaseManager;

<span class="nc" id="L207">  private Map&lt;String, Project&gt; dtoProjects = new HashMap&lt;String, Project&gt;();</span>
  // private Map&lt;String, Experiment&gt; dtoExperiments = new HashMap&lt;String, Experiment&gt;();
<span class="nc" id="L209">  private StudyXMLParser studyParser = new StudyXMLParser();</span>
  private Set&lt;String&gt; experimentalFactorLabels;
  private Map&lt;Pair&lt;String, String&gt;, Property&gt; experimentalFactorsForLabelsAndSamples;
  private Map&lt;String, List&lt;Property&gt;&gt; propertiesForSamples;
  private JAXBElement&lt;Qexperiment&gt; experimentalSetup;

<span class="nc" id="L215">  public DataHandler(OpenBisClient client, DBManager databaseManager) {</span>
    // reset(); //TODO useless?
<span class="nc" id="L217">    this.setOpenBisClient(client);</span>
<span class="nc" id="L218">    this.setDatabaseManager(databaseManager);</span>
<span class="nc" id="L219">  }</span>


  // // id in this case meaning the openBIS instance ?!
  // public SpaceInformation getSpace(String identifier) throws Exception {
  //
  // List&lt;SpaceWithProjectsAndRoleAssignments&gt; space_list = null;
  // SpaceInformation spaces = null;
  //
  // if (this.spaces.get(identifier) != null) {
  // return this.spaces.get(identifier);
  // }
  //
  // else if (this.spaces.get(identifier) == null) {
  // space_list = this.getSpacesWithProjectInformation();
  // spaces = this.createSpaceContainer(space_list, identifier);
  //
  // this.spaces.put(identifier, spaces);
  // }
  //
  // else {
  // throw new Exception(&quot;Unknown Space: &quot; + identifier + &quot;. Method DataHandler::getSpace.&quot;);
  // }
  //
  // return spaces;
  //
  // }

  private Date parseDate(String dateString) {
<span class="nc" id="L248">    Date date = null;</span>
<span class="nc" id="L249">    SimpleDateFormat formatter = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
    try {
<span class="nc" id="L251">      date = formatter.parse(dateString.split(&quot;\\+&quot;)[0]);</span>

<span class="nc" id="L253">    } catch (ParseException e) {</span>
<span class="nc" id="L254">      e.printStackTrace();</span>
<span class="nc" id="L255">    }</span>
<span class="nc" id="L256">    return date;</span>
  }

  /**
   * 
   * @param datasets List of dataset codes
   * @return A list of DatasetBeans denoting the roots of the folder structure of each dataset.
   *         Subfolders and files can be reached by calling the getChildren() function on each Bean.
   */
  public List&lt;DatasetBean&gt; queryDatasetsForFolderStructure(
      List&lt;ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.DataSet&gt; datasets) {
<span class="nc" id="L267">    Map&lt;String, List&lt;String&gt;&gt; params = new HashMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L268">    List&lt;String&gt; dsCodes = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L269">    Map&lt;String, String&gt; types = new HashMap&lt;String, String&gt;();</span>

<span class="nc" id="L271">    Map&lt;String, Map&lt;String, String&gt;&gt; props = new LinkedHashMap&lt;String, Map&lt;String, String&gt;&gt;();</span>

<span class="nc bnc" id="L273" title="All 2 branches missed.">    for (ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.DataSet ds : datasets) {</span>
<span class="nc" id="L274">      dsCodes.add(ds.getCode());</span>
<span class="nc" id="L275">      types.put(ds.getCode(), ds.getDataSetTypeCode());</span>
<span class="nc" id="L276">      props.put(ds.getCode(), ds.getProperties());</span>
<span class="nc" id="L277">    }</span>

<span class="nc" id="L279">    params.put(&quot;codes&quot;, dsCodes);</span>
<span class="nc" id="L280">    QueryTableModel res = getOpenBisClient().queryFileInformation(params);</span>

    // TODO this should work, but here starts the new code in case it doesn't 07.08.15 - Andreas
<span class="nc" id="L283">    Map&lt;String, List&lt;DatasetBean&gt;&gt; folderStructure = new HashMap&lt;String, List&lt;DatasetBean&gt;&gt;();</span>
<span class="nc" id="L284">    Map&lt;String, DatasetBean&gt; fileNames = new HashMap&lt;String, DatasetBean&gt;();</span>
    // Set&lt;DatasetBean&gt; folders = new HashSet&lt;DatasetBean&gt;();

<span class="nc bnc" id="L287" title="All 2 branches missed.">    for (Serializable[] ss : res.getRows()) {</span>

<span class="nc" id="L289">      DatasetBean b = new DatasetBean();</span>
<span class="nc" id="L290">      String dsCode = (String) ss[0];</span>
<span class="nc" id="L291">      String fileName = (String) ss[2];</span>
<span class="nc" id="L292">      String dssPath = (String) ss[1];</span>
<span class="nc" id="L293">      b.setCode(dsCode);</span>
<span class="nc" id="L294">      b.setType(types.get(dsCode));</span>
<span class="nc" id="L295">      b.setFileName(fileName);</span>
<span class="nc" id="L296">      b.setDssPath(dssPath);</span>
<span class="nc" id="L297">      long size = (Long) ss[3];</span>
<span class="nc" id="L298">      b.setFileSize(size);</span>
<span class="nc" id="L299">      b.setRegistrationDate(parseDate((String) ss[5]));</span>
<span class="nc" id="L300">      b.setProperties(props.get(dsCode));</span>

      // both code and filename are needed for the keys to be unique
      // fileNames.put(dsCode + fileName, b);
<span class="nc" id="L304">      fileNames.put(dsCode + dssPath, b);</span>

      // store file beans under their respective code+folder, except those with &quot;original&quot;
      // String folderKey = (String) ss[4];
      // safest way to be unique: folder is dss path without the last part of the path (&quot;original&quot;
      // isn't changed)
<span class="nc" id="L310">      String folderKey = dssPath;</span>
<span class="nc bnc" id="L311" title="All 4 branches missed.">      if (null != dssPath &amp;&amp; dssPath.length() &gt; 0) {</span>
<span class="nc" id="L312">        int endIndex = dssPath.lastIndexOf(&quot;/&quot;);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (endIndex != -1) {</span>
<span class="nc" id="L314">          folderKey = dssPath.substring(0, endIndex); // not forgot to put check if(endIndex !=</span>
                                                      // -1)
        }
      }
      // LOG.debug(&quot;full path &quot; + b.getDssPath());
<span class="nc bnc" id="L319" title="All 2 branches missed.">      if (!folderKey.equals(&quot;original&quot;))</span>
<span class="nc" id="L320">        folderKey = dsCode + folderKey;</span>
      // LOG.debug(&quot;folder key: &quot; + folderKey);
      // folder known, add this file to folder
<span class="nc bnc" id="L323" title="All 2 branches missed.">      if (folderStructure.containsKey(folderKey)) {</span>
<span class="nc" id="L324">        folderStructure.get(folderKey).add(b);</span>
      } else {
        // folder unknown, create new folder with dataset list containing this file
<span class="nc" id="L327">        List&lt;DatasetBean&gt; inFolder = new ArrayList&lt;DatasetBean&gt;();</span>
<span class="nc" id="L328">        inFolder.add(b);</span>
<span class="nc" id="L329">        folderStructure.put(folderKey, inFolder);</span>
      }
<span class="nc" id="L331">    }</span>
    // System.out.println(&quot;known folders with data: &quot; + folderStructure.size());
    // System.out.println(&quot;known fileNames: &quot; + fileNames.size());
    // for (String folder : folderStructure.keySet()) {
    // System.out.println(folder + &quot; contains &quot; + folderStructure.get(folder).size() + &quot; files&quot;);
    // }
    // find children samples for our folders
<span class="nc bnc" id="L338" title="All 2 branches missed.">    for (String fileNameKey : fileNames.keySet()) {</span>
      // if the fileNameKey is in our folder map we have found a folder (not a file and not the
      // &quot;original&quot; folder)
<span class="nc bnc" id="L341" title="All 2 branches missed.">      if (folderStructure.containsKey(fileNameKey)) {</span>
        // and we add the files to this folder bean
        // System.out.println(&quot;filekey: &quot; + fileNameKey);
<span class="nc" id="L344">        List&lt;DatasetBean&gt; children = folderStructure.get(fileNameKey);</span>
        // if (children == null)
        // System.out.println(&quot;no subfiles for this key&quot;);
        // else
        // System.out.println(children.size() + &quot; subfiles&quot;);
<span class="nc" id="L349">        fileNames.get(fileNameKey).setChildren(children);</span>
        // System.out.println(fileNames.get(fileNameKey).getChildren());
      }
<span class="nc" id="L352">    }</span>
    // System.out.println(&quot;first ds in original:&quot;);
    // DatasetBean ds = folderStructure.get(&quot;original&quot;).get(0);
    // System.out.println(ds);
    // System.out.println(&quot;subfolders:&quot;);
    // System.out.println(ds.getChildren());
    // Now the structure should be set up. Root structures have &quot;original&quot; as parent folder
<span class="nc" id="L359">    List&lt;DatasetBean&gt; roots = folderStructure.get(&quot;original&quot;);</span>
    // Remove empty folders
<span class="nc" id="L361">    List&lt;DatasetBean&gt; level = roots;</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">    while (!level.isEmpty()) {</span>
<span class="nc" id="L363">      List&lt;DatasetBean&gt; collect = new ArrayList&lt;DatasetBean&gt;();</span>
<span class="nc" id="L364">      List&lt;DatasetBean&gt; toRemove = new ArrayList&lt;DatasetBean&gt;();</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">      for (DatasetBean b : level) {</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if (b.hasChildren()) {</span>
          // collect subfolders + files for recursion
<span class="nc" id="L368">          collect.addAll(b.getChildren());</span>
        } else {
          // no subfolders or files and empty? remove from this folder level
<span class="nc bnc" id="L371" title="All 2 branches missed.">          if (b.getFileSize() == 0) {</span>
<span class="nc" id="L372">            toRemove.add(b);</span>
          }
        }
<span class="nc" id="L375">      }</span>
<span class="nc" id="L376">      level.removeAll(toRemove);</span>
<span class="nc" id="L377">      level = collect;</span>
<span class="nc" id="L378">    }</span>
<span class="nc" id="L379">    LOG.debug(fileNames.size() + &quot; files found&quot;);</span>
<span class="nc" id="L380">    LOG.debug(folderStructure.size() + &quot; folders found&quot;);</span>
<span class="nc" id="L381">    LOG.debug(roots.size() + &quot; root folders&quot;);</span>
<span class="nc" id="L382">    int annoyanceCount = 5;</span>
<span class="nc" id="L383">    LOG.debug(&quot;subfiles for the first 5 root folders: &quot;);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">    for (DatasetBean b : roots) {</span>
<span class="nc" id="L385">      annoyanceCount--;</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">      if (annoyanceCount &gt; 0) {</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (b.hasChildren())</span>
<span class="nc" id="L388">          LOG.debug(&quot;root has attached subfiles: &quot; + b.getChildren().size());</span>
      }
<span class="nc" id="L390">    }</span>
<span class="nc" id="L391">    return roots;</span>
  }

  // Recursively get all samples which are above the corresponding sample in the tree
  public List&lt;DatasetBean&gt; getAllFiles(List&lt;DatasetBean&gt; found, DatasetBean root) {
<span class="nc" id="L396">    List&lt;DatasetBean&gt; current = root.getChildren();</span>

<span class="nc bnc" id="L398" title="All 2 branches missed.">    if (current == null) {</span>
<span class="nc" id="L399">      found.add(root);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">    } else if (current.size() == 0) {</span>
<span class="nc" id="L401">      found.add(root);</span>

    } else {
<span class="nc bnc" id="L404" title="All 2 branches missed.">      for (int i = 0; i &lt; current.size(); i++) {</span>
<span class="nc" id="L405">        getAllFiles(found, current.get(i));</span>
      }
    }
<span class="nc" id="L408">    return found;</span>
  }


  public List&lt;DatasetBean&gt; queryDatasetsForFiles(
      List&lt;ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.DataSet&gt; datasets) {
<span class="nc" id="L414">    List&lt;DatasetBean&gt; results = new ArrayList&lt;DatasetBean&gt;();</span>

<span class="nc bnc" id="L416" title="All 2 branches missed.">    if (datasets.size() &gt; 0) {</span>
<span class="nc" id="L417">      List&lt;DatasetBean&gt; roots = queryDatasetsForFolderStructure(datasets);</span>

<span class="nc bnc" id="L419" title="All 2 branches missed.">      for (DatasetBean ds : roots) {</span>
<span class="nc" id="L420">        List&lt;DatasetBean&gt; startList = new ArrayList&lt;DatasetBean&gt;();</span>
<span class="nc" id="L421">        results.addAll(getAllFiles(startList, ds));</span>
<span class="nc" id="L422">      }</span>
    }

<span class="nc" id="L425">    return results;</span>
  }

  // /**
  // * Method to get Bean from either openbis identifier or openbis object. Checks if corresponding
  // * bean is already stored in datahandler map.
  // *
  // * @param
  // * @return
  // */
  // @Deprecated
  // public ProjectBean getProject(Object proj) {
  // Project project;
  // ProjectBean newProjectBean;
  // // System.out.println(proj);
  // // System.out.println(this.projectMap);
  //
  // if (proj instanceof Project) {
  // project = (Project) proj;
  // newProjectBean = this.createProjectBean(project);
  // this.projectMap.put(newProjectBean.getId(), newProjectBean);
  // } else {
  // if (this.projectMap.get((String) proj) != null) {
  //
  // newProjectBean = this.projectMap.get(proj);
  // } else {
  // project = this.getOpenBisClient().getProjectByIdentifier((String) proj);
  // newProjectBean = this.createProjectBean(project);
  // this.projectMap.put(newProjectBean.getId(), newProjectBean);
  // }
  // }
  // return newProjectBean;
  // }

  /**
   * Method to get Bean from either openbis identifier or openbis object. Does NOT check if
   * corresponding bean is already stored in datahandler map. Should be used if project instance has
   * been modified from session
   * 
   * @param
   * @return
   */
  public ProjectBean getProjectFromDB(String projectIdentifier) {
<span class="nc" id="L468">    List&lt;Experiment&gt; experiments =</span>
<span class="nc" id="L469">        this.getOpenBisClient().getExperimentsForProject2(projectIdentifier);</span>

<span class="nc" id="L471">    float projectStatus = this.getOpenBisClient().computeProjectStatus(experiments);</span>

<span class="nc" id="L473">    Project project = getOpenBisClient().getProjectByIdentifier(projectIdentifier);</span>
<span class="nc" id="L474">    dtoProjects.put(projectIdentifier, project);</span>

<span class="nc" id="L476">    ProjectBean newProjectBean = new ProjectBean();</span>

<span class="nc" id="L478">    ProgressBar progressBar = new ProgressBar();</span>
<span class="nc" id="L479">    progressBar.setValue(projectStatus);</span>

<span class="nc" id="L481">    Date registrationDate = project.getRegistrationDetails().getRegistrationDate();</span>

    // String pi = getDatabaseManager().getInvestigatorDetailsForProject(project.getCode());
<span class="nc" id="L484">    String pi = getDatabaseManager().getPersonDetailsForProject(project.getIdentifier(), &quot;PI&quot;);</span>
<span class="nc" id="L485">    String cp = getDatabaseManager().getPersonDetailsForProject(project.getIdentifier(), &quot;Contact&quot;);</span>
    // String manager = getDatabaseManager().getPersonDetailsForProject(project.getIdentifier(),
    // &quot;Manager&quot;);//TODO
<span class="nc" id="L488">    String manager = &quot;&quot;;</span>
<span class="nc" id="L489">    String longDesc = getDatabaseManager().getLongProjectDescription(project.getIdentifier());</span>

<span class="nc bnc" id="L491" title="All 2 branches missed.">    if (pi.equals(&quot;&quot;)) {</span>
<span class="nc" id="L492">      newProjectBean.setPrincipalInvestigator(&quot;n/a&quot;);</span>
    } else {
<span class="nc" id="L494">      newProjectBean.setPrincipalInvestigator(pi);</span>
    }

<span class="nc bnc" id="L497" title="All 2 branches missed.">    if (cp.equals(&quot;&quot;)) {</span>
<span class="nc" id="L498">      newProjectBean.setContactPerson(&quot;n/a&quot;);</span>
    } else {
<span class="nc" id="L500">      newProjectBean.setContactPerson(cp);</span>
    }

<span class="nc bnc" id="L503" title="All 2 branches missed.">    if (manager.equals(&quot;&quot;)) {</span>
<span class="nc" id="L504">      newProjectBean.setProjectManager(&quot;n/a&quot;);</span>
    } else {
<span class="nc" id="L506">      newProjectBean.setProjectManager(manager);</span>
    }

<span class="nc" id="L509">    String secondaryName = getDatabaseManager().getProjectName(projectIdentifier);</span>
<span class="nc bnc" id="L510" title="All 4 branches missed.">    if (secondaryName == null || secondaryName.isEmpty())</span>
<span class="nc" id="L511">      secondaryName = &quot;n/a&quot;;</span>
<span class="nc" id="L512">    newProjectBean.setSecondaryName(secondaryName);</span>

<span class="nc bnc" id="L514" title="All 2 branches missed.">    if (longDesc == null)</span>
<span class="nc" id="L515">      longDesc = &quot;&quot;;</span>

<span class="nc" id="L517">    newProjectBean.setId(project.getIdentifier());</span>
<span class="nc" id="L518">    newProjectBean.setCode(project.getCode());</span>
<span class="nc" id="L519">    String desc = project.getDescription();</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">    if (desc == null)</span>
<span class="nc" id="L521">      desc = &quot;&quot;;</span>
<span class="nc" id="L522">    newProjectBean.setDescription(desc);</span>
<span class="nc" id="L523">    newProjectBean.setRegistrationDate(registrationDate);</span>
<span class="nc" id="L524">    newProjectBean.setProgress(progressBar);</span>
<span class="nc" id="L525">    newProjectBean.setRegistrator(project.getRegistrationDetails().getUserId());</span>
<span class="nc" id="L526">    newProjectBean.setContact(project.getRegistrationDetails().getUserEmail());</span>

<span class="nc" id="L528">    BeanItemContainer&lt;ExperimentBean&gt; experimentBeans =</span>
        new BeanItemContainer&lt;ExperimentBean&gt;(ExperimentBean.class);

<span class="nc bnc" id="L531" title="All 2 branches missed.">    for (Experiment experiment : experiments) {</span>
<span class="nc" id="L532">      ExperimentBean newExperimentBean = new ExperimentBean();</span>
<span class="nc" id="L533">      String status = &quot;&quot;;</span>

<span class="nc" id="L535">      Map&lt;String, String&gt; assignedProperties = experiment.getProperties();</span>

<span class="nc bnc" id="L537" title="All 2 branches missed.">      if (assignedProperties.keySet().contains(&quot;Q_CURRENT_STATUS&quot;)) {</span>
<span class="nc" id="L538">        status = assignedProperties.get(&quot;Q_CURRENT_STATUS&quot;);</span>
      }

<span class="nc bnc" id="L541" title="All 2 branches missed.">      else if (assignedProperties.keySet().contains(&quot;Q_WF_STATUS&quot;)) {</span>
<span class="nc" id="L542">        status = assignedProperties.get(&quot;Q_WF_STATUS&quot;);</span>
      }

      // Image statusColor = new Image(status, this.setExperimentStatusColor(status));
      // statusColor.setWidth(&quot;15px&quot;);
      // statusColor.setHeight(&quot;15px&quot;);
      // statusColor.setCaption(status);

<span class="nc" id="L550">      newExperimentBean.setId(experiment.getIdentifier());</span>
<span class="nc" id="L551">      newExperimentBean.setCode(experiment.getCode());</span>
<span class="nc" id="L552">      newExperimentBean.setType(experiment.getExperimentTypeCode());</span>
<span class="nc" id="L553">      newExperimentBean.setStatus(status);</span>
<span class="nc" id="L554">      newExperimentBean.setRegistrator(experiment.getRegistrationDetails().getUserId());</span>
<span class="nc" id="L555">      newExperimentBean</span>
<span class="nc" id="L556">          .setRegistrationDate(experiment.getRegistrationDetails().getRegistrationDate());</span>
<span class="nc" id="L557">      experimentBeans.addBean(newExperimentBean);</span>
<span class="nc" id="L558">    }</span>

<span class="nc" id="L560">    newProjectBean.setLongDescription(longDesc);</span>

<span class="nc" id="L562">    List&lt;ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.DataSet&gt; projectData = this</span>
<span class="nc" id="L563">        .getOpenBisClient().getDataSetsOfProjectByIdentifierWithSearchCriteria(projectIdentifier);</span>

<span class="nc" id="L565">    Boolean containsData = false;</span>
<span class="nc" id="L566">    Boolean containsResults = false;</span>
<span class="nc" id="L567">    Boolean attachmentResult = false;</span>
    // Boolean containsAttachments = false;

<span class="nc bnc" id="L570" title="All 2 branches missed.">    for (ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.DataSet ds : projectData) {</span>
<span class="nc" id="L571">      attachmentResult = false;</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">      if (ds.getDataSetTypeCode().equals(&quot;Q_PROJECT_DATA&quot;)) {</span>
<span class="nc" id="L573">        attachmentResult = ds.getProperties().get(&quot;Q_ATTACHMENT_TYPE&quot;).equals(&quot;RESULT&quot;);</span>
      }

<span class="nc bnc" id="L576" title="All 2 branches missed.">      if (!(ds.getDataSetTypeCode().equals(&quot;Q_PROJECT_DATA&quot;))</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">          &amp;&amp; !(ds.getDataSetTypeCode().contains(&quot;RESULTS&quot;))) {</span>
<span class="nc" id="L578">        containsData = true;</span>
<span class="nc bnc" id="L579" title="All 4 branches missed.">      } else if (ds.getDataSetTypeCode().contains(&quot;RESULTS&quot;) || attachmentResult) {</span>
<span class="nc" id="L580">        containsResults = true;</span>
      } // else if (ds.getDataSetTypeCode() == &quot;Q_PROJECT_DATA&quot;) {
        // containsAttachments = true;
      // }
<span class="nc" id="L584">    }</span>

<span class="nc" id="L586">    newProjectBean.setContainsData(containsData);</span>
<span class="nc" id="L587">    newProjectBean.setContainsResults(containsResults);</span>

<span class="nc" id="L589">    newProjectBean.setExperiments(experimentBeans);</span>
<span class="nc" id="L590">    newProjectBean.setMembers(new HashSet&lt;String&gt;());</span>
<span class="nc" id="L591">    return newProjectBean;</span>
  }

  /**
   * Method to get Bean from either openbis identifier or openbis object. Checks if corresponding
   * bean is already stored in datahandler map.
   * 
   * @param
   * @return
   */
  public ProjectBean getProject2(String projectIdentifier) {
<span class="nc" id="L602">    List&lt;Experiment&gt; experiments =</span>
<span class="nc" id="L603">        this.getOpenBisClient().getExperimentsForProject3(projectIdentifier);// TODO changed this</span>
                                                                             // from
                                                                             // getExperimentsForProject2

<span class="nc" id="L607">    float projectStatus = this.getOpenBisClient().computeProjectStatus(experiments);</span>

<span class="nc" id="L609">    Project project = getOpenbisDtoProject(projectIdentifier);</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">    if (project == null) {</span>
<span class="nc" id="L611">      project = getOpenBisClient().getProjectByIdentifier(projectIdentifier);</span>
<span class="nc" id="L612">      addOpenbisDtoProject(project);</span>
    }
<span class="nc" id="L614">    ProjectBean newProjectBean = new ProjectBean();</span>

<span class="nc" id="L616">    ProgressBar progressBar = new ProgressBar();</span>
<span class="nc" id="L617">    progressBar.setValue(projectStatus);</span>

<span class="nc" id="L619">    Date registrationDate = project.getRegistrationDetails().getRegistrationDate();</span>

    // String pi = getDatabaseManager().getInvestigatorDetailsForProject(project.getCode());
<span class="nc" id="L622">    String pi = getDatabaseManager().getPersonDetailsForProject(project.getIdentifier(), &quot;PI&quot;);</span>
<span class="nc" id="L623">    String cp = getDatabaseManager().getPersonDetailsForProject(project.getIdentifier(), &quot;Contact&quot;);</span>
<span class="nc" id="L624">    String manager =</span>
<span class="nc" id="L625">        getDatabaseManager().getPersonDetailsForProject(project.getIdentifier(), &quot;Manager&quot;);</span>

<span class="nc" id="L627">    String longDesc = getDatabaseManager().getLongProjectDescription(project.getIdentifier());</span>

<span class="nc bnc" id="L629" title="All 2 branches missed.">    if (pi.equals(&quot;&quot;)) {</span>
<span class="nc" id="L630">      newProjectBean.setPrincipalInvestigator(&quot;n/a&quot;);</span>
    } else {
<span class="nc" id="L632">      newProjectBean.setPrincipalInvestigator(pi);</span>
    }

<span class="nc bnc" id="L635" title="All 2 branches missed.">    if (cp.equals(&quot;&quot;)) {</span>
<span class="nc" id="L636">      newProjectBean.setContactPerson(&quot;n/a&quot;);</span>
    } else {
<span class="nc" id="L638">      newProjectBean.setContactPerson(cp);</span>
    }

<span class="nc bnc" id="L641" title="All 2 branches missed.">    if (manager.equals(&quot;&quot;)) {</span>
<span class="nc" id="L642">      newProjectBean.setProjectManager(&quot;n/a&quot;);</span>
    } else {
<span class="nc" id="L644">      newProjectBean.setProjectManager(manager);</span>
    }

<span class="nc bnc" id="L647" title="All 2 branches missed.">    if (longDesc == null)</span>
<span class="nc" id="L648">      longDesc = &quot;&quot;;</span>
<span class="nc" id="L649">    newProjectBean.setLongDescription(longDesc);</span>

<span class="nc" id="L651">    newProjectBean.setId(project.getIdentifier());</span>
<span class="nc" id="L652">    newProjectBean.setCode(project.getCode());</span>
<span class="nc" id="L653">    String desc = project.getDescription();</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">    if (desc == null)</span>
<span class="nc" id="L655">      desc = &quot;&quot;;</span>
<span class="nc" id="L656">    newProjectBean.setDescription(desc);</span>
<span class="nc" id="L657">    newProjectBean.setRegistrationDate(registrationDate);</span>
<span class="nc" id="L658">    newProjectBean.setProgress(progressBar);</span>
<span class="nc" id="L659">    newProjectBean.setRegistrator(project.getRegistrationDetails().getUserId());</span>
<span class="nc" id="L660">    newProjectBean.setContact(project.getRegistrationDetails().getUserEmail());</span>

    // Create sample Beans (or fetch them) for samples of experiments
<span class="nc" id="L663">    List&lt;Sample&gt; allSamples = this.getOpenBisClient()</span>
<span class="nc" id="L664">        .getSamplesWithParentsAndChildrenOfProjectBySearchService(projectIdentifier);</span>

<span class="nc" id="L666">    BeanItemContainer&lt;ExperimentBean&gt; experimentBeans =</span>
        new BeanItemContainer&lt;ExperimentBean&gt;(ExperimentBean.class);

<span class="nc" id="L669">    AlternativeSecondaryNameCreator altNameCreator = new AlternativeSecondaryNameCreator(</span>
<span class="nc" id="L670">        openBisClient.getVocabCodesAndLabelsForVocab(&quot;Q_NCBI_TAXONOMY&quot;));</span>

    // this is the experiment that stores the experimental design xml
<span class="nc" id="L673">    Experiment designExperiment = null;</span>
<span class="nc" id="L674">    Set&lt;String&gt; allSampleCodes = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">    for (Sample s : allSamples) {</span>
<span class="nc" id="L676">      allSampleCodes.add(s.getCode());</span>
<span class="nc" id="L677">    }</span>

    // create basic experimental design, if it doesn't exist
<span class="nc" id="L680">    String space = project.getSpaceCode();</span>
<span class="nc" id="L681">    String projectCode = project.getCode();</span>
<span class="nc" id="L682">    String designExpID = ExperimentCodeFunctions.getInfoExperimentID(space, projectCode);</span>

<span class="nc bnc" id="L684" title="All 2 branches missed.">    for (Experiment experiment : experiments) {</span>
<span class="nc" id="L685">      String id = experiment.getIdentifier();</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">      if (id.equals(designExpID)) {</span>
<span class="nc" id="L687">        designExperiment = experiment;</span>
<span class="nc" id="L688">        break;</span>
      }
<span class="nc" id="L690">    }</span>
<span class="nc" id="L691">    String user = PortalUtils.getNonNullScreenName();</span>

<span class="nc bnc" id="L693" title="All 2 branches missed.">    if (designExperiment == null) {</span>
<span class="nc" id="L694">      LOG.info(&quot;design experiment null, creating new one.&quot;);</span>
<span class="nc" id="L695">      Map&lt;String, Object&gt; params = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L696">      Map&lt;String, String&gt; props = new HashMap&lt;&gt;();</span>
      // TODO empty xml is not valid, but should we add one at all?
      // try {
      // String basicXML = studyParser.toString(studyParser.getEmptyXML());
      // props.put(&quot;Q_EXPERIMENTAL_SETUP&quot;, basicXML);
      // } catch (JAXBException e) {
      // // TODO Auto-generated catch block
      // e.printStackTrace();
      // }
<span class="nc" id="L705">      params.put(&quot;user&quot;, user);</span>
<span class="nc" id="L706">      params.put(&quot;code&quot;, projectCode + &quot;_INFO&quot;);</span>
<span class="nc" id="L707">      params.put(&quot;type&quot;, ExperimentType.Q_PROJECT_DETAILS);</span>
<span class="nc" id="L708">      params.put(&quot;project&quot;, projectCode);</span>
<span class="nc" id="L709">      params.put(&quot;space&quot;, space);</span>
<span class="nc" id="L710">      params.put(&quot;properties&quot;, props);</span>
<span class="nc" id="L711">      openBisClient.triggerIngestionService(&quot;register-exp&quot;, params);</span>
    }
    // parse experimental design for later use
<span class="nc" id="L714">    String xmlString = designExperiment.getProperties().get(&quot;Q_EXPERIMENTAL_SETUP&quot;);</span>
<span class="nc" id="L715">    JAXBElement&lt;Qexperiment&gt; expDesign = null;</span>
    try {
<span class="nc" id="L717">      expDesign = studyParser.parseXMLString(xmlString);</span>
<span class="nc" id="L718">    } catch (JAXBException e) {</span>
<span class="nc" id="L719">      LOG.error(&quot;could not parse experimental design xml!&quot;);</span>
<span class="nc" id="L720">      e.printStackTrace();</span>
<span class="nc" id="L721">    }</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">    if (expDesign != null) {</span>
      // experimental design found and parsed. remove samples that have since been deleted:
      try {
<span class="nc bnc" id="L725" title="All 2 branches missed.">        if (!allSampleCodes.isEmpty()) {</span>
<span class="nc" id="L726">          LOG.info(&quot;comparing existing samples with references in experimental design&quot;);</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">          if (studyParser.hasReferencesToMissingIDs(expDesign, allSampleCodes)) {</span>
<span class="nc" id="L728">            LOG.info(&quot;deleted samples found. updating xml in openBIS&quot;);</span>
<span class="nc" id="L729">            expDesign = studyParser.removeReferencesToMissingIDs(expDesign, allSampleCodes, true);</span>
          }
        }
<span class="nc" id="L732">        HashMap&lt;String, Object&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L733">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc" id="L734">        properties.put(&quot;Q_EXPERIMENTAL_SETUP&quot;, studyParser.toString(expDesign));</span>
<span class="nc" id="L735">        params.put(&quot;user&quot;, user);</span>
<span class="nc" id="L736">        params.put(&quot;identifier&quot;, designExpID);</span>
<span class="nc" id="L737">        params.put(&quot;properties&quot;, properties);</span>
<span class="nc" id="L738">        openBisClient.triggerIngestionService(&quot;update-experiment-metadata&quot;, params);</span>
<span class="nc" id="L739">      } catch (JAXBException e) {</span>
<span class="nc" id="L740">        LOG.warn(</span>
            &quot;could not create new experimental design xml from old one after removing missing ids. &quot;
                + &quot;will continue with old design.&quot;);
<span class="nc" id="L743">        e.printStackTrace();</span>
<span class="nc" id="L744">      }</span>

<span class="nc" id="L746">      this.experimentalSetup = expDesign;</span>
<span class="nc" id="L747">      this.experimentalFactorLabels = studyParser.getFactorLabels(expDesign);</span>
<span class="nc" id="L748">      this.experimentalFactorsForLabelsAndSamples =</span>
<span class="nc" id="L749">          studyParser.getFactorsForLabelsAndSamples(expDesign);</span>
<span class="nc" id="L750">      this.propertiesForSamples = studyParser.getPropertiesForSampleCode(expDesign);</span>
    }

<span class="nc bnc" id="L753" title="All 2 branches missed.">    for (Experiment experiment : experiments) {</span>
<span class="nc" id="L754">      ExperimentBean newExperimentBean = new ExperimentBean();</span>

      // TODO doesn't work with getExperimentsForProject2
<span class="nc" id="L757">      Map&lt;String, String&gt; assignedProperties = experiment.getProperties();</span>

<span class="nc" id="L759">      String status = &quot;&quot;;</span>

<span class="nc bnc" id="L761" title="All 2 branches missed.">      if (assignedProperties.keySet().contains(&quot;Q_CURRENT_STATUS&quot;)) {</span>
<span class="nc" id="L762">        status = assignedProperties.get(&quot;Q_CURRENT_STATUS&quot;);</span>
      }

<span class="nc bnc" id="L765" title="All 2 branches missed.">      else if (assignedProperties.keySet().contains(&quot;Q_WF_STATUS&quot;)) {</span>
<span class="nc" id="L766">        status = assignedProperties.get(&quot;Q_WF_STATUS&quot;);</span>
      }

<span class="nc" id="L769">      List&lt;Sample&gt; samples = new ArrayList&lt;Sample&gt;();</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">      for (Sample s : allSamples) {</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">        if (s.getExperimentIdentifierOrNull().equals(experiment.getIdentifier()))</span>
<span class="nc" id="L772">          samples.add(s);</span>
<span class="nc" id="L773">      }</span>
<span class="nc" id="L774">      BeanItemContainer&lt;SampleBean&gt; sampleBeans =</span>
          new BeanItemContainer&lt;SampleBean&gt;(SampleBean.class);
<span class="nc bnc" id="L776" title="All 2 branches missed.">      for (Sample sample : samples) {</span>
<span class="nc" id="L777">        SampleBean sbean = new SampleBean();</span>
<span class="nc" id="L778">        sbean.setId(sample.getIdentifier());</span>
<span class="nc" id="L779">        sbean.setCode(sample.getCode());</span>
<span class="nc" id="L780">        sbean.setType(sample.getSampleTypeCode());</span>
<span class="nc" id="L781">        sbean.setProperties(sample.getProperties());</span>
<span class="nc" id="L782">        List&lt;Property&gt; complexProps =</span>
<span class="nc" id="L783">            studyParser.getFactorsAndPropertiesForSampleCode(experimentalSetup, sample.getCode());</span>
<span class="nc" id="L784">        sbean.setComplexProperties(complexProps);</span>
<span class="nc" id="L785">        sampleBeans.addBean(sbean);</span>
<span class="nc" id="L786">      }</span>
<span class="nc" id="L787">      newExperimentBean.setSamples(sampleBeans);</span>

<span class="nc" id="L789">      newExperimentBean.setAltNameCreator(altNameCreator);</span>
<span class="nc" id="L790">      newExperimentBean.setProperties(assignedProperties);</span>
<span class="nc" id="L791">      newExperimentBean.setSecondaryName(assignedProperties.get(&quot;Q_SECONDARY_NAME&quot;));</span>
<span class="nc" id="L792">      newExperimentBean.setId(experiment.getIdentifier());</span>
<span class="nc" id="L793">      newExperimentBean.setCode(experiment.getCode());</span>
<span class="nc" id="L794">      newExperimentBean.setType(experiment.getExperimentTypeCode());</span>
<span class="nc" id="L795">      newExperimentBean.setRegistrator(experiment.getRegistrationDetails().getUserId());</span>
<span class="nc" id="L796">      newExperimentBean</span>
<span class="nc" id="L797">          .setRegistrationDate(experiment.getRegistrationDetails().getRegistrationDate());</span>
<span class="nc" id="L798">      newExperimentBean.setStatus(status);</span>
<span class="nc" id="L799">      experimentBeans.addBean(newExperimentBean);</span>
<span class="nc" id="L800">    }</span>
<span class="nc" id="L801">    List&lt;ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.DataSet&gt; projectData = this</span>
<span class="nc" id="L802">        .getOpenBisClient().getDataSetsOfProjectByIdentifierWithSearchCriteria(projectIdentifier);</span>

<span class="nc" id="L804">    Boolean containsData = false;</span>
<span class="nc" id="L805">    Boolean containsResults = false;</span>
<span class="nc" id="L806">    Boolean attachmentResult = false;</span>
    // Boolean containsAttachments = false;
<span class="nc bnc" id="L808" title="All 2 branches missed.">    for (ch.systemsx.cisd.openbis.generic.shared.api.v1.dto.DataSet ds : projectData) {</span>
<span class="nc" id="L809">      attachmentResult = false;</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">      if (ds.getDataSetTypeCode().equals(&quot;Q_PROJECT_DATA&quot;)) {</span>
<span class="nc" id="L811">        attachmentResult = ds.getProperties().get(&quot;Q_ATTACHMENT_TYPE&quot;).equals(&quot;RESULT&quot;);</span>
      }

<span class="nc bnc" id="L814" title="All 2 branches missed.">      if (!(ds.getDataSetTypeCode().equals(&quot;Q_PROJECT_DATA&quot;))</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">          &amp;&amp; !(ds.getDataSetTypeCode().contains(&quot;RESULTS&quot;))) {</span>
<span class="nc" id="L816">        containsData = true;</span>
<span class="nc bnc" id="L817" title="All 4 branches missed.">      } else if (ds.getDataSetTypeCode().contains(&quot;RESULTS&quot;) || attachmentResult) {</span>
<span class="nc" id="L818">        containsResults = true;</span>
      } // else if (ds.getDataSetTypeCode() == &quot;Q_PROJECT_DATA&quot;) {
        // containsAttachments = true;
      // }
<span class="nc" id="L822">    }</span>

<span class="nc" id="L824">    newProjectBean.setContainsData(containsData);</span>
<span class="nc" id="L825">    newProjectBean.setContainsResults(containsResults);</span>
    // newProjectBean.setContainsAttachments(containsAttachments);

<span class="nc" id="L828">    newProjectBean.setExperiments(experimentBeans);</span>
<span class="nc" id="L829">    newProjectBean.setMembers(new HashSet&lt;String&gt;());</span>

<span class="nc" id="L831">    String secondaryName = getDatabaseManager().getProjectName(projectIdentifier);</span>
<span class="nc bnc" id="L832" title="All 4 branches missed.">    if (secondaryName == null || secondaryName.isEmpty())</span>
<span class="nc" id="L833">      secondaryName = &quot;n/a&quot;;</span>

<span class="nc" id="L835">    newProjectBean.setSecondaryName(secondaryName);</span>
<span class="nc" id="L836">    return newProjectBean;</span>
  }

  //
  // public ProjectBean getProjectIvac(String projectIdentifier) {
  // List&lt;Experiment&gt; experiments =
  // this.getOpenBisClient().getExperimentsForProject3(projectIdentifier);
  // float projectStatus = this.getOpenBisClient().computeProjectStatus(experiments);
  //
  // Project project = getOpenbisDtoProject(projectIdentifier);
  // if (project == null) {
  // project = getOpenBisClient().getProjectByIdentifier(projectIdentifier);
  // addOpenbisDtoProject(project);
  // }
  // ProjectBean newProjectBean = new ProjectBean();
  //
  // ProgressBar progressBar = new ProgressBar();
  // progressBar.setValue(projectStatus);
  //
  // Date registrationDate = project.getRegistrationDetails().getRegistrationDate();
  //
  // // String pi = getDatabaseManager().getInvestigatorDetailsForProject(project.getCode());
  // String pi = getDatabaseManager().getPersonDetailsForProject(project.getIdentifier(), &quot;PI&quot;);
  // String cp = getDatabaseManager().getPersonDetailsForProject(project.getIdentifier(),
  // &quot;Contact&quot;);
  //
  // if (pi.equals(&quot;&quot;)) {
  // newProjectBean.setPrincipalInvestigator(&quot;No information provided.&quot;);
  // } else {
  // newProjectBean.setPrincipalInvestigator(pi);
  // }
  //
  // if (cp.equals(&quot;&quot;)) {
  // newProjectBean.setContactPerson(&quot;No information provided.&quot;);
  // } else {
  // newProjectBean.setContactPerson(cp);
  // }
  //
  // newProjectBean.setId(project.getIdentifier());
  // newProjectBean.setCode(project.getCode());
  // String desc = project.getDescription();
  // if (desc == null)
  // desc = &quot;&quot;;
  // newProjectBean.setDescription(desc);
  // newProjectBean.setRegistrationDate(registrationDate);
  // newProjectBean.setProgress(progressBar);
  // newProjectBean.setRegistrator(project.getRegistrationDetails().getUserId());
  // newProjectBean.setContact(project.getRegistrationDetails().getUserEmail());
  //
  // // Create sample Beans (or fetch them) for samples of experiments
  // List&lt;Sample&gt; allSamples = this.getOpenBisClient()
  // .getSamplesWithParentsAndChildrenOfProjectBySearchService(projectIdentifier);
  //
  // BeanItemContainer&lt;ExperimentBean&gt; experimentBeans =
  // new BeanItemContainer&lt;ExperimentBean&gt;(ExperimentBean.class);
  //
  // AlternativeSecondaryNameCreator altNameCreator = new AlternativeSecondaryNameCreator(
  // openBisClient.getVocabCodesAndLabelsForVocab(&quot;Q_NCBI_TAXONOMY&quot;));
  // for (Experiment experiment : experiments) {
  // ExperimentBean newExperimentBean = new ExperimentBean();
  //
  // Map&lt;String, String&gt; assignedProperties = experiment.getProperties();
  //
  // String status = &quot;&quot;;
  //
  // if (assignedProperties.keySet().contains(&quot;Q_CURRENT_STATUS&quot;)) {
  // status = assignedProperties.get(&quot;Q_CURRENT_STATUS&quot;);
  // }
  //
  // else if (assignedProperties.keySet().contains(&quot;Q_WF_STATUS&quot;)) {
  // status = assignedProperties.get(&quot;Q_WF_STATUS&quot;);
  // }
  //
  // List&lt;Sample&gt; samples = new ArrayList&lt;Sample&gt;();
  // for (Sample s : allSamples) {
  // if (s.getExperimentIdentifierOrNull().equals(experiment.getIdentifier()))
  // samples.add(s);
  // }
  // BeanItemContainer&lt;SampleBean&gt; sampleBeans =
  // new BeanItemContainer&lt;SampleBean&gt;(SampleBean.class);
  // for (Sample sample : samples) {
  // SampleBean sbean = new SampleBean();
  // sbean.setId(sample.getIdentifier());
  // sbean.setCode(sample.getCode());
  // sbean.setType(sample.getSampleTypeCode());
  // sbean.setProperties(sample.getProperties());
  // sampleBeans.addBean(sbean);
  // }
  // newExperimentBean.setSamples(sampleBeans);
  //
  // newExperimentBean.setAltNameCreator(altNameCreator);
  // newExperimentBean.setProperties(assignedProperties);
  // newExperimentBean.setSecondaryName(assignedProperties.get(&quot;Q_SECONDARY_NAME&quot;));
  // newExperimentBean.setId(experiment.getIdentifier());
  // newExperimentBean.setCode(experiment.getCode());
  // newExperimentBean.setType(experiment.getExperimentTypeCode());
  // newExperimentBean.setRegistrator(experiment.getRegistrationDetails().getUserId());
  // newExperimentBean
  // .setRegistrationDate(experiment.getRegistrationDetails().getRegistrationDate());
  // newExperimentBean.setStatus(status);
  // experimentBeans.addBean(newExperimentBean);
  // }
  //
  // newProjectBean.setContainsData(this.getOpenBisClient()
  // .getDataSetsOfProjectByIdentifierWithSearchCriteria(projectIdentifier).size() &gt; 0);
  //
  //
  // newProjectBean.setExperiments(experimentBeans);
  // newProjectBean.setMembers(new HashSet&lt;String&gt;());
  // return newProjectBean;
  // }


  public Project getOpenbisDtoProject(String projectIdentifier) {
<span class="nc bnc" id="L950" title="All 2 branches missed.">    if (this.dtoProjects.containsKey(projectIdentifier)) {</span>
<span class="nc" id="L951">      return this.dtoProjects.get(projectIdentifier);</span>
    }
<span class="nc" id="L953">    return null;</span>

  }


  public void addOpenbisDtoProject(Project project) {
<span class="nc bnc" id="L959" title="All 4 branches missed.">    if (project != null &amp;&amp; !dtoProjects.containsKey(project.getIdentifier())) {</span>
<span class="nc" id="L960">      this.dtoProjects.put(project.getIdentifier(), project);</span>
    }
<span class="nc" id="L962">  }</span>



  /**
   * Method to get Bean from either openbis identifier or openbis object. Checks if corresponding
   * bean is already stored in datahandler map.
   * 
   * @param
   * @return
   */
  // public ExperimentBean getExperiment(Object exp) {
  // Experiment experiment;
  // ExperimentBean newExperimentBean;
  //
  // if (exp instanceof Experiment) {
  // experiment = (Experiment) exp;
  // newExperimentBean = this.createExperimentBean(experiment);
  // this.experimentMap.put(newExperimentBean.getId(), newExperimentBean);
  // }
  //
  // else {
  // if (this.experimentMap.get((String) exp) != null) {
  // newExperimentBean = this.experimentMap.get(exp);
  // } else {
  // experiment = this.getOpenBisClient().getExperimentById((String) exp);
  // newExperimentBean = this.createExperimentBean(experiment);
  // this.experimentMap.put(newExperimentBean.getId(), newExperimentBean);
  // }
  // }
  // return newExperimentBean;
  // }


  public ExperimentBean getExperiment2(String expIdentifiers) {
<span class="nc" id="L997">    ExperimentBean ebean = new ExperimentBean();</span>

<span class="nc" id="L999">    AlternativeSecondaryNameCreator altNameCreator = new AlternativeSecondaryNameCreator(</span>
<span class="nc" id="L1000">        openBisClient.getVocabCodesAndLabelsForVocab(&quot;Q_NCBI_TAXONOMY&quot;));</span>
<span class="nc" id="L1001">    ebean.setAltNameCreator(altNameCreator);</span>

<span class="nc" id="L1003">    String status = &quot;&quot;;</span>
<span class="nc" id="L1004">    List&lt;Experiment&gt; experiments = getOpenBisClient().getExperimentById2(expIdentifiers);</span>
<span class="nc" id="L1005">    Experiment experiment = null;</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">    for (Experiment tmpexp : experiments) {</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">      if (tmpexp.getIdentifier().equals(expIdentifiers)) {</span>
<span class="nc" id="L1008">        experiment = tmpexp;</span>
<span class="nc" id="L1009">        break;</span>
      }
<span class="nc" id="L1011">    }</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">    if (experiment == null)</span>
<span class="nc" id="L1013">      throw new IllegalArgumentException(</span>
<span class="nc" id="L1014">          String.format(&quot;experiment Identifier %s does not exist&quot;, expIdentifiers));</span>
    // Get all properties for metadata changing
<span class="nc" id="L1016">    List&lt;PropertyType&gt; completeProperties = this.getOpenBisClient().listPropertiesForType(</span>
<span class="nc" id="L1017">        this.getOpenBisClient().getExperimentTypeByString(experiment.getExperimentTypeCode()));</span>

<span class="nc" id="L1019">    Map&lt;String, String&gt; assignedProperties = experiment.getProperties();</span>
<span class="nc" id="L1020">    Map&lt;String, List&lt;String&gt;&gt; controlledVocabularies = new HashMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L1021">    Map&lt;String, String&gt; properties = new HashMap&lt;String, String&gt;();</span>

<span class="nc bnc" id="L1023" title="All 2 branches missed.">    if (assignedProperties.keySet().contains(&quot;Q_CURRENT_STATUS&quot;)) {</span>
<span class="nc" id="L1024">      status = assignedProperties.get(&quot;Q_CURRENT_STATUS&quot;);</span>
    }

<span class="nc bnc" id="L1027" title="All 2 branches missed.">    else if (assignedProperties.keySet().contains(&quot;Q_WF_STATUS&quot;)) {</span>
<span class="nc" id="L1028">      status = assignedProperties.get(&quot;Q_WF_STATUS&quot;);</span>
    }

<span class="nc" id="L1031">    boolean material = false;</span>

<span class="nc bnc" id="L1033" title="All 2 branches missed.">    for (PropertyType p : completeProperties) {</span>

<span class="nc bnc" id="L1035" title="All 2 branches missed.">      if (p instanceof ControlledVocabularyPropertyType) {</span>
<span class="nc" id="L1036">        controlledVocabularies.put(p.getCode(),</span>
<span class="nc" id="L1037">            getOpenBisClient().listVocabularyTermsForProperty(p));</span>
      }

<span class="nc bnc" id="L1040" title="All 2 branches missed.">      if (p.getDataType().toString().equals(&quot;MATERIAL&quot;)</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">          &amp;&amp; (assignedProperties.get(p.getCode()) != null)) {</span>
<span class="nc" id="L1042">        String[] splitted = assignedProperties.get(p.getCode()).split(&quot;\\(&quot;);</span>

<span class="nc" id="L1044">        String materialType = splitted[1].replace(&quot;)&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;&quot;);</span>
<span class="nc" id="L1045">        String materialCode = splitted[0].replace(&quot; &quot;, &quot;&quot;);</span>

<span class="nc" id="L1047">        MaterialIdentifier matId =</span>
            new MaterialIdentifier(new MaterialTypeIdentifier(materialType), materialCode);

<span class="nc" id="L1050">        List&lt;MaterialIdentifier&gt; matIds = new ArrayList&lt;MaterialIdentifier&gt;();</span>
<span class="nc" id="L1051">        matIds.add(matId);</span>

<span class="nc" id="L1053">        List&lt;Material&gt; materials = getOpenBisClient().getOpenbisInfoService()</span>
<span class="nc" id="L1054">            .getMaterialByCodes(getOpenBisClient().getSessionToken(), matIds);</span>

<span class="nc" id="L1056">        Map&lt;String, String&gt; matProperties = materials.get(0).getProperties();</span>
<span class="nc" id="L1057">        String matProperty = &quot;&quot;;</span>

<span class="nc bnc" id="L1059" title="All 2 branches missed.">        for (Entry prop : matProperties.entrySet()) {</span>
<span class="nc" id="L1060">          matProperty += String.format(&quot;%s, &quot;, prop.getValue());</span>
<span class="nc" id="L1061">        }</span>

<span class="nc" id="L1063">        properties.put(p.getCode(), matProperty.substring(0, matProperty.length() - 2));</span>
<span class="nc" id="L1064">        material = true;</span>
      }

<span class="nc bnc" id="L1067" title="All 4 branches missed.">      if (assignedProperties.keySet().contains(p.getCode()) &amp;&amp; !(material)) {</span>
<span class="nc" id="L1068">        properties.put(p.getCode(), assignedProperties.get(p.getCode()));</span>
<span class="nc bnc" id="L1069" title="All 2 branches missed.">      } else if (!(material)) {</span>
<span class="nc" id="L1070">        properties.put(p.getCode(), &quot;&quot;);</span>
      }
<span class="nc" id="L1072">    }</span>

<span class="nc" id="L1074">    Map&lt;String, String&gt; typeLabels = this.getOpenBisClient().getLabelsofProperties(</span>
<span class="nc" id="L1075">        this.getOpenBisClient().getExperimentTypeByString(experiment.getExperimentTypeCode()));</span>

    // Image statusColor = new Image(status, this.setExperimentStatusColor(status));
    // statusColor.setWidth(&quot;15px&quot;);
    // statusColor.setHeight(&quot;15px&quot;);

<span class="nc" id="L1081">    ebean.setId(experiment.getIdentifier());</span>
<span class="nc" id="L1082">    ebean.setCode(experiment.getCode());</span>
<span class="nc" id="L1083">    ebean.setType(experiment.getExperimentTypeCode());</span>
<span class="nc" id="L1084">    ebean.setStatus(status);</span>
<span class="nc" id="L1085">    ebean.setRegistrator(experiment.getRegistrationDetails().getUserId());</span>
<span class="nc" id="L1086">    ebean.setRegistrationDate(experiment.getRegistrationDetails().getRegistrationDate());</span>
<span class="nc" id="L1087">    ebean.setProperties(properties);</span>
<span class="nc" id="L1088">    ebean.setSecondaryName(properties.get(&quot;Q_SECONDARY_NAME&quot;));</span>
<span class="nc" id="L1089">    ebean.setControlledVocabularies(controlledVocabularies);</span>
<span class="nc" id="L1090">    ebean.setTypeLabels(typeLabels);</span>

    // TODO do we want to have that ? (last Changed)
<span class="nc" id="L1093">    ebean.setLastChangedSample(null);</span>
<span class="nc" id="L1094">    ebean.setContainsData(this.getOpenBisClient()</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">        .getDataSetsOfExperimentByCodeWithSearchCriteria(experiment.getCode()).size() &gt; 0);</span>

    // List&lt;Sample&gt; samples = this.getOpenBisClient().getSamplesofExperiment(expIdentifiers);
    // Create sample Beans (or fetch them) for samples of experiment
<span class="nc" id="L1099">    List&lt;Sample&gt; allSamples = new ArrayList&lt;Sample&gt;();</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">    if (allSamples.isEmpty()) {</span>
<span class="nc" id="L1101">      String[] splt = experiment.getIdentifier().split(&quot;/&quot;);</span>
<span class="nc" id="L1102">      String projID = &quot;/&quot; + splt[1] + &quot;/&quot; + splt[2];</span>
<span class="nc" id="L1103">      allSamples =</span>
<span class="nc" id="L1104">          this.getOpenBisClient().getSamplesWithParentsAndChildrenOfProjectBySearchService(projID);</span>
    }
<span class="nc" id="L1106">    List&lt;Sample&gt; samples = new ArrayList&lt;Sample&gt;();</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">    for (Sample s : allSamples) {</span>
<span class="nc bnc" id="L1108" title="All 2 branches missed.">      if (s.getExperimentIdentifierOrNull().equals(experiment.getIdentifier()))</span>
<span class="nc" id="L1109">        samples.add(s);</span>
<span class="nc" id="L1110">    }</span>

<span class="nc" id="L1112">    BeanItemContainer&lt;SampleBean&gt; sampleBeans = new BeanItemContainer&lt;SampleBean&gt;(SampleBean.class);</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">    for (Sample sample : samples) {</span>
<span class="nc" id="L1114">      SampleBean sbean = new SampleBean();</span>
<span class="nc" id="L1115">      sbean.setId(sample.getIdentifier());</span>
<span class="nc" id="L1116">      sbean.setCode(sample.getCode());</span>
<span class="nc" id="L1117">      sbean.setType(sample.getSampleTypeCode());</span>
<span class="nc" id="L1118">      sbean.setProperties(sample.getProperties());</span>
<span class="nc" id="L1119">      List&lt;Property&gt; complexProps =</span>
<span class="nc" id="L1120">          studyParser.getFactorsAndPropertiesForSampleCode(experimentalSetup, sample.getCode());</span>
<span class="nc" id="L1121">      sbean.setComplexProperties(complexProps);</span>
      /*
       * Map&lt;String, String&gt; sampleTypeLabels =
       * this.openBisClient.getLabelsofProperties(this.openBisClient.getSampleTypeByString(sample
       * .getSampleTypeCode())); sbean.setTypeLabels(sampleTypeLabels);
       */

<span class="nc" id="L1128">      sampleBeans.addBean(sbean);</span>
<span class="nc" id="L1129">    }</span>
<span class="nc" id="L1130">    ebean.setSamples(sampleBeans);</span>

<span class="nc" id="L1132">    return ebean;</span>
  }

  public SampleBean getSample2(String sampleIdentifiers) {
<span class="nc" id="L1136">    Sample sample = this.getOpenBisClient().getSampleByIdentifier(sampleIdentifiers);</span>
<span class="nc" id="L1137">    SampleBean sbean = createSampleBean(sample);</span>
<span class="nc" id="L1138">    return sbean;</span>
  }

  /**
   * Method to get Bean from either openbis identifier or openbis object. Checks if corresponding
   * bean is already stored in datahandler map.
   * 
   * @param
   * @return
   */
  public SampleBean getSample(Object samp) {
    Sample sample;
    SampleBean newSampleBean;

<span class="nc bnc" id="L1152" title="All 2 branches missed.">    if (samp instanceof Sample) {</span>
<span class="nc" id="L1153">      sample = (Sample) samp;</span>
<span class="nc" id="L1154">      newSampleBean = this.createSampleBean(sample);</span>
<span class="nc" id="L1155">      this.sampleMap.put(newSampleBean.getId(), newSampleBean);</span>
    }

    else {
<span class="nc bnc" id="L1159" title="All 2 branches missed.">      if (this.sampleMap.get((String) samp) != null) {</span>
<span class="nc" id="L1160">        newSampleBean = this.sampleMap.get(samp);</span>
      } else {
<span class="nc" id="L1162">        sample = this.getOpenBisClient().getSampleByIdentifier((String) samp);</span>
<span class="nc" id="L1163">        newSampleBean = this.createSampleBean(sample);</span>
<span class="nc" id="L1164">        this.sampleMap.put(newSampleBean.getId(), newSampleBean);</span>
      }
    }

<span class="nc" id="L1168">    return newSampleBean;</span>
  }

  /**
   * Method to get Bean from either openbis identifier or openbis object. Checks if corresponding
   * bean is already stored in datahandler map.
   * 
   * @param
   * @return
   */
  public DatasetBean getDataset(Object ds) {
    DataSet dataset;
    DatasetBean newDatasetBean;

<span class="nc bnc" id="L1182" title="All 2 branches missed.">    if (ds instanceof DataSet) {</span>
<span class="nc" id="L1183">      dataset = (DataSet) ds;</span>
<span class="nc" id="L1184">      newDatasetBean = this.createDatasetBean(dataset);</span>
    }

    else {
<span class="nc bnc" id="L1188" title="All 2 branches missed.">      if (this.datasetMap.get((String) ds) != null) {</span>
<span class="nc" id="L1189">        newDatasetBean = this.datasetMap.get(ds);</span>
      } else {
<span class="nc" id="L1191">        dataset = this.getOpenBisClient().getFacade().getDataSet((String) ds);</span>
<span class="nc" id="L1192">        newDatasetBean = this.createDatasetBean(dataset);</span>
      }
    }
<span class="nc" id="L1195">    this.datasetMap.put(newDatasetBean.getCode(), newDatasetBean);</span>
<span class="nc" id="L1196">    return newDatasetBean;</span>
  }


  /**
   * Returns all users of a Space.
   * 
   * @param spaceCode code of the openBIS space
   * @return set of user names as string
   */
  private Set&lt;String&gt; getSpaceMembers(String spaceCode) {
<span class="nc" id="L1207">    List&lt;SpaceWithProjectsAndRoleAssignments&gt; spaces = this.getSpacesWithProjectInformation();</span>
<span class="nc bnc" id="L1208" title="All 2 branches missed.">    for (SpaceWithProjectsAndRoleAssignments space : spaces) {</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">      if (space.getCode().equals(spaceCode)) {</span>
<span class="nc" id="L1210">        return space.getUsers();</span>
      }
<span class="nc" id="L1212">    }</span>
<span class="nc" id="L1213">    return null;</span>
  }

  /**
   * checks which of the datasets in the given list is the oldest and writes that into the last tree
   * parameters Note: lastModifiedDate, lastModifiedExperiment, lastModifiedSample will be modified.
   * if lastModifiedSample, lastModifiedExperiment have value N/A datasets have no registration
   * dates Params should not be null
   * 
   * @param datasets List of datasets that will be compared
   * @param lastModifiedDate will contain the last modified date
   * @param lastModifiedExperiment will contain experiment identifier, which contains last
   *        registered dataset
   * @param lastModifiedSample will contain last sample identifier, which contains last registered
   *        dataset, or null if dataset does not belong to a sample.
   */
  public void lastDatasetRegistered(List&lt;DataSet&gt; datasets, Date lastModifiedDate,
      StringBuilder lastModifiedExperiment, StringBuilder lastModifiedSample) {
<span class="nc" id="L1231">    String exp = &quot;N/A&quot;;</span>
<span class="nc" id="L1232">    String samp = &quot;N/A&quot;;</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">    for (DataSet dataset : datasets) {</span>
<span class="nc" id="L1234">      Date date = dataset.getRegistrationDate();</span>

<span class="nc bnc" id="L1236" title="All 2 branches missed.">      if (date.after(lastModifiedDate)) {</span>
<span class="nc" id="L1237">        samp = dataset.getSampleIdentifierOrNull();</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">        if (samp == null) {</span>
<span class="nc" id="L1239">          samp = &quot;N/A&quot;;</span>
        }
<span class="nc" id="L1241">        exp = dataset.getExperimentIdentifier();</span>
<span class="nc" id="L1242">        lastModifiedDate.setTime(date.getTime());</span>
<span class="nc" id="L1243">        break;</span>
      }
<span class="nc" id="L1245">    }</span>
<span class="nc" id="L1246">    lastModifiedExperiment.append(exp);</span>
<span class="nc" id="L1247">    lastModifiedSample.append(samp);</span>
<span class="nc" id="L1248">  }</span>

  // public void reset() {
  // // this.spaces = new HashMap&lt;String,IndexedContainer&gt;();
  // // this.projects = new HashMap&lt;String,IndexedContainer&gt;();
  // // this.experiments = new HashMap&lt;String,IndexedContainer&gt;();
  // // this.samples = new HashMap&lt;String,IndexedContainer&gt;();
  // this.space_to_datasets = new HashMap&lt;String, HierarchicalContainer&gt;();
  // }


  /**
   * This method filters out qbic staff and other unnecessary space members TODO: this method might
   * be better of as not being part of the DataHandler...and not hardcoded
   * 
   * @param users a set of all space users or members
   * @return a new set which exculdes qbic staff and functional members
   */
  public Set&lt;String&gt; removeQBiCStaffFromMemberSet(Set&lt;String&gt; users) {
    // TODO there is probably a method to get users of the QBIC group out of openBIS
<span class="nc" id="L1268">    Set&lt;String&gt; ret = new LinkedHashSet&lt;String&gt;(users);</span>
    // ret.remove(&quot;iiswo01&quot;); // QBiC Staff
    // ret.remove(&quot;iisfr01&quot;); // QBiC Staff
    // ret.remove(&quot;kxmsn01&quot;); // QBiC Staff
    // ret.remove(&quot;zxmbf02&quot;); // QBiC Staff
    // ret.remove(&quot;qeana10&quot;); // functional user
<span class="nc" id="L1274">    ret.remove(&quot;etlserver&quot;); // OpenBIS user</span>
<span class="nc" id="L1275">    ret.remove(&quot;admin&quot;); // OpenBIS user</span>
<span class="nc" id="L1276">    ret.remove(&quot;QBIC&quot;); // OpenBIS user</span>
<span class="nc" id="L1277">    ret.remove(&quot;sauron&quot;);</span>
<span class="nc" id="L1278">    ret.remove(&quot;regtestuser&quot;);</span>
<span class="nc" id="L1279">    ret.remove(&quot;student&quot;);</span>
    // ret.remove(&quot;babysauron&quot;);
<span class="nc" id="L1281">    return ret;</span>
  }


  /**
   * Method create ProjectBean for project object
   * 
   * @param project
   * @return ProjectBean for corresponding project
   */

  // @Deprecated
  // ProjectBean createProjectBean(Project project) {
  //
  // ProjectBean newProjectBean = new ProjectBean();
  //
  // List&lt;Experiment&gt; experiments =
  // this.getOpenBisClient().getExperimentsOfProjectByIdentifier(project.getIdentifier());
  //
  // ProgressBar progressBar = new ProgressBar();
  // progressBar.setValue(this.getOpenBisClient().computeProjectStatus(project));
  //
  // Date registrationDate = project.getRegistrationDetails().getRegistrationDate();
  //
  // newProjectBean.setId(project.getIdentifier());
  // newProjectBean.setCode(project.getCode());
  // String desc = project.getDescription();
  // if (desc == null)
  // desc = &quot;&quot;;
  // newProjectBean.setDescription(desc);
  // newProjectBean.setRegistrationDate(registrationDate);
  // newProjectBean.setProgress(progressBar);
  // newProjectBean.setRegistrator(project.getRegistrationDetails().getUserId());
  // newProjectBean.setContact(project.getRegistrationDetails().getUserEmail());
  //
  // BeanItemContainer&lt;ExperimentBean&gt; experimentBeans =
  // new BeanItemContainer&lt;ExperimentBean&gt;(ExperimentBean.class);
  //
  // List&lt;String&gt; experiment_identifiers = new ArrayList&lt;String&gt;();
  //
  // for (Experiment experiment : experiments) {
  // experimentBeans.addBean(this.getExperiment(experiment));
  // experiment_identifiers.add(experiment.getIdentifier());
  // }
  // List&lt;DataSet&gt; datasets = (experiment_identifiers.size() &gt; 0)
  // ? getOpenBisClient().getFacade().listDataSetsForExperiments(experiment_identifiers)
  // : new ArrayList&lt;DataSet&gt;();
  // newProjectBean.setContainsData(datasets.size() != 0);
  //
  // newProjectBean.setExperiments(experimentBeans);
  // newProjectBean.setMembers(this.getOpenBisClient().getSpaceMembers(project.getSpaceCode()));
  //
  // return newProjectBean;
  // }


  /**
   * Method to create ExperimentBean for experiment object
   * 
   * @param experiment
   * @return ExperimentBean for corresponding experiment
   */
  // @Deprecated
  // ExperimentBean createExperimentBean(Experiment experiment) {
  //
  // ExperimentBean newExperimentBean = new ExperimentBean();
  // List&lt;Sample&gt; samples =
  // this.getOpenBisClient().getSamplesofExperiment(experiment.getIdentifier());
  //
  // String status = &quot;&quot;;
  //
  // // Get all properties for metadata changing
  // List&lt;PropertyType&gt; completeProperties = this.getOpenBisClient().listPropertiesForType(
  // this.getOpenBisClient().getExperimentTypeByString(experiment.getExperimentTypeCode()));
  //
  // Map&lt;String, String&gt; assignedProperties = experiment.getProperties();
  // Map&lt;String, List&lt;String&gt;&gt; controlledVocabularies = new HashMap&lt;String, List&lt;String&gt;&gt;();
  // Map&lt;String, String&gt; properties = new HashMap&lt;String, String&gt;();
  //
  //
  // if (assignedProperties.keySet().contains(&quot;Q_CURRENT_STATUS&quot;)) {
  // status = assignedProperties.get(&quot;Q_CURRENT_STATUS&quot;);
  // }
  //
  // else if (assignedProperties.keySet().contains(&quot;Q_WF_STATUS&quot;)) {
  // status = assignedProperties.get(&quot;Q_WF_STATUS&quot;);
  // }
  //
  // for (PropertyType p : completeProperties) {
  //
  // // TODO no hardcoding
  //
  // if (p instanceof ControlledVocabularyPropertyType) {
  // controlledVocabularies.put(p.getCode(),
  // getOpenBisClient().listVocabularyTermsForProperty(p));
  // }
  //
  // if (assignedProperties.keySet().contains(p.getCode())) {
  // properties.put(p.getCode(), assignedProperties.get(p.getCode()));
  // } else {
  // properties.put(p.getCode(), &quot;&quot;);
  // }
  // }
  //
  // Map&lt;String, String&gt; typeLabels = this.getOpenBisClient().getLabelsofProperties(
  // this.getOpenBisClient().getExperimentTypeByString(experiment.getExperimentTypeCode()));
  //
  // // Image statusColor = new Image(status, this.setExperimentStatusColor(status));
  // // statusColor.setWidth(&quot;15px&quot;);
  // // statusColor.setHeight(&quot;15px&quot;);
  //
  // newExperimentBean.setId(experiment.getIdentifier());
  // newExperimentBean.setCode(experiment.getCode());
  // newExperimentBean.setType(experiment.getExperimentTypeCode());
  // newExperimentBean.setStatus(status);
  // newExperimentBean.setRegistrator(experiment.getRegistrationDetails().getUserId());
  // newExperimentBean
  // .setRegistrationDate(experiment.getRegistrationDetails().getRegistrationDate());
  // newExperimentBean.setProperties(properties);
  // newExperimentBean.setControlledVocabularies(controlledVocabularies);
  // newExperimentBean.setTypeLabels(typeLabels);
  //
  // // TODO do we want to have that ? (last Changed)
  // newExperimentBean.setLastChangedSample(null);
  // newExperimentBean.setContainsData(false);
  //
  // // Create sample Beans (or fetch them) for samples of experiment
  // BeanItemContainer&lt;SampleBean&gt; sampleBeans = new
  // BeanItemContainer&lt;SampleBean&gt;(SampleBean.class);
  // for (Sample sample : samples) {
  // SampleBean sbean = this.getSample(sample);
  // if (sbean.getDatasets().size() &gt; 0) {
  // newExperimentBean.setContainsData(true);
  // }
  // sampleBeans.addBean(sbean);
  // }
  // newExperimentBean.setSamples(sampleBeans);
  // return newExperimentBean;
  // }


  /**
   * Method to create SampleBean for sample object
   * 
   * @param sample
   * @return SampleBean for corresponding object
   */
  SampleBean createSampleBean(Sample sample) {

<span class="nc" id="L1430">    SampleBean newSampleBean = new SampleBean();</span>

<span class="nc" id="L1432">    Map&lt;String, String&gt; properties = sample.getProperties();</span>

<span class="nc" id="L1434">    newSampleBean.setId(sample.getIdentifier());</span>
<span class="nc" id="L1435">    newSampleBean.setCode(sample.getCode());</span>
<span class="nc" id="L1436">    newSampleBean.setType(sample.getSampleTypeCode());</span>
<span class="nc" id="L1437">    newSampleBean.setProperties(properties);</span>
<span class="nc" id="L1438">    List&lt;Property&gt; complexProps =</span>
<span class="nc" id="L1439">        studyParser.getFactorsAndPropertiesForSampleCode(experimentalSetup, sample.getCode());</span>
<span class="nc" id="L1440">    newSampleBean.setComplexProperties(complexProps);</span>
<span class="nc" id="L1441">    newSampleBean.setParents(this.getOpenBisClient().getParentsBySearchService(sample.getCode()));</span>
<span class="nc" id="L1442">    newSampleBean</span>
<span class="nc" id="L1443">        .setChildren(this.getOpenBisClient().getFacade().listSamplesOfSample(sample.getPermId()));</span>

<span class="nc" id="L1445">    BeanItemContainer&lt;DatasetBean&gt; datasetBeans =</span>
        new BeanItemContainer&lt;DatasetBean&gt;(DatasetBean.class);
<span class="nc" id="L1447">    List&lt;DataSet&gt; datasets =</span>
<span class="nc" id="L1448">        this.getOpenBisClient().getDataSetsOfSampleByIdentifier(sample.getIdentifier());</span>

<span class="nc" id="L1450">    Date lastModifiedDate = new Date();</span>
<span class="nc bnc" id="L1451" title="All 2 branches missed.">    if (datasets.size() &gt; 0)</span>
<span class="nc" id="L1452">      lastModifiedDate = datasets.get(0).getRegistrationDate();</span>

<span class="nc bnc" id="L1454" title="All 2 branches missed.">    for (DataSet dataset : datasets) {</span>
<span class="nc" id="L1455">      DatasetBean datasetBean = this.getDataset(dataset);</span>
<span class="nc" id="L1456">      datasetBean.setSample(newSampleBean);</span>
<span class="nc" id="L1457">      datasetBeans.addBean(datasetBean);</span>
<span class="nc" id="L1458">      Date date = dataset.getRegistrationDate();</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">      if (date.after(lastModifiedDate)) {</span>
<span class="nc" id="L1460">        lastModifiedDate.setTime(date.getTime());</span>
<span class="nc" id="L1461">        break;</span>
      }
<span class="nc" id="L1463">    }</span>

<span class="nc" id="L1465">    newSampleBean.setDatasets(datasetBeans);</span>
<span class="nc" id="L1466">    newSampleBean.setLastChangedDataset(lastModifiedDate);</span>

<span class="nc" id="L1468">    Map&lt;String, String&gt; typeLabels = this.getOpenBisClient().getLabelsofProperties(</span>
<span class="nc" id="L1469">        this.getOpenBisClient().getSampleTypeByString(sample.getSampleTypeCode()));</span>
<span class="nc" id="L1470">    newSampleBean.setTypeLabels(typeLabels);</span>

<span class="nc" id="L1472">    return newSampleBean;</span>
  }


  /**
   * Method to create DatasetBean for dataset object
   * 
   * @param dataset
   * @return DatasetBean for corresponding object
   */
  private DatasetBean createDatasetBean(DataSet dataset) {

<span class="nc" id="L1484">    DatasetBean newDatasetBean = new DatasetBean();</span>
<span class="nc" id="L1485">    FileInfoDssDTO[] filelist = dataset.listFiles(&quot;original&quot;, true);</span>
<span class="nc" id="L1486">    String download_link = filelist[0].getPathInDataSet();</span>
<span class="nc" id="L1487">    String[] splitted_link = download_link.split(&quot;/&quot;);</span>
<span class="nc" id="L1488">    String fileName = splitted_link[splitted_link.length - 1];</span>
<span class="nc" id="L1489">    newDatasetBean.setCode(dataset.getCode());</span>
<span class="nc" id="L1490">    newDatasetBean.setName(fileName);</span>
<span class="nc" id="L1491">    StringBuilder dssPath =</span>
<span class="nc" id="L1492">        new StringBuilder(dataset.getDataSetDss().tryGetInternalPathInDataStore());</span>
<span class="nc" id="L1493">    dssPath.append(&quot;/&quot;);</span>
<span class="nc" id="L1494">    dssPath.append(filelist[0].getPathInDataSet());</span>
<span class="nc" id="L1495">    newDatasetBean.setDssPath(dssPath.toString());</span>
<span class="nc" id="L1496">    newDatasetBean.setType(dataset.getDataSetTypeCode());</span>
<span class="nc" id="L1497">    newDatasetBean.setFileSize(filelist[0].getFileSize());</span>
    // TODO
    // newDatasetBean.setRegistrator(registrator);
<span class="nc" id="L1500">    newDatasetBean.setRegistrationDate(dataset.getRegistrationDate());</span>

<span class="nc" id="L1502">    newDatasetBean.setParent(null);</span>
<span class="nc" id="L1503">    newDatasetBean.setRoot(newDatasetBean);</span>

<span class="nc" id="L1505">    newDatasetBean.setSelected(false);</span>


<span class="nc bnc" id="L1508" title="All 2 branches missed.">    if (filelist[0].isDirectory()) {</span>
<span class="nc" id="L1509">      newDatasetBean.setDirectory(filelist[0].isDirectory());</span>
<span class="nc" id="L1510">      String folderPath = filelist[0].getPathInDataSet();</span>
<span class="nc" id="L1511">      FileInfoDssDTO[] subList = dataset.listFiles(folderPath, false);</span>
<span class="nc" id="L1512">      datasetBeanChildren(newDatasetBean, subList, dataset);</span>
    }

    // TODO
    // this.fileSize = fileSize;
    // this.humanReadableFileSize = humanReadableFileSize;
    // this.dssPath = dssPath;
<span class="nc" id="L1519">    return newDatasetBean;</span>
  }

  public void datasetBeanChildren(DatasetBean datasetBean, FileInfoDssDTO[] fileList, DataSet d) {
<span class="nc" id="L1523">    ArrayList&lt;DatasetBean&gt; beans = new ArrayList&lt;DatasetBean&gt;();</span>
<span class="nc bnc" id="L1524" title="All 2 branches missed.">    for (FileInfoDssDTO dto : fileList) {</span>
<span class="nc" id="L1525">      DatasetBean newBean = new DatasetBean();</span>
<span class="nc" id="L1526">      newBean.setCode(datasetBean.getCode());</span>
<span class="nc" id="L1527">      StringBuilder dssPath = new StringBuilder(datasetBean.getDssPath());</span>
<span class="nc" id="L1528">      dssPath.append(&quot;/&quot;);</span>
<span class="nc" id="L1529">      dssPath.append(dto.getPathInDataSet());</span>
<span class="nc" id="L1530">      newBean.setDssPath(dssPath.toString());</span>
<span class="nc" id="L1531">      newBean.setExperiment(datasetBean.getExperiment());</span>
<span class="nc" id="L1532">      String download_link = dto.getPathInDataSet();</span>
<span class="nc" id="L1533">      String[] splitted_link = download_link.split(&quot;/&quot;);</span>
<span class="nc" id="L1534">      newBean.setFileName(splitted_link[splitted_link.length - 1]);</span>
<span class="nc" id="L1535">      newBean.setFileSize(dto.getFileSize());</span>
<span class="nc" id="L1536">      newBean.setFileType(d.getDataSetTypeCode());</span>
<span class="nc" id="L1537">      newBean.setHumanReadableFileSize(PortalUtils.humanReadableByteCount(dto.getFileSize(), true));</span>
<span class="nc" id="L1538">      newBean.setParent(datasetBean);</span>
<span class="nc" id="L1539">      newBean.setProject(datasetBean.getProject());</span>
<span class="nc" id="L1540">      newBean.setRegistrationDate(datasetBean.getRegistrationDate());</span>
<span class="nc" id="L1541">      newBean.setRegistrator(datasetBean.getRegistrator());</span>
<span class="nc" id="L1542">      newBean.setRoot(datasetBean.getRoot());</span>
<span class="nc" id="L1543">      newBean.setSample(datasetBean.getSample());</span>
<span class="nc" id="L1544">      newBean.setSelected(datasetBean.getIsSelected().getValue());</span>
<span class="nc" id="L1545">      newBean.setDirectory(false);</span>
<span class="nc bnc" id="L1546" title="All 2 branches missed.">      if (dto.isDirectory()) {</span>
<span class="nc" id="L1547">        newBean.setDirectory(true);</span>
<span class="nc" id="L1548">        String folderPath = dto.getPathInDataSet();</span>
<span class="nc" id="L1549">        FileInfoDssDTO[] subList = d.listFiles(folderPath, false);</span>
<span class="nc" id="L1550">        datasetBeanChildren(newBean, subList, d);</span>
      }
<span class="nc" id="L1552">      beans.add(newBean);</span>

    }
<span class="nc" id="L1555">    datasetBean.setChildren(beans);</span>
<span class="nc" id="L1556">  }</span>

  /*
   * @SuppressWarnings(&quot;unchecked&quot;) private BeanItemContainer&lt;ProjectBean&gt;
   * createProjectContainer(List&lt;Project&gt; projs, String spaceID) throws Exception {
   * 
   * BeanItemContainer&lt;ProjectBean&gt; res = new BeanItemContainer&lt;ProjectBean&gt;(ProjectBean.class);
   * 
   * // project_container.addContainerProperty(&quot;Description&quot;, String.class, null); //
   * project_container.addContainerProperty(&quot;Space&quot;, String.class, null); //
   * project_container.addContainerProperty(&quot;Registration Date&quot;, Timestamp.class, null); //
   * project_container.addContainerProperty(&quot;Registrator&quot;, String.class, null); //
   * project_container.addContainerProperty(&quot;Progress&quot;, ProgressBar.class, null); SpaceBean space =
   * new SpaceBean(); space.setId(spaceID); // TODO do we need more space information at this point?
   * for (Project p : projs) { ProgressBar progressBar = new ProgressBar();
   * progressBar.setValue(this.openBisClient.computeProjectStatus(p)); Date date =
   * p.getRegistrationDetails().getRegistrationDate(); SimpleDateFormat sd = new SimpleDateFormat(
   * &quot;yyyy-MM-dd hh:mm:ss&quot;); String dateString = sd.format(date); Timestamp ts =
   * Timestamp.valueOf(dateString); ProjectBean b = new ProjectBean(p.getIdentifier(), p.getCode(),
   * p.getDescription(), space, getExperiments(p.getIdentifier(), &quot;project&quot;), progressBar, ts, p
   * .getRegistrationDetails().getUserId(), p.getRegistrationDetails().getUserEmail(),
   * (List&lt;String&gt;) getSpaceMembers(spaceID), datasetMap.get(p.getIdentifier()) != null);
   * res.addBean(b); // Object new_p = project_container.addItem(); // // String code = p.getCode();
   * // String desc = p.getDescription(); // // String space = code.split(&quot;/&quot;)[1]; // // String
   * registrator = p.getRegistrationDetails().getUserId(); //
   * 
   * //
   * 
   * // // project_container.getContainerProperty(new_p, &quot;Space&quot;).setValue(space); //
   * project_container.getContainerProperty(new_p, &quot;Description&quot;).setValue(desc); //
   * project_container.getContainerProperty(new_p, &quot;Registration Date&quot;).setValue(ts); //
   * project_container.getContainerProperty(new_p, &quot;Registerator&quot;).setValue(registrator); //
   * project_container.getContainerProperty(new_p, &quot;Progress&quot;).setValue(progressBar); }
   * 
   * return res; }
   */
  /*
   * @SuppressWarnings(&quot;unchecked&quot;) private BeanItemContainer&lt;ExperimentBean&gt;
   * createExperimentContainer(List&lt;Experiment&gt; exps, String projID) {
   * 
   * BeanItemContainer&lt;ExperimentBean&gt; res = new
   * BeanItemContainer&lt;ExperimentBean&gt;(ExperimentBean.class);
   * 
   * // project_container.addContainerProperty(&quot;Description&quot;, String.class, null); //
   * project_container.addContainerProperty(&quot;Space&quot;, String.class, null); //
   * project_container.addContainerProperty(&quot;Registration Date&quot;, Timestamp.class, null); //
   * project_container.addContainerProperty(&quot;Registrator&quot;, String.class, null); //
   * project_container.addContainerProperty(&quot;Progress&quot;, ProgressBar.class, null);
   * 
   * 
   * 
   * 
   * 
   * 
   * IndexedContainer experiment_container = new IndexedContainer();
   * 
   * experiment_container.addContainerProperty(&quot;Experiment&quot;, String.class, null);
   * experiment_container.addContainerProperty(&quot;Experiment Type&quot;, String.class, null);
   * experiment_container.addContainerProperty(&quot;Registration Date&quot;, Timestamp.class, null);
   * experiment_container.addContainerProperty(&quot;Registrator&quot;, String.class, null);
   * experiment_container.addContainerProperty(&quot;Status&quot;, Image.class, null); //
   * experiment_container.addContainerProperty(&quot;Properties&quot;, Map.class, null); ProjectBean space =
   * new ProjectBean(); space.setId(spaceID); // TODO do we need more space information at this
   * point? for (Experiment e : exps) { ProgressBar progressBar = new ProgressBar();
   * progressBar.setValue(this.openBisClient.computeProjectStatus(p)); Date date =
   * p.getRegistrationDetails().getRegistrationDate(); SimpleDateFormat sd = new SimpleDateFormat(
   * &quot;yyyy-MM-dd hh:mm:ss&quot;); String dateString = sd.format(date); Timestamp ts =
   * Timestamp.valueOf(dateString); ExperimentBean e = new ExperimentBean(id, code, type, status,
   * registrator, project, registrationDate, samples, lastChangedSample, lastChangedDataset,
   * properties, controlledVocabularies) ProjectBean b = new ProjectBean(p.getIdentifier(),
   * p.getCode(), p.getDescription(), space, getExperiments(p.getIdentifier(), &quot;project&quot;),
   * progressBar, ts, p .getRegistrationDetails().getUserId(),
   * p.getRegistrationDetails().getUserEmail(), (List&lt;String&gt;) getSpaceMembers(spaceID),
   * datasetMap.get(p.getIdentifier()) != null); res.addBean(b);
   * 
   * 
   * 
   * 
   * for (Experiment e : exps) { Object new_ds = experiment_container.addItem();
   * 
   * String type = this.openBisClient.openBIScodeToString(e.getExperimentTypeCode());
   * 
   * Map&lt;String, String&gt; properties = e.getProperties();
   * 
   * String status = &quot;&quot;;
   * 
   * if (properties.keySet().contains(&quot;Q_CURRENT_STATUS&quot;)) { status =
   * properties.get(&quot;Q_CURRENT_STATUS&quot;); }
   * 
   * Date date = e.getRegistrationDetails().getRegistrationDate(); String registrator =
   * e.getRegistrationDetails().getUserId();
   * 
   * SimpleDateFormat sd = new SimpleDateFormat(&quot;yyyy-MM-dd hh:mm:ss&quot;); String dateString =
   * sd.format(date); Timestamp ts = Timestamp.valueOf(dateString);
   * experiment_container.getContainerProperty(new_ds, &quot;Experiment&quot;).setValue(e.getCode());
   * experiment_container.getContainerProperty(new_ds, &quot;Experiment Type&quot;).setValue(type);
   * experiment_container.getContainerProperty(new_ds, &quot;Registration Date&quot;).setValue(ts);
   * experiment_container.getContainerProperty(new_ds, &quot;Registrator&quot;).setValue(registrator);
   * 
   * Image statusColor = new Image(status, this.setExperimentStatusColor(status));
   * statusColor.setWidth(&quot;15px&quot;); statusColor.setHeight(&quot;15px&quot;);
   * experiment_container.getContainerProperty(new_ds, &quot;Status&quot;).setValue(statusColor); //
   * experiment_container.getContainerProperty(new_ds, // &quot;Properties&quot;).setValue(e.getProperties());
   * }
   * 
   * return experiment_container; }
   */

  /*
   * beans.add(newBean);
   * 
   * @SuppressWarnings(&quot;unchecked&quot;) private BeanItemContainer&lt;SampleBean&gt;
   * createSampleContainer(List&lt;Sample&gt; samples, String id) {
   * 
   * IndexedContainer sample_container = new IndexedContainer();
   * sample_container.addContainerProperty(&quot;Sample&quot;, String.class, null);
   * sample_container.addContainerProperty(&quot;Description&quot;, String.class, null);
   * sample_container.addContainerProperty(&quot;Sample Type&quot;, String.class, null);
   * sample_container.addContainerProperty(&quot;Registration Date&quot;, Timestamp.class, null); //
   * sample_container.addContainerProperty(&quot;Species&quot;, String.class, null);
   * 
   * for (Sample s : samples) { Object new_ds = sample_container.addItem();
   * 
   * String type = this.openBisClient.openBIScodeToString(s.getSampleTypeCode());
   * 
   * Date date = s.getRegistrationDetails().getRegistrationDate(); Map&lt;String, String&gt; properties =
   * s.getProperties(); SimpleDateFormat sd = new SimpleDateFormat(&quot;yyyy-MM-dd hh:mm:ss&quot;); String
   * dateString = sd.format(date); Timestamp ts = Timestamp.valueOf(dateString);
   * sample_container.getContainerProperty(new_ds, &quot;Sample&quot;).setValue(s.getCode()); //
   * sample_container.getContainerProperty(new_ds, //
   * &quot;Description&quot;).setValue(properties.get(&quot;SAMPLE_CLASS&quot;));
   * sample_container.getContainerProperty(new_ds, &quot;Description&quot;).setValue(
   * properties.get(&quot;Q_SECONDARY_NAME&quot;)); sample_container.getContainerProperty(new_ds,
   * &quot;Sample Type&quot;).setValue(type); sample_container.getContainerProperty(new_ds,
   * &quot;Registration Date&quot;).setValue(ts); // sample_container.getContainerProperty(new_ds, //
   * &quot;Species&quot;).setValue(properties.get(&quot;SPECIES&quot;)); }
   * 
   * return sample_container; }
   */
  /*
   * private BeanItemContainer&lt;DatasetBean&gt; createDatasetContainer(List&lt;DataSet&gt; datasets, String
   * id) {
   * 
   * HierarchicalContainer dataset_container = new HierarchicalContainer();
   * 
   * dataset_container.addContainerProperty(&quot;Select&quot;, CheckBox.class, null);
   * dataset_container.addContainerProperty(&quot;Project&quot;, String.class, null);
   * dataset_container.addContainerProperty(&quot;Sample&quot;, String.class, null);
   * dataset_container.addContainerProperty(&quot;Sample Type&quot;, String.class, null);
   * dataset_container.addContainerProperty(&quot;File Name&quot;, String.class, null);
   * dataset_container.addContainerProperty(&quot;File Type&quot;, String.class, null);
   * dataset_container.addContainerProperty(&quot;Dataset Type&quot;, String.class, null);
   * dataset_container.addContainerProperty(&quot;Registration Date&quot;, Timestamp.class, null);
   * dataset_container.addContainerProperty(&quot;Validated&quot;, Boolean.class, null);
   * dataset_container.addContainerProperty(&quot;File Size&quot;, String.class, null);
   * dataset_container.addContainerProperty(&quot;file_size_bytes&quot;, Long.class, null);
   * dataset_container.addContainerProperty(&quot;dl_link&quot;, String.class, null);
   * dataset_container.addContainerProperty(&quot;CODE&quot;, String.class, null);
   * 
   * for (DataSet d : datasets) { String identifier = d.getSampleIdentifierOrNull(); Sample
   * sampleObject = this.openBisClient.getSampleByIdentifier(identifier); String sample =
   * sampleObject.getCode(); String sampleType =
   * this.openBisClient.getSampleByIdentifier(sample).getSampleTypeCode(); Project projectObject =
   * this.openBisClient.getProjectOfExperimentByIdentifier(sampleObject
   * .getExperimentIdentifierOrNull()); String project = projectObject.getCode(); // String code =
   * d.getSampleIdentifierOrNull(); // String sample = code.split(&quot;/&quot;)[2]; // String project =
   * sample.substring(0, 5); Date date = d.getRegistrationDate();
   * 
   * SimpleDateFormat sd = new SimpleDateFormat(&quot;yyyy-MM-dd hh:mm:ss&quot;); String dateString =
   * sd.format(date); Timestamp ts = Timestamp.valueOf(dateString);
   * 
   * FileInfoDssDTO[] filelist = d.listFiles(&quot;original&quot;, true);
   * 
   * // recursive test registerDatasetInTable(d, filelist, dataset_container, project, sample, ts,
   * sampleType, null);
   * 
   * }
   * 
   * return dataset_container; }
   */

  public void registerDatasetInTable(DataSet d, FileInfoDssDTO[] filelist,
      HierarchicalContainer dataset_container, String project, String sample, Timestamp ts,
      String sampleType, Object parent) {
<span class="nc bnc" id="L1740" title="All 2 branches missed.">    if (filelist[0].isDirectory()) {</span>

<span class="nc" id="L1742">      Object new_ds = dataset_container.addItem();</span>

<span class="nc" id="L1744">      String folderPath = filelist[0].getPathInDataSet();</span>
<span class="nc" id="L1745">      FileInfoDssDTO[] subList = d.listFiles(folderPath, false);</span>

<span class="nc" id="L1747">      dataset_container.setChildrenAllowed(new_ds, true);</span>
<span class="nc" id="L1748">      String download_link = filelist[0].getPathInDataSet();</span>
<span class="nc" id="L1749">      String[] splitted_link = download_link.split(&quot;/&quot;);</span>
<span class="nc" id="L1750">      String file_name = download_link.split(&quot;/&quot;)[splitted_link.length - 1];</span>

<span class="nc" id="L1752">      dataset_container.getContainerProperty(new_ds, &quot;Select&quot;).setValue(new CheckBox());</span>

<span class="nc" id="L1754">      dataset_container.getContainerProperty(new_ds, &quot;Project&quot;).setValue(project);</span>
<span class="nc" id="L1755">      dataset_container.getContainerProperty(new_ds, &quot;Sample&quot;).setValue(sample);</span>
<span class="nc" id="L1756">      dataset_container.getContainerProperty(new_ds, &quot;Sample Type&quot;)</span>
<span class="nc" id="L1757">          .setValue(this.getOpenBisClient().getSampleByIdentifier(sample).getSampleTypeCode());</span>
<span class="nc" id="L1758">      dataset_container.getContainerProperty(new_ds, &quot;File Name&quot;).setValue(file_name);</span>
<span class="nc" id="L1759">      dataset_container.getContainerProperty(new_ds, &quot;File Type&quot;).setValue(&quot;Folder&quot;);</span>
<span class="nc" id="L1760">      dataset_container.getContainerProperty(new_ds, &quot;Dataset Type&quot;).setValue(&quot;-&quot;);</span>
<span class="nc" id="L1761">      dataset_container.getContainerProperty(new_ds, &quot;Registration Date&quot;).setValue(ts);</span>
<span class="nc" id="L1762">      dataset_container.getContainerProperty(new_ds, &quot;Validated&quot;).setValue(true);</span>
<span class="nc" id="L1763">      dataset_container.getContainerProperty(new_ds, &quot;dl_link&quot;).setValue(</span>
<span class="nc" id="L1764">          d.getDataSetDss().tryGetInternalPathInDataStore() + &quot;/&quot; + filelist[0].getPathInDataSet());</span>
<span class="nc" id="L1765">      dataset_container.getContainerProperty(new_ds, &quot;CODE&quot;).setValue(d.getCode());</span>
<span class="nc" id="L1766">      dataset_container.getContainerProperty(new_ds, &quot;file_size_bytes&quot;)</span>
<span class="nc" id="L1767">          .setValue(filelist[0].getFileSize());</span>

      // System.out.println(&quot;Now it should be a folder: &quot; + filelist[0].getPathInDataSet());

<span class="nc bnc" id="L1771" title="All 2 branches missed.">      if (parent != null) {</span>
<span class="nc" id="L1772">        dataset_container.setParent(new_ds, parent);</span>
      }

<span class="nc bnc" id="L1775" title="All 2 branches missed.">      for (FileInfoDssDTO file : subList) {</span>
<span class="nc" id="L1776">        FileInfoDssDTO[] childList = {file};</span>
<span class="nc" id="L1777">        registerDatasetInTable(d, childList, dataset_container, project, sample, ts, sampleType,</span>
            new_ds);
      }

<span class="nc" id="L1781">    } else {</span>
      // System.out.println(&quot;Now it should be a file: &quot; + filelist[0].getPathInDataSet());

<span class="nc" id="L1784">      Object new_file = dataset_container.addItem();</span>
<span class="nc" id="L1785">      dataset_container.setChildrenAllowed(new_file, false);</span>
<span class="nc" id="L1786">      String download_link = filelist[0].getPathInDataSet();</span>
<span class="nc" id="L1787">      String[] splitted_link = download_link.split(&quot;/&quot;);</span>
<span class="nc" id="L1788">      String file_name = download_link.split(&quot;/&quot;)[splitted_link.length - 1];</span>
      // String file_name = download_link.split(&quot;/&quot;)[1];
<span class="nc" id="L1790">      String fileSize = PortalUtils.humanReadableByteCount(filelist[0].getFileSize(), true);</span>

<span class="nc" id="L1792">      dataset_container.getContainerProperty(new_file, &quot;Select&quot;).setValue(new CheckBox());</span>
<span class="nc" id="L1793">      dataset_container.getContainerProperty(new_file, &quot;Project&quot;).setValue(project);</span>
<span class="nc" id="L1794">      dataset_container.getContainerProperty(new_file, &quot;Sample&quot;).setValue(sample);</span>
<span class="nc" id="L1795">      dataset_container.getContainerProperty(new_file, &quot;Sample Type&quot;).setValue(sampleType);</span>
<span class="nc" id="L1796">      dataset_container.getContainerProperty(new_file, &quot;File Name&quot;).setValue(file_name);</span>
<span class="nc" id="L1797">      dataset_container.getContainerProperty(new_file, &quot;File Type&quot;)</span>
<span class="nc" id="L1798">          .setValue(d.getDataSetTypeCode());</span>
<span class="nc" id="L1799">      dataset_container.getContainerProperty(new_file, &quot;Dataset Type&quot;)</span>
<span class="nc" id="L1800">          .setValue(d.getDataSetTypeCode());</span>
<span class="nc" id="L1801">      dataset_container.getContainerProperty(new_file, &quot;Registration Date&quot;).setValue(ts);</span>
<span class="nc" id="L1802">      dataset_container.getContainerProperty(new_file, &quot;Validated&quot;).setValue(true);</span>
<span class="nc" id="L1803">      dataset_container.getContainerProperty(new_file, &quot;File Size&quot;).setValue(fileSize);</span>
<span class="nc" id="L1804">      dataset_container.getContainerProperty(new_file, &quot;dl_link&quot;).setValue(</span>
<span class="nc" id="L1805">          d.getDataSetDss().tryGetInternalPathInDataStore() + &quot;/&quot; + filelist[0].getPathInDataSet());</span>
<span class="nc" id="L1806">      dataset_container.getContainerProperty(new_file, &quot;CODE&quot;).setValue(d.getCode());</span>
<span class="nc" id="L1807">      dataset_container.getContainerProperty(new_file, &quot;file_size_bytes&quot;)</span>
<span class="nc" id="L1808">          .setValue(filelist[0].getFileSize());</span>
<span class="nc bnc" id="L1809" title="All 2 branches missed.">      if (parent != null) {</span>
<span class="nc" id="L1810">        dataset_container.setParent(new_file, parent);</span>
      }
    }
<span class="nc" id="L1813">  }</span>

  /**
   * Function to fill tree container and collect statistical information of spaces. Should replace
   * the two functions and be somewhat faster. Still not pretty. Needs work
   * 
   * @param tc HierarchicalContainer for the Tree
   * @param userName Screenname of the Liferay User
   * @return SpaceInformation object
   */
  // public SpaceInformation initTreeAndHomeInfo(HierarchicalContainer tc, String userName) {
  //
  // List&lt;SpaceWithProjectsAndRoleAssignments&gt; space_list = this.getSpacesWithProjectInformation();
  //
  // // Initialization of Tree Container
  // tc.addContainerProperty(&quot;identifier&quot;, String.class, &quot;N/A&quot;);
  // tc.addContainerProperty(&quot;type&quot;, String.class, &quot;N/A&quot;);
  // tc.addContainerProperty(&quot;project&quot;, String.class, &quot;N/A&quot;);
  // tc.addContainerProperty(&quot;caption&quot;, String.class, &quot;N/A&quot;);
  //
  //
  // // Initialization of Home Information
  // SpaceInformation homeInformation = new SpaceInformation();
  // IndexedContainer space_container = new IndexedContainer();
  // space_container.addContainerProperty(&quot;Project&quot;, String.class, &quot;&quot;);
  // space_container.addContainerProperty(&quot;Description&quot;, String.class, &quot;&quot;);
  // space_container.addContainerProperty(&quot;Contains datasets&quot;, String.class, &quot;&quot;);
  // int number_of_projects = 0;
  // int number_of_experiments = 0;
  // int number_of_samples = 0;
  // int number_of_datasets = 0;
  // String lastModifiedExperiment = &quot;N/A&quot;;
  // String lastModifiedSample = &quot;N/A&quot;;
  // Date lastModifiedDate = new Date(0, 0, 0);
  // for (SpaceWithProjectsAndRoleAssignments s : space_list) {
  // if (s.getUsers().contains(userName)) {
  // String space_name = s.getCode();
  //
  // // TODO does this work for everyone? should it? empty container would be the aim, probably
  // if (space_name.equals(&quot;QBIC_USER_SPACE&quot;)) {
  // fillPersonsContainer(space_name);
  // }
  //
  // List&lt;Project&gt; projects = s.getProjects();
  // number_of_projects += projects.size();
  // List&lt;String&gt; project_identifiers_tmp = new ArrayList&lt;String&gt;();
  // for (Project project : projects) {
  //
  // String project_name = project.getCode();
  // if (tc.containsId(project_name)) {
  // project_name = project.getIdentifier();
  // }
  // Object new_s = space_container.addItem();
  // space_container.getContainerProperty(new_s, &quot;Project&quot;).setValue(project_name);
  //
  // // Project descriptions can be long; truncate the string to provide a brief preview
  // String desc = project.getDescription();
  //
  // if (desc != null &amp;&amp; desc.length() &gt; 0) {
  // desc = desc.substring(0, Math.min(desc.length(), 100));
  // if (desc.length() == 100) {
  // desc += &quot;...&quot;;
  // }
  // }
  // space_container.getContainerProperty(new_s, &quot;Description&quot;).setValue(desc);
  //
  // // System.out.println(&quot;|--Project: &quot; + project_name);
  // tc.addItem(project_name);
  //
  // tc.getContainerProperty(project_name, &quot;type&quot;).setValue(&quot;project&quot;);
  // tc.getContainerProperty(project_name, &quot;identifier&quot;).setValue(project_name);
  // tc.getContainerProperty(project_name, &quot;project&quot;).setValue(project_name);
  // tc.getContainerProperty(project_name, &quot;caption&quot;).setValue(project_name);
  //
  // List&lt;Project&gt; tmp_list = new ArrayList&lt;Project&gt;();
  // tmp_list.add(project);
  // List&lt;Experiment&gt; experiments =
  // this.openBisClient.getOpenbisInfoService().listExperiments(
  // this.openBisClient.getSessionToken(), tmp_list, null);
  //
  // // Add number of experiments for every project
  // number_of_experiments += experiments.size();
  //
  // List&lt;String&gt; experiment_identifiers = new ArrayList&lt;String&gt;();
  //
  // for (Experiment experiment : experiments) {
  // experiment_identifiers.add(experiment.getIdentifier());
  // String experiment_name = experiment.getCode();
  // if (tc.containsId(experiment_name)) {
  // experiment_name = experiment.getIdentifier();
  // }
  // // System.out.println(&quot; |--Experiment: &quot; + experiment_name);
  // tc.addItem(experiment_name);
  // tc.setParent(experiment_name, project_name);
  // tc.getContainerProperty(experiment_name, &quot;type&quot;).setValue(&quot;experiment&quot;);
  // tc.getContainerProperty(experiment_name, &quot;identifier&quot;).setValue(experiment_name);
  // tc.getContainerProperty(experiment_name, &quot;project&quot;).setValue(project_name);
  // tc.getContainerProperty(experiment_name, &quot;caption&quot;).setValue(
  // String.format(&quot;%s (%s)&quot;,
  // this.openBisClient.openBIScodeToString(experiment.getExperimentTypeCode()),
  // experiment_name));
  //
  // tc.setChildrenAllowed(experiment_name, false);
  // }
  // if (experiment_identifiers.size() &gt; 0
  // &amp;&amp; this.openBisClient.getFacade().listDataSetsForExperiments(experiment_identifiers)
  // .size() &gt; 0) {
  // space_container.getContainerProperty(new_s, &quot;Contains datasets&quot;).setValue(&quot;yes&quot;);
  // } else {
  // space_container.getContainerProperty(new_s, &quot;Contains datasets&quot;).setValue(&quot;no&quot;);
  // }
  // }
  // List&lt;Sample&gt; samplesOfSpace = new ArrayList&lt;Sample&gt;();
  // if (project_identifiers_tmp.size() &gt; 0) {
  // samplesOfSpace =
  // this.openBisClient.getFacade().listSamplesForProjects(project_identifiers_tmp);
  // } else {
  // samplesOfSpace = this.openBisClient.getSamplesofSpace(space_name); // TODO code or
  // // identifier
  // // needed?
  // }
  // number_of_samples += samplesOfSpace.size();
  // List&lt;String&gt; sample_identifiers_tmp = new ArrayList&lt;String&gt;();
  // for (Sample sa : samplesOfSpace) {
  // sample_identifiers_tmp.add(sa.getIdentifier());
  // }
  // List&lt;DataSet&gt; datasets = new ArrayList&lt;DataSet&gt;();
  // if (sample_identifiers_tmp.size() &gt; 0) {
  // datasets = this.openBisClient.getFacade().listDataSetsForSamples(sample_identifiers_tmp);
  // }
  // number_of_datasets += datasets.size();
  // StringBuilder lce = new StringBuilder();
  // StringBuilder lcs = new StringBuilder();
  // this.lastDatasetRegistered(datasets, lastModifiedDate, lce, lcs);
  // String tmplastModifiedExperiment = lce.toString();
  // String tmplastModifiedSample = lcs.toString();
  // if (!tmplastModifiedSample.equals(&quot;N/A&quot;)) {
  // lastModifiedExperiment = tmplastModifiedExperiment;
  // lastModifiedSample = tmplastModifiedSample;
  // }
  // }
  // }
  // homeInformation.numberOfProjects = number_of_projects;
  // homeInformation.numberOfExperiments = number_of_experiments;
  // homeInformation.numberOfSamples = number_of_samples;
  // homeInformation.numberOfDatasets = number_of_datasets;
  // homeInformation.lastChangedDataset = lastModifiedDate;
  // homeInformation.lastChangedSample = lastModifiedSample;
  // homeInformation.lastChangedExperiment = lastModifiedExperiment;
  // homeInformation.projects = space_container;
  //
  // return homeInformation;
  // }

  /**
   * Creates a Map of project statuses fulfilled, keyed by their meaning. For this, different steps
   * in the project flow are checked by looking at experiment types and data registered
   * 
   * @param projectBean
   * @return
   */
  public Map&lt;String, Integer&gt; computeProjectStatuses(ProjectBean projectBean) {

    // Project p = this.openBisClient.getProjectByCode(projectId);
<span class="nc" id="L1977">    Map&lt;String, Integer&gt; res = new HashMap&lt;String, Integer&gt;();</span>
<span class="nc" id="L1978">    BeanItemContainer&lt;ExperimentBean&gt; cont = projectBean.getExperiments();</span>

    // project was planned (otherwise it would hopefully not exist :) )
<span class="nc" id="L1981">    res.put(&quot;Project planned&quot;, 1);</span>

    // design is pre-registered to the test sample level
<span class="nc" id="L1984">    int prereg = 0;</span>
<span class="nc bnc" id="L1985" title="All 2 branches missed.">    for (ExperimentBean bean : cont.getItemIds()) {</span>
<span class="nc" id="L1986">      String type = bean.getType();</span>

<span class="nc bnc" id="L1988" title="All 2 branches missed.">      if (type.equals(&quot;Q_EXPERIMENTAL_DESIGN&quot;)) {</span>
<span class="nc" id="L1989">        prereg = 1;</span>
<span class="nc" id="L1990">        break;</span>
      }
<span class="nc" id="L1992">    }</span>
<span class="nc" id="L1993">    res.put(&quot;Experimental design registered&quot;, prereg);</span>
    // data is uploaded
    // TODO fix that
    // if (datasetMap.get(p.getIdentifier()) != null)
    // res.put(&quot;Data Registered&quot;, 1);
    // else
<span class="nc bnc" id="L1999" title="All 2 branches missed.">    int dataregistered = projectBean.getContainsData() ? 1 : 0;</span>
<span class="nc bnc" id="L2000" title="All 2 branches missed.">    int resultsregistered = projectBean.getContainsResults() ? 1 : 0;</span>
    // int attachmentsregistered = projectBean.getContainsAttachments() ? 1 : 0;

    // res.put(&quot;Attachments registered&quot;, attachmentsregistered);
<span class="nc" id="L2004">    res.put(&quot;Raw data registered&quot;, dataregistered);</span>
<span class="nc" id="L2005">    res.put(&quot;Results registered&quot;, resultsregistered);</span>

<span class="nc" id="L2007">    return res;</span>
  }

  public BeanItemContainer&lt;ExperimentStatusBean&gt; computeIvacPatientStatus(ProjectBean projectBean) {

<span class="nc" id="L2012">    BeanItemContainer&lt;ExperimentStatusBean&gt; res =</span>
        new BeanItemContainer&lt;ExperimentStatusBean&gt;(ExperimentStatusBean.class);
<span class="nc" id="L2014">    BeanItemContainer&lt;ExperimentBean&gt; cont = projectBean.getExperiments();</span>

    // TODO set download link and workflow triggering
    // TODO add immune monitoring, report generation, vaccine design

<span class="nc" id="L2019">    ExperimentStatusBean barcode = new ExperimentStatusBean();</span>
<span class="nc" id="L2020">    barcode.setDescription(&quot;Barcode Generation&quot;);</span>
<span class="nc" id="L2021">    barcode.setStatus(1.0);</span>

<span class="nc" id="L2023">    ExperimentStatusBean ngsCall = new ExperimentStatusBean();</span>
<span class="nc" id="L2024">    ngsCall.setDescription(&quot;Variant Calling&quot;);</span>
<span class="nc" id="L2025">    ngsCall.setStatus(0.0);</span>

<span class="nc" id="L2027">    ExperimentStatusBean hlaType = new ExperimentStatusBean();</span>
<span class="nc" id="L2028">    hlaType.setDescription(&quot;HLA Typing&quot;);</span>
<span class="nc" id="L2029">    hlaType.setStatus(0.0);</span>

<span class="nc" id="L2031">    ExperimentStatusBean variantAnno = new ExperimentStatusBean();</span>
<span class="nc" id="L2032">    variantAnno.setDescription(&quot;Variant Annotation&quot;);</span>
<span class="nc" id="L2033">    variantAnno.setStatus(0.0);</span>

<span class="nc" id="L2035">    ExperimentStatusBean epitopePred = new ExperimentStatusBean();</span>
<span class="nc" id="L2036">    epitopePred.setDescription(&quot;Epitope Prediction&quot;);</span>
<span class="nc" id="L2037">    epitopePred.setStatus(0.0);</span>

<span class="nc bnc" id="L2039" title="All 2 branches missed.">    for (ExperimentBean bean : cont.getItemIds()) {</span>
<span class="nc" id="L2040">      String type = bean.getType();</span>

<span class="nc bnc" id="L2042" title="All 2 branches missed.">      Double experimentStatus = bean.getProperties().get(&quot;Q_CURRENT_STATUS&quot;) == null ? 0.0</span>
          : OpenBisFunctions
<span class="nc" id="L2044">              .statusToDoubleValue(bean.getProperties().get(&quot;Q_CURRENT_STATUS&quot;).toString());</span>
<span class="nc bnc" id="L2045" title="All 2 branches missed.">      if (type.equalsIgnoreCase(ExperimentType.Q_NGS_MEASUREMENT.name())) {</span>

<span class="nc" id="L2047">        ExperimentStatusBean ngsMeasure = new ExperimentStatusBean();</span>
<span class="nc" id="L2048">        ngsMeasure.setDescription(&quot;NGS Sequencing&quot;);</span>
<span class="nc" id="L2049">        ngsMeasure.setStatus(0.0);</span>
<span class="nc" id="L2050">        ngsMeasure.setStatus(experimentStatus);</span>
<span class="nc" id="L2051">        ngsMeasure.setCode(bean.getCode());</span>
<span class="nc" id="L2052">        ngsMeasure.setIdentifier(bean.getId());</span>

<span class="nc" id="L2054">        res.addBean(ngsMeasure);</span>
      }
<span class="nc bnc" id="L2056" title="All 2 branches missed.">      if (type.equalsIgnoreCase(ExperimentType.Q_NGS_VARIANT_CALLING.name())) {</span>
<span class="nc" id="L2057">        ngsCall.setStatus(experimentStatus);</span>
<span class="nc" id="L2058">        ngsCall.setCode(bean.getCode());</span>
<span class="nc" id="L2059">        ngsCall.setIdentifier(bean.getId());</span>
      }
<span class="nc" id="L2061">      if (type.equalsIgnoreCase(ExperimentType.Q_NGS_HLATYPING.name())</span>
<span class="nc bnc" id="L2062" title="All 2 branches missed.">          | type.equalsIgnoreCase(ExperimentType.Q_WF_NGS_HLATYPING.name())) {</span>
<span class="nc bnc" id="L2063" title="All 2 branches missed.">        if (type.equalsIgnoreCase(ExperimentType.Q_WF_NGS_HLATYPING.name())) {</span>
<span class="nc" id="L2064">          hlaType.setStatus(OpenBisFunctions</span>
<span class="nc" id="L2065">              .statusToDoubleValue(bean.getProperties().get(&quot;Q_WF_STATUS&quot;).toString()));</span>
        } else {
<span class="nc" id="L2067">          hlaType.setStatus(experimentStatus);</span>
        }
<span class="nc" id="L2069">        hlaType.setCode(bean.getCode());</span>
<span class="nc" id="L2070">        hlaType.setIdentifier(bean.getId());</span>
      }
<span class="nc bnc" id="L2072" title="All 2 branches missed.">      if (type.equalsIgnoreCase(ExperimentType.Q_WF_NGS_VARIANT_ANNOTATION.name())) {</span>
<span class="nc" id="L2073">        variantAnno.setStatus(OpenBisFunctions</span>
<span class="nc" id="L2074">            .statusToDoubleValue(bean.getProperties().get(&quot;Q_WF_STATUS&quot;).toString()));</span>
<span class="nc" id="L2075">        variantAnno.setCode(bean.getCode());</span>
<span class="nc" id="L2076">        variantAnno.setIdentifier(bean.getId());</span>
      }
<span class="nc bnc" id="L2078" title="All 2 branches missed.">      if (type.equalsIgnoreCase(ExperimentType.Q_WF_NGS_EPITOPE_PREDICTION.name())) {</span>
<span class="nc" id="L2079">        epitopePred.setStatus(OpenBisFunctions</span>
<span class="nc" id="L2080">            .statusToDoubleValue(bean.getProperties().get(&quot;Q_WF_STATUS&quot;).toString()));</span>
<span class="nc" id="L2081">        epitopePred.setCode(bean.getCode());</span>
<span class="nc" id="L2082">        epitopePred.setIdentifier(bean.getId());</span>
      }
<span class="nc" id="L2084">    }</span>

<span class="nc" id="L2086">    res.addBean(barcode);</span>
<span class="nc" id="L2087">    res.addBean(ngsCall);</span>
<span class="nc" id="L2088">    res.addBean(hlaType);</span>
<span class="nc" id="L2089">    res.addBean(variantAnno);</span>
<span class="nc" id="L2090">    res.addBean(epitopePred);</span>

<span class="nc" id="L2092">    return res;</span>
  }

  public ThemeResource setExperimentStatusColor(String status) {
<span class="nc" id="L2096">    ThemeResource resource = null;</span>
<span class="nc bnc" id="L2097" title="All 2 branches missed.">    if (status.equals(&quot;FINISHED&quot;)) {</span>
<span class="nc" id="L2098">      resource = new ThemeResource(&quot;green_light.png&quot;);</span>
<span class="nc bnc" id="L2099" title="All 2 branches missed.">    } else if (status.equals(&quot;DELAYED&quot;)) {</span>
<span class="nc" id="L2100">      resource = new ThemeResource(&quot;yellow_light.png&quot;);</span>
<span class="nc bnc" id="L2101" title="All 2 branches missed.">    } else if (status.equals(&quot;STARTED&quot;)) {</span>
<span class="nc" id="L2102">      resource = new ThemeResource(&quot;grey_light.png&quot;);</span>
<span class="nc bnc" id="L2103" title="All 2 branches missed.">    } else if (status.equals(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L2104">      resource = new ThemeResource(&quot;red_light.png&quot;);</span>
    } else {
<span class="nc" id="L2106">      resource = new ThemeResource(&quot;red_light.png&quot;);</span>
    }

    // image.setWidth(&quot;15px&quot;);
    // image.setHeight(&quot;15px&quot;);\
<span class="nc" id="L2111">    return resource;</span>
  }

  // public String beanContainerToString(BeanItemContainer c) {
  // String header = &quot;&quot;;
  // for (Object o : c.getContainerPropertyIds())
  // header += o.toString() + &quot;\t&quot;;
  // for (c.get)
  // }


  public List&lt;Qperson&gt; parseConnectedPeopleInformation(String xmlString) {
<span class="nc" id="L2123">    PersonParser xmlParser = new PersonParser();</span>
<span class="nc" id="L2124">    List&lt;Qperson&gt; xmlPersons = null;</span>
    try {
<span class="nc" id="L2126">      xmlPersons = xmlParser.getPersonsFromXML(xmlString);</span>
<span class="nc" id="L2127">    } catch (JAXBException e) {</span>
      // TODO Auto-generated catch block
<span class="nc" id="L2129">      e.printStackTrace();</span>
<span class="nc" id="L2130">    }</span>
<span class="nc" id="L2131">    return xmlPersons;</span>
  }

  public void fillPersonsContainer(String spaceIdentifier) {
<span class="nc" id="L2135">    List&lt;Sample&gt; samplesOfSpace = new ArrayList&lt;Sample&gt;();</span>
<span class="nc" id="L2136">    samplesOfSpace = this.getOpenBisClient().getSamplesofSpace(spaceIdentifier);</span>

<span class="nc bnc" id="L2138" title="All 2 branches missed.">    if (this.connectedPersons.size() == 0) {</span>
<span class="nc bnc" id="L2139" title="All 2 branches missed.">      for (PropertyType p : this.getOpenBisClient()</span>
<span class="nc" id="L2140">          .listPropertiesForType(this.getOpenBisClient().getSampleTypeByString((&quot;Q_USER&quot;)))) {</span>
<span class="nc" id="L2141">        this.connectedPersons.addContainerProperty(p.getLabel(), String.class, null);</span>
<span class="nc" id="L2142">      }</span>
<span class="nc" id="L2143">      this.connectedPersons.addContainerProperty(&quot;Project&quot;, String.class, null);</span>
    }

<span class="nc bnc" id="L2146" title="All 2 branches missed.">    for (Sample s : samplesOfSpace) {</span>
<span class="nc" id="L2147">      List&lt;Sample&gt; parents = this.getOpenBisClient().getParentsBySearchService(s.getCode());</span>
<span class="nc" id="L2148">      Map&lt;String, String&gt; labelMap = this.getOpenBisClient().getLabelsofProperties(</span>
<span class="nc" id="L2149">          this.getOpenBisClient().getSampleTypeByString(s.getSampleTypeCode()));</span>

<span class="nc bnc" id="L2151" title="All 2 branches missed.">      for (Sample parent : parents) {</span>
<span class="nc" id="L2152">        Object newPerson = this.connectedPersons.addItem();</span>
<span class="nc" id="L2153">        Iterator it = s.getProperties().entrySet().iterator();</span>
<span class="nc bnc" id="L2154" title="All 2 branches missed.">        while (it.hasNext()) {</span>
<span class="nc" id="L2155">          Entry pairs = (Entry) it.next();</span>
<span class="nc" id="L2156">          this.connectedPersons.getContainerProperty(newPerson, labelMap.get(pairs.getKey()))</span>
<span class="nc" id="L2157">              .setValue(pairs.getValue());</span>
<span class="nc" id="L2158">        }</span>
<span class="nc" id="L2159">        this.connectedPersons.getContainerProperty(newPerson, &quot;Project&quot;)</span>
<span class="nc" id="L2160">            .setValue(this.getOpenBisClient()</span>
<span class="nc" id="L2161">                .getProjectOfExperimentByIdentifier(parent.getExperimentIdentifierOrNull())</span>
<span class="nc" id="L2162">                .getCode().toString());</span>

<span class="nc" id="L2164">      }</span>
<span class="nc" id="L2165">    }</span>
<span class="nc" id="L2166">  }</span>

  public void registerNewPatients(int numberPatients, List&lt;String&gt; secondaryNames,
      BeanItemContainer&lt;NewIvacSampleBean&gt; samplesToRegister, String space, String description,
      Map&lt;String, List&lt;String&gt;&gt; hlaTyping) {

    // get prefix code for projects for corresponding space
<span class="nc" id="L2173">    String projectPrefix = spaceToProjectPrefixMap.get(space);</span>

    // extract to function for that
<span class="nc" id="L2176">    List&lt;Integer&gt; projectCodes = new ArrayList&lt;Integer&gt;();</span>
<span class="nc bnc" id="L2177" title="All 2 branches missed.">    for (Project p : getOpenBisClient().getProjectsOfSpace(space)) {</span>
      // String maxValue = Collections.max(p.getCode());
<span class="nc" id="L2179">      String maxValue = p.getCode().replaceAll(&quot;\\D+&quot;, &quot;&quot;);</span>
      int codeAsNumber;
      try {
<span class="nc" id="L2182">        codeAsNumber = Integer.parseInt(maxValue);</span>
<span class="nc" id="L2183">      } catch (NumberFormatException nfe) {</span>
        // bad data - set to sentinel
<span class="nc" id="L2185">        codeAsNumber = 0;</span>
<span class="nc" id="L2186">      }</span>

<span class="nc" id="L2188">      projectCodes.add(codeAsNumber);</span>
<span class="nc" id="L2189">    }</span>

    int numberOfProject;

<span class="nc bnc" id="L2193" title="All 2 branches missed.">    if (projectCodes.size() == 0) {</span>
<span class="nc" id="L2194">      numberOfProject = 0;</span>
    } else {
<span class="nc" id="L2196">      numberOfProject = Collections.max(projectCodes);</span>
    }

<span class="nc bnc" id="L2199" title="All 2 branches missed.">    for (int i = 0; i &lt; numberPatients; i++) {</span>
<span class="nc" id="L2200">      Map&lt;String, Object&gt; projectMap = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L2201">      Map&lt;String, Object&gt; firstLevel = new HashMap&lt;String, Object&gt;();</span>

<span class="nc" id="L2203">      numberOfProject += 1;</span>
<span class="nc" id="L2204">      int numberOfRegisteredExperiments = 1;</span>
<span class="nc" id="L2205">      int numberOfRegisteredSamples = 1;</span>

      // register new patient (project), project prefixes differ in length
<span class="nc" id="L2208">      String newProjectCode =</span>
<span class="nc" id="L2209">          projectPrefix + Utils.createCountString(numberOfProject, 5 - projectPrefix.length());</span>

<span class="nc" id="L2211">      projectMap.put(&quot;code&quot;, newProjectCode);</span>
<span class="nc" id="L2212">      projectMap.put(&quot;space&quot;, space);</span>
<span class="nc" id="L2213">      projectMap.put(&quot;desc&quot;, description + &quot; [&quot; + secondaryNames.get(i) + &quot;]&quot;);</span>
<span class="nc" id="L2214">      projectMap.put(&quot;user&quot;, PortalUtils.getNonNullScreenName());</span>

      // call of ingestion service to register project
<span class="nc" id="L2217">      this.getOpenBisClient().triggerIngestionService(&quot;register-proj&quot;, projectMap);</span>
      // helpers.Utils.printMapContent(projectMap);

<span class="nc" id="L2220">      String newProjectDetailsCode =</span>
<span class="nc" id="L2221">          projectPrefix + Utils.createCountString(numberOfProject, 3) + &quot;E_INFO&quot;;</span>
<span class="nc" id="L2222">      String newProjectDetailsID = &quot;/&quot; + space + &quot;/&quot; + newProjectCode + &quot;/&quot; + newProjectDetailsCode;</span>

<span class="nc" id="L2224">      String newExperimentalDesignCode = projectPrefix + Utils.createCountString(numberOfProject, 3)</span>
          + &quot;E&quot; + numberOfRegisteredExperiments;
<span class="nc" id="L2226">      String newExperimentalDesignID =</span>
          &quot;/&quot; + space + &quot;/&quot; + newProjectCode + &quot;/&quot; + newExperimentalDesignCode;
<span class="nc" id="L2228">      numberOfRegisteredExperiments += 1;</span>

      // String newBiologicalEntitiyCode =
      // newProjectCode + Utils.createCountString(numberOfRegisteredSamples, 3) + &quot;H&quot;;
      // String newBiologicalEntitiyID =
      // &quot;/&quot; + space + &quot;/&quot; + newBiologicalEntitiyCode
      // + helpers.BarcodeFunctions.checksum(newBiologicalEntitiyCode);
<span class="nc" id="L2235">      String newBiologicalEntitiyID =</span>
<span class="nc" id="L2236">          String.format(&quot;/&quot; + space + &quot;/&quot; + &quot;%sENTITY-1&quot;, newProjectCode);</span>

<span class="nc" id="L2238">      numberOfRegisteredSamples += 1;</span>

      // register first level of new patient
<span class="nc" id="L2241">      firstLevel.put(&quot;lvl&quot;, &quot;1&quot;);</span>
<span class="nc" id="L2242">      firstLevel.put(&quot;projectDetails&quot;, newProjectDetailsID);</span>
<span class="nc" id="L2243">      firstLevel.put(&quot;experimentalDesign&quot;, newExperimentalDesignID);</span>
<span class="nc" id="L2244">      firstLevel.put(&quot;secondaryName&quot;, secondaryNames.get(i));</span>
<span class="nc" id="L2245">      firstLevel.put(&quot;biologicalEntity&quot;, newBiologicalEntitiyID);</span>
<span class="nc" id="L2246">      firstLevel.put(&quot;user&quot;, PortalUtils.getNonNullScreenName());</span>

<span class="nc" id="L2248">      this.getOpenBisClient().triggerIngestionService(&quot;register-ivac-lvl&quot;, firstLevel);</span>

      // helpers.Utils.printMapContent(firstLevel);

<span class="nc" id="L2252">      Map&lt;String, Object&gt; fithLevel = new HashMap&lt;String, Object&gt;();</span>

<span class="nc" id="L2254">      List&lt;String&gt; newHLATypingIDs = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2255">      List&lt;String&gt; newHLATypingSampleIDs = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2256">      List&lt;String&gt; hlaClasses = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2257">      List&lt;String&gt; typings = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2258">      List&lt;String&gt; typingMethods = new ArrayList&lt;String&gt;();</span>

      // TODO choose parent sample for hlaTyping
<span class="nc" id="L2261">      String parentHLA = &quot;&quot;;</span>


<span class="nc bnc" id="L2264" title="All 2 branches missed.">      for (Iterator iter = samplesToRegister.getItemIds().iterator(); iter.hasNext();) {</span>

<span class="nc" id="L2266">        NewIvacSampleBean sampleBean = (NewIvacSampleBean) iter.next();</span>

<span class="nc bnc" id="L2268" title="All 2 branches missed.">        for (int ii = 1; ii &lt;= sampleBean.getAmount(); ii++) {</span>
<span class="nc" id="L2269">          Map&lt;String, Object&gt; secondLevel = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L2270">          Map&lt;String, Object&gt; thirdLevel = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L2271">          Map&lt;String, Object&gt; fourthLevel = new HashMap&lt;String, Object&gt;();</span>

<span class="nc" id="L2273">          List&lt;String&gt; newSamplePreparationIDs = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2274">          List&lt;String&gt; newTestSampleIDs = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2275">          List&lt;String&gt; testTypes = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L2277">          List&lt;String&gt; newNGSMeasurementIDs = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2278">          List&lt;String&gt; newNGSRunIDs = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2279">          List&lt;Boolean&gt; additionalInfo = new ArrayList&lt;Boolean&gt;();</span>
<span class="nc" id="L2280">          List&lt;String&gt; parents = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L2282">          List&lt;String&gt; newSampleExtractionIDs = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2283">          List&lt;String&gt; newBiologicalSampleIDs = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2284">          List&lt;String&gt; primaryTissues = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2285">          List&lt;String&gt; detailedTissue = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2286">          List&lt;String&gt; sequencerDevice = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L2288">          String newSampleExtractionCode = newProjectCode + &quot;E&quot; + numberOfRegisteredExperiments;</span>
<span class="nc" id="L2289">          newSampleExtractionIDs</span>
<span class="nc" id="L2290">              .add(&quot;/&quot; + space + &quot;/&quot; + newProjectCode + &quot;/&quot; + newSampleExtractionCode);</span>
<span class="nc" id="L2291">          numberOfRegisteredExperiments += 1;</span>

<span class="nc" id="L2293">          String newBiologicalSampleCode =</span>
<span class="nc" id="L2294">              newProjectCode + Utils.createCountString(numberOfRegisteredSamples, 3) + &quot;B&quot;;</span>
<span class="nc" id="L2295">          String newBiologicalSampleID = &quot;/&quot; + space + &quot;/&quot; + newBiologicalSampleCode</span>
<span class="nc" id="L2296">              + BarcodeFunctions.checksum(newBiologicalSampleCode);</span>

<span class="nc" id="L2298">          parentHLA = newBiologicalSampleID;</span>

<span class="nc" id="L2300">          newBiologicalSampleIDs.add(newBiologicalSampleID);</span>
<span class="nc" id="L2301">          numberOfRegisteredSamples += 1;</span>

<span class="nc" id="L2303">          primaryTissues.add(sampleBean.getTissue());</span>
<span class="nc" id="L2304">          detailedTissue.add(sampleBean.getType());</span>

          // register second level of new patient
<span class="nc" id="L2307">          secondLevel.put(&quot;lvl&quot;, &quot;2&quot;);</span>
<span class="nc" id="L2308">          secondLevel.put(&quot;sampleExtraction&quot;, newSampleExtractionIDs);</span>
<span class="nc" id="L2309">          secondLevel.put(&quot;biologicalSamples&quot;, newBiologicalSampleIDs);</span>

<span class="nc bnc" id="L2311" title="All 2 branches missed.">          if (sampleBean.getSecondaryName() == null) {</span>
<span class="nc" id="L2312">            secondLevel.put(&quot;secondaryNames&quot;, &quot;&quot;);</span>
          } else {
<span class="nc" id="L2314">            secondLevel.put(&quot;secondaryNames&quot;, sampleBean.getSecondaryName());</span>
          }
<span class="nc" id="L2316">          secondLevel.put(&quot;parent&quot;, newBiologicalEntitiyID);</span>
<span class="nc" id="L2317">          secondLevel.put(&quot;primaryTissue&quot;, primaryTissues);</span>
<span class="nc" id="L2318">          secondLevel.put(&quot;detailedTissue&quot;, detailedTissue);</span>
<span class="nc" id="L2319">          secondLevel.put(&quot;user&quot;, PortalUtils.getNonNullScreenName());</span>

<span class="nc" id="L2321">          this.getOpenBisClient().triggerIngestionService(&quot;register-ivac-lvl&quot;, secondLevel);</span>
          // helpers.Utils.printMapContent(secondLevel);

<span class="nc bnc" id="L2324" title="All 2 branches missed.">          if (sampleBean.getDnaSeq()) {</span>
<span class="nc" id="L2325">            String newSamplePreparationCode = newProjectCode + &quot;E&quot; + numberOfRegisteredExperiments;</span>
<span class="nc" id="L2326">            String newSamplePreparationID =</span>
                &quot;/&quot; + space + &quot;/&quot; + newProjectCode + &quot;/&quot; + newSamplePreparationCode;
<span class="nc" id="L2328">            newSamplePreparationIDs.add(newSamplePreparationID);</span>
<span class="nc" id="L2329">            numberOfRegisteredExperiments += 1;</span>

<span class="nc" id="L2331">            String newTestSampleCode =</span>
<span class="nc" id="L2332">                newProjectCode + Utils.createCountString(numberOfRegisteredSamples, 3) + &quot;B&quot;;</span>
<span class="nc" id="L2333">            String newTestSampleID = &quot;/&quot; + space + &quot;/&quot; + newTestSampleCode</span>
<span class="nc" id="L2334">                + BarcodeFunctions.checksum(newTestSampleCode);</span>
<span class="nc" id="L2335">            newTestSampleIDs.add(newTestSampleID);</span>
<span class="nc" id="L2336">            numberOfRegisteredSamples += 1;</span>
<span class="nc" id="L2337">            testTypes.add(&quot;DNA&quot;);</span>

<span class="nc" id="L2339">            String newNGSMeasurementCode = newProjectCode + &quot;E&quot; + numberOfRegisteredExperiments;</span>
<span class="nc" id="L2340">            String newNGSMeasurementID =</span>
                &quot;/&quot; + space + &quot;/&quot; + newProjectCode + &quot;/&quot; + newNGSMeasurementCode;
<span class="nc" id="L2342">            newNGSMeasurementIDs.add(newNGSMeasurementID);</span>
<span class="nc" id="L2343">            numberOfRegisteredExperiments += 1;</span>

<span class="nc" id="L2345">            String newNGSRunCode =</span>
<span class="nc" id="L2346">                newProjectCode + Utils.createCountString(numberOfRegisteredSamples, 3) + &quot;R&quot;;</span>
<span class="nc" id="L2347">            String newNGSRunID =</span>
<span class="nc" id="L2348">                &quot;/&quot; + space + &quot;/&quot; + newNGSRunCode + BarcodeFunctions.checksum(newNGSRunCode);</span>
<span class="nc" id="L2349">            newNGSRunIDs.add(newNGSRunID);</span>
<span class="nc" id="L2350">            numberOfRegisteredSamples += 1;</span>

<span class="nc" id="L2352">            additionalInfo.add(false);</span>
<span class="nc" id="L2353">            sequencerDevice.add(sampleBean.getSeqDevice());</span>
<span class="nc" id="L2354">            parents.add(newTestSampleID);</span>

          }

<span class="nc bnc" id="L2358" title="All 2 branches missed.">          if (sampleBean.getRnaSeq()) {</span>
<span class="nc" id="L2359">            String newSamplePreparationCode = newProjectCode + &quot;E&quot; + numberOfRegisteredExperiments;</span>
<span class="nc" id="L2360">            String newSamplePreparationID =</span>
                &quot;/&quot; + space + &quot;/&quot; + newProjectCode + &quot;/&quot; + newSamplePreparationCode;
<span class="nc" id="L2362">            newSamplePreparationIDs.add(newSamplePreparationID);</span>
<span class="nc" id="L2363">            numberOfRegisteredExperiments += 1;</span>

<span class="nc" id="L2365">            String newTestSampleCode =</span>
<span class="nc" id="L2366">                newProjectCode + Utils.createCountString(numberOfRegisteredSamples, 3) + &quot;B&quot;;</span>
<span class="nc" id="L2367">            String newTestSampleID = &quot;/&quot; + space + &quot;/&quot; + newTestSampleCode</span>
<span class="nc" id="L2368">                + BarcodeFunctions.checksum(newTestSampleCode);</span>
<span class="nc" id="L2369">            newTestSampleIDs.add(newTestSampleID);</span>
<span class="nc" id="L2370">            numberOfRegisteredSamples += 1;</span>
<span class="nc" id="L2371">            testTypes.add(&quot;RNA&quot;);</span>

<span class="nc" id="L2373">            String newNGSMeasurementCode = newProjectCode + &quot;E&quot; + numberOfRegisteredExperiments;</span>
<span class="nc" id="L2374">            String newNGSMeasurementID =</span>
                &quot;/&quot; + space + &quot;/&quot; + newProjectCode + &quot;/&quot; + newNGSMeasurementCode;
<span class="nc" id="L2376">            newNGSMeasurementIDs.add(newNGSMeasurementID);</span>
<span class="nc" id="L2377">            numberOfRegisteredExperiments += 1;</span>

<span class="nc" id="L2379">            String newNGSRunCode =</span>
<span class="nc" id="L2380">                newProjectCode + Utils.createCountString(numberOfRegisteredSamples, 3) + &quot;R&quot;;</span>
<span class="nc" id="L2381">            String newNGSRunID =</span>
<span class="nc" id="L2382">                &quot;/&quot; + space + &quot;/&quot; + newNGSRunCode + BarcodeFunctions.checksum(newNGSRunCode);</span>
<span class="nc" id="L2383">            newNGSRunIDs.add(newNGSRunID);</span>
<span class="nc" id="L2384">            numberOfRegisteredSamples += 1;</span>

<span class="nc" id="L2386">            additionalInfo.add(false);</span>
<span class="nc" id="L2387">            sequencerDevice.add(sampleBean.getSeqDevice());</span>
<span class="nc" id="L2388">            parents.add(newTestSampleID);</span>
          }

<span class="nc bnc" id="L2391" title="All 2 branches missed.">          if (sampleBean.getDeepSeq()) {</span>
<span class="nc" id="L2392">            String newSamplePreparationCode = newProjectCode + &quot;E&quot; + numberOfRegisteredExperiments;</span>
<span class="nc" id="L2393">            String newSamplePreparationID =</span>
                &quot;/&quot; + space + &quot;/&quot; + newProjectCode + &quot;/&quot; + newSamplePreparationCode;
<span class="nc" id="L2395">            newSamplePreparationIDs.add(newSamplePreparationID);</span>
<span class="nc" id="L2396">            numberOfRegisteredExperiments += 1;</span>

<span class="nc" id="L2398">            String newTestSampleCode =</span>
<span class="nc" id="L2399">                newProjectCode + Utils.createCountString(numberOfRegisteredSamples, 3) + &quot;B&quot;;</span>
<span class="nc" id="L2400">            String newTestSampleID = &quot;/&quot; + space + &quot;/&quot; + newTestSampleCode</span>
<span class="nc" id="L2401">                + BarcodeFunctions.checksum(newTestSampleCode);</span>
<span class="nc" id="L2402">            newTestSampleIDs.add(newTestSampleID);</span>
<span class="nc" id="L2403">            numberOfRegisteredSamples += 1;</span>
<span class="nc" id="L2404">            testTypes.add(&quot;DNA&quot;);</span>

<span class="nc" id="L2406">            String newNGSMeasurementCode = newProjectCode + &quot;E&quot; + numberOfRegisteredExperiments;</span>
<span class="nc" id="L2407">            String newNGSMeasurementID =</span>
                &quot;/&quot; + space + &quot;/&quot; + newProjectCode + &quot;/&quot; + newNGSMeasurementCode;
<span class="nc" id="L2409">            newNGSMeasurementIDs.add(newNGSMeasurementID);</span>
<span class="nc" id="L2410">            numberOfRegisteredExperiments += 1;</span>

<span class="nc" id="L2412">            String newNGSRunCode =</span>
<span class="nc" id="L2413">                newProjectCode + Utils.createCountString(numberOfRegisteredSamples, 3) + &quot;R&quot;;</span>
<span class="nc" id="L2414">            String newNGSRunID =</span>
<span class="nc" id="L2415">                &quot;/&quot; + space + &quot;/&quot; + newNGSRunCode + BarcodeFunctions.checksum(newNGSRunCode);</span>
<span class="nc" id="L2416">            newNGSRunIDs.add(newNGSRunID);</span>
<span class="nc" id="L2417">            numberOfRegisteredSamples += 1;</span>

<span class="nc" id="L2419">            additionalInfo.add(true);</span>
<span class="nc" id="L2420">            sequencerDevice.add(sampleBean.getSeqDevice());</span>
<span class="nc" id="L2421">            parents.add(newTestSampleID);</span>
          }

          // register third and fourth level of new patient
<span class="nc" id="L2425">          thirdLevel.put(&quot;lvl&quot;, &quot;3&quot;);</span>
<span class="nc" id="L2426">          thirdLevel.put(&quot;parent&quot;, newBiologicalSampleID);</span>
<span class="nc" id="L2427">          thirdLevel.put(&quot;experiments&quot;, newSamplePreparationIDs);</span>
<span class="nc" id="L2428">          thirdLevel.put(&quot;samples&quot;, newTestSampleIDs);</span>
<span class="nc" id="L2429">          thirdLevel.put(&quot;types&quot;, testTypes);</span>
<span class="nc" id="L2430">          thirdLevel.put(&quot;user&quot;, PortalUtils.getNonNullScreenName());</span>

<span class="nc" id="L2432">          fourthLevel.put(&quot;lvl&quot;, &quot;4&quot;);</span>
<span class="nc" id="L2433">          fourthLevel.put(&quot;experiments&quot;, newNGSMeasurementIDs);</span>
<span class="nc" id="L2434">          fourthLevel.put(&quot;samples&quot;, newNGSRunIDs);</span>
<span class="nc" id="L2435">          fourthLevel.put(&quot;parents&quot;, parents);</span>
<span class="nc" id="L2436">          fourthLevel.put(&quot;types&quot;, testTypes);</span>
<span class="nc" id="L2437">          fourthLevel.put(&quot;info&quot;, additionalInfo);</span>
<span class="nc" id="L2438">          fourthLevel.put(&quot;device&quot;, sequencerDevice);</span>
<span class="nc" id="L2439">          fourthLevel.put(&quot;user&quot;, PortalUtils.getNonNullScreenName());</span>

          // TODO additional level for HLA typing

          // call of ingestion services for differeny levels
          // helpers.Utils.printMapContent(thirdLevel);
          // helpers.Utils.printMapContent(fourthLevel);
<span class="nc" id="L2446">          this.getOpenBisClient().triggerIngestionService(&quot;register-ivac-lvl&quot;, thirdLevel);</span>
<span class="nc" id="L2447">          this.getOpenBisClient().triggerIngestionService(&quot;register-ivac-lvl&quot;, fourthLevel);</span>
        }
<span class="nc" id="L2449">      }</span>

<span class="nc bnc" id="L2451" title="All 2 branches missed.">      for (Entry&lt;String, List&lt;String&gt;&gt; entry : hlaTyping.entrySet()) {</span>

<span class="nc" id="L2453">        String newHLATyping = newProjectCode + &quot;E&quot; + numberOfRegisteredExperiments;</span>

<span class="nc" id="L2455">        newHLATypingIDs.add(&quot;/&quot; + space + &quot;/&quot; + newProjectCode + &quot;/&quot; + newHLATyping);</span>

<span class="nc" id="L2457">        numberOfRegisteredExperiments += 1;</span>

<span class="nc" id="L2459">        String newHLATypingSampleCode =</span>
<span class="nc" id="L2460">            newProjectCode + Utils.createCountString(numberOfRegisteredSamples, 3) + &quot;H&quot;;</span>

<span class="nc" id="L2462">        String newHLATypingSampleID = &quot;/&quot; + space + &quot;/&quot; + newHLATypingSampleCode</span>
<span class="nc" id="L2463">            + BarcodeFunctions.checksum(newHLATypingSampleCode);</span>

<span class="nc" id="L2465">        newHLATypingSampleIDs.add(newHLATypingSampleID);</span>
<span class="nc" id="L2466">        numberOfRegisteredSamples += 1;</span>

<span class="nc" id="L2468">        hlaClasses.add(entry.getKey());</span>
<span class="nc" id="L2469">        typings.add(entry.getValue().get(0));</span>
<span class="nc" id="L2470">        typingMethods.add(entry.getValue().get(1));</span>
<span class="nc" id="L2471">      }</span>

<span class="nc" id="L2473">      fithLevel.put(&quot;lvl&quot;, &quot;5&quot;);</span>
<span class="nc" id="L2474">      fithLevel.put(&quot;experiments&quot;, newHLATypingIDs);</span>
<span class="nc" id="L2475">      fithLevel.put(&quot;samples&quot;, newHLATypingSampleIDs);</span>
<span class="nc" id="L2476">      fithLevel.put(&quot;typings&quot;, typings);</span>
<span class="nc" id="L2477">      fithLevel.put(&quot;classes&quot;, hlaClasses);</span>
<span class="nc" id="L2478">      fithLevel.put(&quot;methods&quot;, typingMethods);</span>
<span class="nc" id="L2479">      fithLevel.put(&quot;parent&quot;, parentHLA);</span>

<span class="nc" id="L2481">      this.getOpenBisClient().triggerIngestionService(&quot;register-ivac-lvl&quot;, fithLevel);</span>

    }
<span class="nc" id="L2484">  }</span>

  /**
   * 
   * @param statusValues
   * @return
   * @deprecated
   */
  public VerticalLayout createProjectStatusComponent(Map&lt;String, Integer&gt; statusValues) {
<span class="nc" id="L2493">    VerticalLayout projectStatusContent = new VerticalLayout();</span>

<span class="nc" id="L2495">    Iterator&lt;Entry&lt;String, Integer&gt;&gt; it = statusValues.entrySet().iterator();</span>
<span class="nc" id="L2496">    int finishedExperiments = 0;</span>

<span class="nc bnc" id="L2498" title="All 2 branches missed.">    while (it.hasNext()) {</span>
<span class="nc" id="L2499">      Entry&lt;String, Integer&gt; pairs = (Entry&lt;String, Integer&gt;) it.next();</span>

<span class="nc bnc" id="L2501" title="All 2 branches missed.">      if ((Integer) pairs.getValue() == 0) {</span>
<span class="nc" id="L2502">        Label statusLabel =</span>
<span class="nc" id="L2503">            new Label(pairs.getKey() + &quot;: &quot; + FontAwesome.TIMES.getHtml(), ContentMode.HTML);</span>
<span class="nc" id="L2504">        statusLabel.addStyleName(&quot;redicon&quot;);</span>
<span class="nc" id="L2505">        projectStatusContent.addComponent(statusLabel);</span>
<span class="nc" id="L2506">      }</span>

      else {
<span class="nc" id="L2509">        Label statusLabel =</span>
<span class="nc" id="L2510">            new Label(pairs.getKey() + &quot;: &quot; + FontAwesome.CHECK.getHtml(), ContentMode.HTML);</span>
<span class="nc" id="L2511">        statusLabel.addStyleName(&quot;greenicon&quot;);</span>

<span class="nc bnc" id="L2513" title="All 2 branches missed.">        if (pairs.getKey().equals(&quot;Project Planned&quot;)) {</span>
<span class="nc" id="L2514">          projectStatusContent.addComponentAsFirst(statusLabel);</span>
        } else {
<span class="nc" id="L2516">          projectStatusContent.addComponent(statusLabel);</span>

        }
<span class="nc" id="L2519">        finishedExperiments += (Integer) pairs.getValue();</span>
      }
<span class="nc" id="L2521">    }</span>
    // ProgressBar progressBar = new ProgressBar();
    // progressBar.setValue((float) finishedExperiments / statusValues.keySet().size());
    // projectStatusContent.addComponent(progressBar);

<span class="nc" id="L2526">    return projectStatusContent;</span>
  }

  /**
   * 
   * @param statusValues
   * @return
   */
  public VerticalLayout createProjectStatusComponentNew(Map&lt;String, Integer&gt; statusValues) {
<span class="nc" id="L2535">    VerticalLayout projectStatusContent = new VerticalLayout();</span>
<span class="nc" id="L2536">    projectStatusContent.setResponsive(true);</span>
<span class="nc" id="L2537">    projectStatusContent.setMargin(true);</span>
<span class="nc" id="L2538">    projectStatusContent.setSpacing(true);</span>

<span class="nc" id="L2540">    Label planned = new Label();</span>
<span class="nc" id="L2541">    Label design = new Label();</span>
<span class="nc" id="L2542">    Label raw = new Label();</span>
<span class="nc" id="L2543">    Label results = new Label();</span>

<span class="nc" id="L2545">    Iterator&lt;Entry&lt;String, Integer&gt;&gt; it = statusValues.entrySet().iterator();</span>

<span class="nc bnc" id="L2547" title="All 2 branches missed.">    while (it.hasNext()) {</span>
<span class="nc" id="L2548">      Entry&lt;String, Integer&gt; pairs = (Entry&lt;String, Integer&gt;) it.next();</span>

<span class="nc bnc" id="L2550" title="All 2 branches missed.">      if ((Integer) pairs.getValue() == 0) {</span>
<span class="nc" id="L2551">        Label statusLabel = new Label(pairs.getKey());</span>
<span class="nc" id="L2552">        statusLabel.setStyleName(ValoTheme.LABEL_FAILURE);</span>
<span class="nc" id="L2553">        statusLabel.setResponsive(true);</span>
        // statusLabel.addStyleName(&quot;redicon&quot;);
<span class="nc bnc" id="L2555" title="All 2 branches missed.">        if (pairs.getKey().equals(&quot;Project planned&quot;)) {</span>
<span class="nc" id="L2556">          planned = statusLabel;</span>
<span class="nc bnc" id="L2557" title="All 2 branches missed.">        } else if (pairs.getKey().equals(&quot;Experimental design registered&quot;)) {</span>
<span class="nc" id="L2558">          design = statusLabel;</span>
<span class="nc bnc" id="L2559" title="All 2 branches missed.">        } else if (pairs.getKey().equals(&quot;Raw data registered&quot;)) {</span>
<span class="nc" id="L2560">          raw = statusLabel;</span>
<span class="nc bnc" id="L2561" title="All 2 branches missed.">        } else if (pairs.getKey().equals(&quot;Results registered&quot;)) {</span>
<span class="nc" id="L2562">          results = statusLabel;</span>
        }
<span class="nc" id="L2564">      }</span>

      else {
<span class="nc" id="L2567">        Label statusLabel = new Label(pairs.getKey());</span>
<span class="nc" id="L2568">        statusLabel.setStyleName(ValoTheme.LABEL_SUCCESS);</span>
<span class="nc" id="L2569">        statusLabel.setResponsive(true);</span>

        // statusLabel.addStyleName(&quot;greenicon&quot;);

<span class="nc bnc" id="L2573" title="All 2 branches missed.">        if (pairs.getKey().equals(&quot;Project planned&quot;)) {</span>
<span class="nc" id="L2574">          planned = statusLabel;</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">        } else if (pairs.getKey().equals(&quot;Experimental design registered&quot;)) {</span>
<span class="nc" id="L2576">          design = statusLabel;</span>
<span class="nc bnc" id="L2577" title="All 2 branches missed.">        } else if (pairs.getKey().equals(&quot;Raw data registered&quot;)) {</span>
<span class="nc" id="L2578">          raw = statusLabel;</span>
<span class="nc bnc" id="L2579" title="All 2 branches missed.">        } else if (pairs.getKey().equals(&quot;Results registered&quot;)) {</span>
<span class="nc" id="L2580">          results = statusLabel;</span>
        }
      }
<span class="nc" id="L2583">    }</span>

<span class="nc" id="L2585">    projectStatusContent.addComponent(planned);</span>
<span class="nc" id="L2586">    projectStatusContent.addComponent(design);</span>
<span class="nc" id="L2587">    projectStatusContent.addComponent(raw);</span>
<span class="nc" id="L2588">    projectStatusContent.addComponent(results);</span>

    // ProgressBar progressBar = new ProgressBar();
    // progressBar.setValue((float) finishedExperiments / statusValues.keySet().size());
    // projectStatusContent.addComponent(progressBar);

<span class="nc" id="L2594">    return projectStatusContent;</span>
  }

  /**
   * Get secondary Name of parent or parents of parent
   * 
   * @param samp
   * @return
   */
  public String getSecondaryName(Sample samp, String datsetSecName) {
<span class="nc" id="L2604">    List&lt;Sample&gt; firstParents = samp.getParents();</span>
<span class="nc" id="L2605">    String secondaryName = &quot;&quot;;</span>
<span class="nc" id="L2606">    Set&lt;String&gt; secNamesTest = new LinkedHashSet&lt;String&gt;();</span>
<span class="nc" id="L2607">    Set&lt;String&gt; secNamesBiological = new LinkedHashSet&lt;String&gt;();</span>
<span class="nc" id="L2608">    Set&lt;String&gt; secNamesEntities = new LinkedHashSet&lt;String&gt;();</span>
<span class="nc" id="L2609">    Set&lt;String&gt; allDescriptions = new LinkedHashSet&lt;String&gt;();</span>
<span class="nc" id="L2610">    List&lt;Sample&gt; allParents = new ArrayList&lt;Sample&gt;();</span>

<span class="nc bnc" id="L2612" title="All 2 branches missed.">    for (Sample p : firstParents) {</span>
<span class="nc" id="L2613">      allParents.add(p);</span>
<span class="nc bnc" id="L2614" title="All 2 branches missed.">      for (Sample q : p.getParents()) {</span>
<span class="nc" id="L2615">        allParents.add(q);</span>
<span class="nc bnc" id="L2616" title="All 2 branches missed.">        for (Sample r : q.getParents()) {</span>
<span class="nc" id="L2617">          allParents.add(r);</span>
<span class="nc bnc" id="L2618" title="All 2 branches missed.">          for (Sample s : r.getParents()) {</span>
<span class="nc" id="L2619">            allParents.add(s);</span>
<span class="nc" id="L2620">          }</span>
<span class="nc" id="L2621">        }</span>
<span class="nc" id="L2622">      }</span>
<span class="nc" id="L2623">    }</span>

<span class="nc bnc" id="L2625" title="All 2 branches missed.">    for (Sample pp : allParents) {</span>
<span class="nc bnc" id="L2626" title="All 2 branches missed.">      if (pp.getSampleTypeCode().equals(&quot;Q_TEST_SAMPLE&quot;)) {</span>
<span class="nc" id="L2627">        String new_sec = pp.getProperties().get(&quot;Q_SECONDARY_NAME&quot;);</span>
<span class="nc bnc" id="L2628" title="All 2 branches missed.">        if (new_sec != null) {</span>
<span class="nc" id="L2629">          secNamesTest.add(new_sec);</span>
        }
<span class="nc bnc" id="L2631" title="All 2 branches missed.">      } else if (pp.getSampleTypeCode().equals(&quot;Q_BIOLOGICAL_SAMPLE&quot;)) {</span>
<span class="nc" id="L2632">        String new_sec = pp.getProperties().get(&quot;Q_SECONDARY_NAME&quot;);</span>
<span class="nc bnc" id="L2633" title="All 2 branches missed.">        if (new_sec != null) {</span>
<span class="nc" id="L2634">          secNamesBiological.add(new_sec);</span>
        }

<span class="nc bnc" id="L2637" title="All 2 branches missed.">      } else if (pp.getSampleTypeCode().equals(&quot;Q_BIOLOGICAL_ENTITY&quot;)) {</span>
<span class="nc" id="L2638">        String new_sec = pp.getProperties().get(&quot;Q_SECONDARY_NAME&quot;);</span>
<span class="nc bnc" id="L2639" title="All 2 branches missed.">        if (new_sec != null) {</span>
<span class="nc" id="L2640">          secNamesEntities.add(new_sec);</span>
        }
      }
<span class="nc" id="L2643">    }</span>

<span class="nc" id="L2645">    allDescriptions.addAll(secNamesEntities);</span>
<span class="nc" id="L2646">    allDescriptions.addAll(secNamesBiological);</span>
<span class="nc" id="L2647">    allDescriptions.addAll(secNamesTest);</span>

<span class="nc bnc" id="L2649" title="All 2 branches missed.">    if (datsetSecName != null) {</span>
<span class="nc" id="L2650">      allDescriptions.add(datsetSecName);</span>
    }

<span class="nc" id="L2653">    secondaryName = String.join(&quot;_&quot;, allDescriptions);</span>

<span class="nc" id="L2655">    return secondaryName.replace(&quot;__&quot;, &quot;_&quot;).replaceAll(&quot;^_+&quot;, &quot;&quot;).replaceAll(&quot;_+$&quot;, &quot;&quot;);</span>
  }


  public OpenBisClient getOpenBisClient() {
<span class="nc" id="L2660">    return openBisClient;</span>
  }


  public void setOpenBisClient(OpenBisClient openBisClient) {
<span class="nc" id="L2665">    this.openBisClient = openBisClient;</span>
<span class="nc" id="L2666">  }</span>


  public DBManager getDatabaseManager() {
<span class="nc" id="L2670">    return databaseManager;</span>
  }


  public void setDatabaseManager(DBManager databaseManager) {
<span class="nc" id="L2675">    this.databaseManager = databaseManager;</span>
<span class="nc" id="L2676">  }</span>


  public Set&lt;String&gt; getFactorLabels() {
<span class="nc" id="L2680">    return experimentalFactorLabels;</span>
  }


  public Map&lt;Pair&lt;String, String&gt;, Property&gt; getFactorsForLabelsAndSamples() {
<span class="nc" id="L2685">    return experimentalFactorsForLabelsAndSamples;</span>
  }

  public Map&lt;String, List&lt;Property&gt;&gt; getPropertiesForSamples() {
<span class="nc" id="L2689">    return propertiesForSamples;</span>
  }

  public JAXBElement&lt;Qexperiment&gt; getExperimentalSetup() {
<span class="nc" id="L2693">    return experimentalSetup;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>