<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientStatusComponent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ProjectBrowser Portlet</a> &gt; <a href="index.source.html" class="el_package">life.qbic.projectbrowser.components</a> &gt; <span class="el_source">PatientStatusComponent.java</span></div><h1>PatientStatusComponent.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * QBiC Project qNavigator enables users to manage their projects.
 * Copyright (C) &quot;2016‚Äù  Christopher Mohr, David Wojnar, Andreas Friedrich
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 *******************************************************************************/
package life.qbic.projectbrowser.components;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import life.qbic.projectbrowser.model.ExperimentStatusBean;
import life.qbic.projectbrowser.model.ProjectBean;
import life.qbic.projectbrowser.controllers.*;
import life.qbic.projectbrowser.views.PatientView;
import life.qbic.projectbrowser.helpers.Utils;

import com.vaadin.data.Item;
import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.data.util.GeneratedPropertyContainer;
import com.vaadin.data.util.PropertyValueGenerator;
import com.vaadin.server.FontAwesome;
import com.vaadin.server.Page;
import com.vaadin.shared.Position;
import com.vaadin.shared.ui.MarginInfo;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.Grid;
import com.vaadin.ui.Notification;
import com.vaadin.ui.Notification.Type;
import com.vaadin.ui.ProgressBar;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.renderers.ButtonRenderer;
import com.vaadin.ui.renderers.ClickableRenderer.RendererClickEvent;
import com.vaadin.ui.renderers.ClickableRenderer.RendererClickListener;
import com.vaadin.ui.renderers.HtmlRenderer;
import com.vaadin.ui.renderers.ProgressBarRenderer;


public class PatientStatusComponent extends CustomComponent {
  private DataHandler datahandler;
  private String resourceUrl;
  private State state;
  private VerticalLayout status;
  private Grid experiments;

<span class="nc" id="L61">  public PatientStatusComponent(DataHandler dh, State state, String resourceurl) {</span>
<span class="nc" id="L62">    this.datahandler = dh;</span>
<span class="nc" id="L63">    this.resourceUrl = resourceurl;</span>
<span class="nc" id="L64">    this.state = state;</span>

<span class="nc" id="L66">    this.setCaption(&quot;Status&quot;);</span>

<span class="nc" id="L68">    this.initUI();</span>
<span class="nc" id="L69">  }</span>

  private void initUI() {
<span class="nc" id="L72">    status = new VerticalLayout();</span>
<span class="nc" id="L73">    status.setWidth(100.0f, Unit.PERCENTAGE);</span>

<span class="nc" id="L75">    status.setMargin(new MarginInfo(true, false, false, true));</span>
<span class="nc" id="L76">    status.setSpacing(true);</span>

    // status.setSizeFull();

<span class="nc" id="L80">    VerticalLayout projectStatus = new VerticalLayout();</span>
<span class="nc" id="L81">    projectStatus.setMargin(new MarginInfo(true, false, true, true));</span>
<span class="nc" id="L82">    projectStatus.setSpacing(true);</span>

<span class="nc" id="L84">    experiments = new Grid();</span>
<span class="nc" id="L85">    experiments.setReadOnly(true);</span>
<span class="nc" id="L86">    experiments.setWidth(100.0f, Unit.PERCENTAGE);</span>
    // experiments.setHeightMode(HeightMode.ROW);
<span class="nc" id="L88">    status.addComponent(experiments);</span>

<span class="nc" id="L90">    ProgressBar progressBar = new ProgressBar();</span>
<span class="nc" id="L91">    progressBar.setValue(0f);</span>
<span class="nc" id="L92">    status.addComponent(progressBar);</span>
<span class="nc" id="L93">    projectStatus.addComponent(status);</span>

<span class="nc" id="L95">    this.setWidth(Page.getCurrent().getBrowserWindowWidth() * 0.85f, Unit.PIXELS);</span>
<span class="nc" id="L96">    this.setCompositionRoot(projectStatus);</span>
<span class="nc" id="L97">  }</span>

  public void updateUI(final ProjectBean currentBean) {
<span class="nc" id="L100">    BeanItemContainer&lt;ExperimentStatusBean&gt; experimentstatusBeans =</span>
<span class="nc" id="L101">        datahandler.computeIvacPatientStatus(currentBean);</span>

<span class="nc" id="L103">    int finishedExperiments = 0;</span>
<span class="nc" id="L104">    status.removeAllComponents();</span>
<span class="nc" id="L105">    status.setWidth(100.0f, Unit.PERCENTAGE);</span>


    // Generate button caption column
<span class="nc" id="L109">    final GeneratedPropertyContainer gpc = new GeneratedPropertyContainer(experimentstatusBeans);</span>
<span class="nc" id="L110">    gpc.addGeneratedProperty(&quot;started&quot;, new PropertyValueGenerator&lt;String&gt;() {</span>

      @Override
      public Class&lt;String&gt; getType() {
<span class="nc" id="L114">        return String.class;</span>
      }

      @Override
      public String getValue(Item item, Object itemId, Object propertyId) {
<span class="nc" id="L119">        String status = null;</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">        if ((double) item.getItemProperty(&quot;status&quot;).getValue() &gt; 0.0) {</span>
<span class="nc" id="L122">          status =</span>
<span class="nc" id="L123">              &quot;&lt;span class=\&quot;v-icon\&quot; style=\&quot;font-family: &quot; + FontAwesome.CHECK.getFontFamily()</span>
                  + &quot;;color:&quot; + &quot;#2dd085&quot; + &quot;\&quot;&gt;&amp;#x&quot;
<span class="nc" id="L125">                  + Integer.toHexString(FontAwesome.CHECK.getCodepoint()) + &quot;;&lt;/span&gt;&quot;;</span>
        } else {
<span class="nc" id="L127">          status =</span>
<span class="nc" id="L128">              &quot;&lt;span class=\&quot;v-icon\&quot; style=\&quot;font-family: &quot; + FontAwesome.TIMES.getFontFamily()</span>
                  + &quot;;color:&quot; + &quot;#f54993&quot; + &quot;\&quot;&gt;&amp;#x&quot;
<span class="nc" id="L130">                  + Integer.toHexString(FontAwesome.TIMES.getCodepoint()) + &quot;;&lt;/span&gt;&quot;;</span>
        }

<span class="nc" id="L133">        return status.toString();</span>
      }
    });
<span class="nc" id="L136">    gpc.removeContainerProperty(&quot;identifier&quot;);</span>

<span class="nc" id="L138">    experiments.setContainerDataSource(gpc);</span>
    // experiments.setHeaderVisible(false);
    // experiments.setHeightMode(HeightMode.ROW);
<span class="nc" id="L141">    experiments.setHeightByRows(gpc.size());</span>
<span class="nc" id="L142">    experiments.setWidth(Page.getCurrent().getBrowserWindowWidth() * 0.6f, Unit.PIXELS);</span>



<span class="nc" id="L146">    experiments.getColumn(&quot;status&quot;).setRenderer(new ProgressBarRenderer());</span>
    // experiments.setColumnOrder(&quot;started&quot;, &quot;code&quot;, &quot;description&quot;, &quot;status&quot;, &quot;download&quot;,
    // &quot;runWorkflow&quot;);
<span class="nc" id="L149">    experiments.setColumnOrder(&quot;started&quot;, &quot;code&quot;, &quot;description&quot;, &quot;status&quot;, &quot;workflow&quot;);</span>

<span class="nc" id="L151">    experiments.getColumn(&quot;workflow&quot;).setRenderer(new ButtonRenderer(new RendererClickListener() {</span>
      @Override
      public void click(RendererClickEvent event) {
<span class="nc" id="L154">        ExperimentStatusBean esb = (ExperimentStatusBean) event.getItemId();</span>
<span class="nc" id="L155">        TabSheet parent = (TabSheet) getParent();</span>
<span class="nc" id="L156">        PatientView pv = (PatientView) parent.getParent().getParent();</span>
<span class="nc" id="L157">        WorkflowComponent wp = pv.getWorkflowComponent();</span>

        // TODO WATCH OUT NUMBER OF WORKFLOW TAB IS HARDCODED AT THE MOMENT, NO BETTER SOLUTION
        // FOUND SO FAR, e.g. get Tab by Name ?

        // TODO idea get description of item to navigate to the correct workflow ?!
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (esb.getDescription().equals(&quot;Barcode Generation&quot;)) {</span>
<span class="nc" id="L164">          ArrayList&lt;String&gt; message = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L165">          message.add(&quot;clicked&quot;);</span>
<span class="nc" id="L166">          message.add(currentBean.getId());</span>
          //TODO navigate to barcode dragon rawwwr
//          message.add(BarcodeView.navigateToLabel);
//          state.notifyObservers(message);
<span class="nc bnc" id="L170" title="All 2 branches missed.">        } else if (esb.getDescription().equals(&quot;Variant Annotation&quot;)) {</span>
          /*
           * ArrayList&lt;String&gt; message = new ArrayList&lt;String&gt;(); message.add(&quot;clicked&quot;);
           * StringBuilder sb = new StringBuilder(&quot;type=&quot;); sb.append(&quot;workflowExperimentType&quot;);
           * sb.append(&quot;&amp;&quot;); sb.append(&quot;id=&quot;); sb.append(currentBean.getId()); sb.append(&quot;&amp;&quot;);
           * sb.append(&quot;experiment=&quot;); sb.append(&quot;Q_WF_NGS_VARIANT_ANNOTATION&quot;);
           * message.add(sb.toString()); message.add(WorkflowView.navigateToLabel);
           * state.notifyObservers(message);
           */

<span class="nc" id="L180">          Map&lt;String, String&gt; args = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L181">          args.put(&quot;id&quot;, currentBean.getId());</span>
<span class="nc" id="L182">          args.put(&quot;type&quot;, &quot;workflowExperimentType&quot;);</span>
<span class="nc" id="L183">          args.put(&quot;experiment&quot;, &quot;Q_WF_NGS_VARIANT_ANNOTATION&quot;);</span>
<span class="nc" id="L184">          parent.setSelectedTab(8);</span>
<span class="nc" id="L185">          wp.update(args);</span>

<span class="nc bnc" id="L187" title="All 2 branches missed.">        } else if (esb.getDescription().equals(&quot;Epitope Prediction&quot;)) {</span>
          /*
           * ArrayList&lt;String&gt; message = new ArrayList&lt;String&gt;(); message.add(&quot;clicked&quot;);
           * StringBuilder sb = new StringBuilder(&quot;type=&quot;); sb.append(&quot;workflowExperimentType&quot;);
           * sb.append(&quot;&amp;&quot;); sb.append(&quot;id=&quot;); sb.append(currentBean.getId()); sb.append(&quot;&amp;&quot;);
           * sb.append(&quot;experiment=&quot;); sb.append(&quot;Q_WF_NGS_EPITOPE_PREDICTION&quot;);
           * message.add(sb.toString()); message.add(WorkflowView.navigateToLabel);
           * state.notifyObservers(message);
           */
<span class="nc" id="L196">          Map&lt;String, String&gt; args = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L197">          args.put(&quot;id&quot;, currentBean.getId());</span>
<span class="nc" id="L198">          args.put(&quot;type&quot;, &quot;workflowExperimentType&quot;);</span>
<span class="nc" id="L199">          args.put(&quot;experiment&quot;, &quot;Q_WF_NGS_EPITOPE_PREDICTION&quot;);</span>
<span class="nc" id="L200">          parent.setSelectedTab(8);</span>
<span class="nc" id="L201">          wp.update(args);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        } else if (esb.getDescription().equals(&quot;HLA Typing&quot;)) {</span>
          /*
           * ArrayList&lt;String&gt; message = new ArrayList&lt;String&gt;(); message.add(&quot;clicked&quot;);
           * StringBuilder sb = new StringBuilder(&quot;type=&quot;); sb.append(&quot;workflowExperimentType&quot;);
           * sb.append(&quot;&amp;&quot;); sb.append(&quot;id=&quot;); sb.append(currentBean.getId()); sb.append(&quot;&amp;&quot;);
           * sb.append(&quot;experiment=&quot;); sb.append(&quot;Q_WF_NGS_HLATYPING&quot;); message.add(sb.toString());
           * message.add(WorkflowView.navigateToLabel); state.notifyObservers(message);
           */
<span class="nc" id="L210">          Map&lt;String, String&gt; args = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L211">          args.put(&quot;id&quot;, currentBean.getId());</span>
<span class="nc" id="L212">          args.put(&quot;type&quot;, &quot;workflowExperimentType&quot;);</span>
<span class="nc" id="L213">          args.put(&quot;experiment&quot;, &quot;Q_WF_NGS_HLATYPING&quot;);</span>
<span class="nc" id="L214">          parent.setSelectedTab(8);</span>
<span class="nc" id="L215">          wp.update(args);</span>
<span class="nc" id="L216">        }</span>

        else {
<span class="nc" id="L219">          Utils.Notification(&quot;Not available.&quot;, &quot;Workflow not available or no workflow selected.&quot;, &quot;General&quot;);</span>
        }
<span class="nc" id="L221">      }</span>
    }));

<span class="nc" id="L224">    experiments.getColumn(&quot;started&quot;).setRenderer(new HtmlRenderer());</span>

<span class="nc" id="L226">    ProgressBar progressBar = new ProgressBar();</span>
<span class="nc" id="L227">    progressBar.setCaption(&quot;Overall Progress&quot;);</span>
<span class="nc" id="L228">    progressBar.setWidth(Page.getCurrent().getBrowserWindowWidth() * 0.6f, Unit.PIXELS);</span>
<span class="nc" id="L229">    progressBar.setStyleName(&quot;patientprogress&quot;);</span>

<span class="nc" id="L231">    status.addComponent(progressBar);</span>
<span class="nc" id="L232">    status.addComponent(experiments);</span>
<span class="nc" id="L233">    status.setComponentAlignment(progressBar, Alignment.MIDDLE_CENTER);</span>
<span class="nc" id="L234">    status.setComponentAlignment(experiments, Alignment.MIDDLE_CENTER);</span>


    /**
     * Defined Experiments for iVac - Barcodes available -&gt; done with project creation (done) -
     * Sequencing done (Status Q_NGS_MEASUREMENT) - Variants annotated (Status
     * Q_NGS_VARIANT_CALLING) - HLA Typing done (STATUS Q_NGS_WF_HLA_TYPING) - Epitope Prediction
     * done (STATUS Q_WF_NGS_EPITOPE_PREDICTION)
     */


<span class="nc bnc" id="L245" title="All 2 branches missed.">    for (Iterator i = experimentstatusBeans.getItemIds().iterator(); i.hasNext();) {</span>
<span class="nc" id="L246">      ExperimentStatusBean statusBean = (ExperimentStatusBean) i.next();</span>

<span class="nc" id="L248">      finishedExperiments += statusBean.getStatus();</span>

      // statusBean.setDownload(&quot;Download&quot;);
<span class="nc" id="L251">      statusBean.setWorkflow(&quot;Run&quot;);</span>
<span class="nc" id="L252">    }</span>


<span class="nc" id="L255">    progressBar.setValue((float) finishedExperiments / experimentstatusBeans.size());</span>
<span class="nc" id="L256">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>