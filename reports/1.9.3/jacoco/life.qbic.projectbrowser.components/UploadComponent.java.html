<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadComponent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ProjectBrowser Portlet</a> &gt; <a href="index.source.html" class="el_package">life.qbic.projectbrowser.components</a> &gt; <span class="el_source">UploadComponent.java</span></div><h1>UploadComponent.java</h1><pre class="source lang-java linenums">package life.qbic.projectbrowser.components;


import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.io.StringWriter;

import org.apache.commons.io.FilenameUtils;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Notification;
import com.vaadin.ui.ProgressBar;
import com.vaadin.ui.UI;
import com.vaadin.ui.Upload;
import com.vaadin.ui.Upload.FailedEvent;
import com.vaadin.ui.Upload.FinishedEvent;
import com.vaadin.ui.Upload.FinishedListener;
import com.vaadin.ui.Upload.StartedEvent;
import com.vaadin.ui.Upload.StartedListener;
import com.vaadin.ui.Upload.SucceededEvent;
import com.vaadin.ui.VerticalLayout;

public class UploadComponent extends VerticalLayout implements Upload.SucceededListener,
    Upload.FailedListener, Upload.Receiver, Upload.ProgressListener, FinishedListener,
    StartedListener {

  protected Upload upload;
  protected String directory;
  protected String user;
  protected File file;
  protected long maxSize; // In bytes. 100Kb = 100000
  protected ProgressBar progressIndicator; // May be null
<span class="nc" id="L40">  protected boolean cancelled = false;</span>
  protected Long contentLength;
  protected Button cancelProcessing;
  protected HorizontalLayout processingLayout;

<span class="nc" id="L45">  private static final Logger LOG = LogManager.getLogger(UploadComponent.class);</span>
  private boolean success;

  public UploadComponent(String fieldCaption, String buttonCaption, String directoryParam,
<span class="nc" id="L49">      String user, int maxSize) {</span>
<span class="nc" id="L50">    upload = new Upload(fieldCaption, null);</span>
<span class="nc" id="L51">    this.user = user;</span>
<span class="nc" id="L52">    this.addComponent(upload);</span>
<span class="nc" id="L53">    this.maxSize = maxSize;</span>
<span class="nc" id="L54">    upload.setReceiver(this);</span>
<span class="nc" id="L55">    this.directory = directoryParam;</span>
    // this.targetPrefix = targetPrefix;
<span class="nc" id="L57">    upload.setButtonCaption(buttonCaption);</span>
<span class="nc" id="L58">    upload.addSucceededListener(this);</span>
<span class="nc" id="L59">    upload.addFailedListener(this);</span>
<span class="nc" id="L60">    upload.addProgressListener(this);</span>
<span class="nc" id="L61">    upload.addFinishedListener(this);</span>
<span class="nc" id="L62">    upload.addStartedListener(this);</span>

<span class="nc" id="L64">    processingLayout = new HorizontalLayout();</span>
<span class="nc" id="L65">    processingLayout.setSpacing(true);</span>
<span class="nc" id="L66">    processingLayout.setVisible(false);</span>
<span class="nc" id="L67">    this.addComponent(processingLayout);</span>

<span class="nc" id="L69">    progressIndicator = new ProgressBar();</span>
<span class="nc" id="L70">    progressIndicator.setWidth(&quot;100%&quot;);</span>
<span class="nc" id="L71">    processingLayout.addComponent(progressIndicator);</span>

<span class="nc" id="L73">    cancelProcessing = new Button(&quot;cancel&quot;, new Button.ClickListener() {</span>
      @Override
      public void buttonClick(ClickEvent event) {
<span class="nc" id="L76">        cancelled = true;</span>
<span class="nc" id="L77">        upload.interruptUpload();</span>
<span class="nc" id="L78">      }</span>
    });

<span class="nc" id="L81">    cancelProcessing.setStyleName(&quot;small&quot;);</span>
<span class="nc" id="L82">    processingLayout.addComponent(cancelProcessing);</span>
<span class="nc" id="L83">  }</span>

  @Override
  public OutputStream receiveUpload(String filename, String MIMEType) {
<span class="nc" id="L87">    filename = FilenameUtils.getName(filename);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">    if (filename.isEmpty()) {</span>
<span class="nc" id="L89">      upload.interruptUpload();</span>
    }
<span class="nc" id="L91">    FileOutputStream fos = null;</span>
<span class="nc" id="L92">    file = new File(directory, filename);</span>
    try {
<span class="nc" id="L94">      fos = new FileOutputStream(file);</span>
<span class="nc" id="L95">    } catch (final java.io.FileNotFoundException e) {</span>
<span class="nc" id="L96">      throw new RuntimeException(e);</span>
<span class="nc" id="L97">    }</span>
<span class="nc" id="L98">    return fos; // Return the output stream to write to</span>
  }

  public Upload getUploadComponent() {
<span class="nc" id="L102">    return upload;</span>
  }

  @Override
  public void updateProgress(long readBytes, long contentLength) {
<span class="nc" id="L107">    this.contentLength = contentLength;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">    if (maxSize &lt; contentLength) {</span>
<span class="nc" id="L109">      upload.interruptUpload();</span>
<span class="nc" id="L110">      return;</span>
    }

<span class="nc" id="L113">    processingLayout.setVisible(true);</span>
<span class="nc" id="L114">    progressIndicator.setValue(new Float(readBytes / (float) contentLength));</span>
<span class="nc" id="L115">  }</span>

  @Override
  public void uploadFinished(FinishedEvent event) {
<span class="nc" id="L119">    processingLayout.setVisible(false);</span>
<span class="nc" id="L120">  }</span>


  @Override
  public void uploadFailed(FailedEvent event) {
<span class="nc" id="L125">    processingLayout.setVisible(false);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">    if (event.getFilename().isEmpty()) {</span>
<span class="nc" id="L127">      showNotification(&quot;No file selected&quot;, &quot;Please select a file before adding it.&quot;);</span>
<span class="nc" id="L128">      LOG.info(&quot;Upload was cancelled due to no file selected.&quot;);</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">    } else if (contentLength != null &amp;&amp; maxSize &lt; contentLength) {</span>
<span class="nc" id="L130">      showNotification(&quot;File too large&quot;, &quot;Your file is &quot; + contentLength / 1000</span>
          + &quot;Kb long. Maximum file size is &quot; + maxSize / 1000 + &quot;Kb&quot;);
<span class="nc" id="L132">      LOG.info(&quot;Upload was cancelled due to file exceeding size limit.&quot;);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">    } else if (cancelled) {</span>
      // Nothing to do...
    } else {
<span class="nc" id="L136">      StringWriter sw = new StringWriter();</span>
<span class="nc" id="L137">      PrintWriter pw = new PrintWriter(sw);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">      if (event.getReason() != null)</span>
<span class="nc" id="L139">        event.getReason().printStackTrace(pw);</span>
<span class="nc" id="L140">      LOG.error(&quot;Upload cancelled due to error.&quot;);</span>
<span class="nc" id="L141">      showNotification(&quot;There was a problem uploading your file.&quot;, &quot;&quot;);</span>
    }

    try {
<span class="nc" id="L145">      file.delete();</span>
<span class="nc" id="L146">    } catch (Exception e) {</span>
      // Silent exception. If we can't delete the file, it's not big problem. May the file did not
      // even exist.
<span class="nc" id="L149">    }</span>
<span class="nc" id="L150">  }</span>

  /**
   * File upload is a special case because the Nav7 is not initialized, because the file upload
   * requests don't go through the Vaadin servlet.
   */
  protected void showNotification(String message, String detail) {
<span class="nc" id="L157">    Notification n = new Notification(message, detail);</span>
<span class="nc" id="L158">    n.setDelayMsec(-1);</span>
<span class="nc" id="L159">    n.show(UI.getCurrent().getPage());</span>
<span class="nc" id="L160">  }</span>

  public String getDirectory() {
<span class="nc" id="L163">    return directory;</span>
  }

  public File getFile() {
<span class="nc" id="L167">    return file;</span>
  }

  @Override
  public void uploadSucceeded(SucceededEvent event) {
<span class="nc" id="L172">    success = true;</span>
<span class="nc" id="L173">  }</span>

  public void addFinishedListener(FinishedListener listener) {
<span class="nc" id="L176">    upload.addFinishedListener(listener);</span>
<span class="nc" id="L177">  }</span>

  public boolean wasSuccess() {
<span class="nc" id="L180">    return success;</span>
  }

  @Override
  public void uploadStarted(StartedEvent event) {
<span class="nc" id="L185">    success = false;</span>
<span class="nc" id="L186">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>